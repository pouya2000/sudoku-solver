h = '<script type="text/javascript">top.location = "http://www.sudoku9x9.com"</script>';<!-- ';
var pzsolved=false;
var pzvalid=true;
var guessmode=0;
var guessinfo=new Array();
var curguess="";
var curdid=0;
var clrcount=0;
var possmode=false;
var wrapstrbegin="<span class='wrapchr'>";
var wrapend="</span>";
var stepstrbegin='<h5>Step ';
var stepstrend=':</h5>';
var fhstr="<h3>Finished!</h3>";
var needconfirm=0;
var step=0;
var dispstep=0;
var curstep=0;
var bstepno=-1;
var xtrastep=false;
var msgoffset=new Array();
var solvedsqn=new Array();
var upmsgwrap='<p class="udfont">';
var upmsgcntxt='Grid updated for this step';
var upmsg=upmsgwrap+upmsgcntxt+'</p>';
var restartmsg='<div class="rstrtcls">Start Over Again</div>'
var t_a=new Array(9),t_itemp=new Array(9),t_poscell=new Array(9),t_krowcell=new Array(9),t_kcolcell=new Array(9),t_ksqrcell=new Array(9);
var rowfill=new Array(9),colfill=new Array(9),sqrfill=new Array(9),kfill=new Array(9);
var fullsum=new Array("","","","","","","","","","","","","","","","","","","","");
var stepsum=new Array(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);
var shwsum=-1;
var sumwait=false;
var nextready=true;
  for(i=0;i<=8;i++) 
  {
   t_a[i]=new Array(9);
   t_itemp[i]=new Array(9);
   t_poscell[i]=new Array(9);
   t_krowcell[i]=new Array(9);
   t_kcolcell[i]=new Array(9);
   t_ksqrcell[i]=new Array(9);
   for(j=0;j<=8;j++)
   {
    t_a[i][j]=new Array(9);
   }
  }

function sqrc2r(square,srow)
{
 var row;
 row=Math.floor(square/3)*3+srow;
 return row;
}

function sqrc2c(square,scol)
{
 var col;
 col=(square%3)*3+scol;
 return col;
}

function tgotacell(a,iref,jref,kref,poscell,krowcell,kcolcell,ksqrcell)
{
  var n,ii,jj,nrow,ncol,nsquare,rmks=false;
  a[iref][jref][kref]=2;
  for(n=0;n<=8;n++)
  {
   if (n!=iref && a[n][jref][kref]==1) 
   {
    rmapos(a,n,jref,kref,poscell,krowcell,kcolcell,ksqrcell);
	rmks=true;
   }	
   if (n!=jref && a[iref][n][kref]==1) 
   {
    rmapos(a,iref,n,kref,poscell,krowcell,kcolcell,ksqrcell);
	rmks=true;
   }	
   if (n!=kref && a[iref][jref][n]==1) rmapos(a,iref,jref,n,poscell,krowcell,kcolcell,ksqrcell);
  }
  nsquare=rc2sqr(iref,jref); 
  for(ii=0;ii<=2;ii++)
  {
   for(jj=0;jj<=2;jj++)
   {
    nrow=sqrc2r(nsquare,ii);
    ncol=sqrc2c(nsquare,jj);
    if ((nrow!=iref || ncol!=jref) && a[nrow][ncol][kref]==1) 
	{
	 rmapos(a,nrow,ncol,kref,poscell,krowcell,kcolcell,ksqrcell);
	 rmks=true;
	} 
   }
  }
  return rmks;
}

function rmapos(a,iref,jref,kref,poscell,krowcell,kcolcell,ksqrcell)
{
  if (a[iref][jref][kref]==1)
  {
   a[iref][jref][kref]=0;
   poscell[iref][jref]--;
   krowcell[iref][kref]--;
   kcolcell[jref][kref]--;
   nsquare=rc2sqr(iref,jref); 
   ksqrcell[nsquare][kref]--;
  } 
}  

function clrgrid()
{
 for(var i=0;i<81;i++)
 {
  document.getElementById('c'+i).className=ncls;
  document.getElementById('oc'+i).className=oncls;
  if(orig[i]==0) 
  {
   document.getElementById('c'+i).innerHTML="";
   document.getElementById('c'+i).style.color="";
   document.getElementById('cell'+i).style.backgroundColor="";
  } 
 } 
}

function resetbtn(eltid)
{
 if (document.getElementById(eltid)) document.getElementById(eltid).style.color="#969696";
}

function rc2sqr(row,col)
{
 var nsquare;
 nsquare=Math.floor(row/3)*3+Math.floor(col/3);
 return nsquare;
}

function scrolldw(stepno)
{
 var otmpmsg=document.getElementById('tmpmsg')
 otmpmsg.style.minHeight=(otmpmsg.clientHeight+(stepno%2)*5)+"px";
 var th=document.getElementById('msgbrd').scrollHeight;
 var curscrolltop=document.getElementById('msgbrd').scrollTop;
 var stepnoht;
 if (stepno<step) stepnoht=msgoffset[stepno]-msgoffset[stepno-1];
 else if (stepno==step) stepnoht=th-msgoffset[stepno-1];
 if (stepnoht<380)
 {
  if (curscrolltop>msgoffset[stepno-1]) document.getElementById('msgbrd').scrollTop=msgoffset[stepno-1]-15+(stepno%2)*5;
  else if ((curscrolltop+400)<(msgoffset[stepno-1]+stepnoht)) document.getElementById('msgbrd').scrollTop=msgoffset[stepno-1]-15+(stepno%2)*5;
 }
 else document.getElementById('msgbrd').scrollTop=msgoffset[stepno-1]-15+(stepno%2)*5; 
 hlpar(stepno);
}

function scrollup(stepno)
{
 if (stepno<=0) document.getElementById('msgbrd').scrollTop=0;
 else
 {
  var otmpmsg=document.getElementById('tmpmsg')
  otmpmsg.style.minHeight=(otmpmsg.clientHeight+(stepno%2)*5)+"px";;
  var th=document.getElementById('msgbrd').scrollHeight;
  var ht1=getmsght('msgbrd1');
  var ht2=getmsght('msgbrd2'); 
  var curscrolltop=document.getElementById('msgbrd').scrollTop;
  var stepnoht;
  if (stepno<step) stepnoht=msgoffset[stepno]-msgoffset[stepno-1];
  else if (stepno==step) stepnoht=th-msgoffset[stepno-1];
  if (stepno==step) document.getElementById('msgbrd').scrollTop=th-400;
  else if (stepnoht<380)
  {
   if (curscrolltop>msgoffset[stepno-1]) document.getElementById('msgbrd').scrollTop=msgoffset[stepno]-385+(stepno%2)*5;
   else if ((curscrolltop+400)<(msgoffset[stepno-1]+stepnoht)) document.getElementById('msgbrd').scrollTop=msgoffset[stepno]-385+(stepno%2)*5;
  }
  else document.getElementById('msgbrd').scrollTop=msgoffset[stepno-1]-15+(stepno%2)*5;
 } 
 hlpar(stepno); 
}

function moveup()
{
 var curpos=document.getElementById('msgbrd').scrollTop;
 document.getElementById('msgbrd').scrollTop=Math.max(curpos-350,0);
}

function movedown()
{
 var curpos=document.getElementById('msgbrd').scrollTop;
 var sclimit=document.getElementById('msgbrd').scrollHeight-400;
 document.getElementById('msgbrd').scrollTop=Math.min(curpos+350,sclimit);
}

function hlpar(stepno)
{
 if (stepno>=0)
 {
  var posstrt=-1, omsgbrd1=document.getElementById('msgbrd1'), omsgbrd2=document.getElementById('msgbrd2');
  var dummsg=omsgbrd1.innerHTML;
  if (stepno>0) dummsg=dummsg.replace(restartmsg,"");
  else if (dummsg.indexOf(restartmsg)<0) dummsg=restartmsg+dummsg;
  dummsg=dummsg.replace("stepblock","dumcls"); 
  posstrt=dummsg.indexOf(stepstrbegin+stepno+":");
  if (posstrt<0 && pzsolved && stepno==step) posstrt=dummsg.indexOf(fhstr);
  if (posstrt>=0) 
  {
   posstrt=Math.max(0,posstrt-25);
   var lstr=dummsg.substr(0,posstrt);
   var mstr=dummsg.substr(posstrt,30).replace("dumcls","stepblock"); 
   var rstr=dummsg.substr(posstrt+30);
   dummsg=lstr+mstr+rstr;
  } 
  omsgbrd1.innerHTML=dummsg;
 }
} 

function getmsght(eltid)
{
 var ht=document.getElementById(eltid).clientHeight;
 return ht;
}

function msght2()
{
 var tmpht=document.getElementById('tmpmsg').clientHeight+25;
 var ht2=document.getElementById('msgbrd2').clientHeight+Math.max(document.getElementById('chain1').clientHeight,document.getElementById('chain2').clientHeight)+tmpht;
 return ht2;
}

function combine2()
{
 var omsgbrd=document.getElementById('msgbrd');
 var omsgbrd1=document.getElementById('msgbrd1');
 var omsgbrd2=document.getElementById('msgbrd2');
 var ochain1=document.getElementById('chain1');
 var ochain2=document.getElementById('chain2');
 var dcf="";
 if (omsgbrd && omsgbrd1 && omsgbrd2 && ochain1 && ochain2) 
 {
  var dummsg=omsgbrd2.innerHTML;
  omsgbrd2.innerHTML="";
  var pos=dummsg.indexOf(upmsgcntxt);
  if (pos>0) dummsg=dummsg.substr(0,pos-upmsgwrap.length)+dummsg.substr(pos-upmsgwrap.length+upmsg.length);
  if (dummsg!="")
  {
   dummsg='<div class="dumcls'+(step%2)+'">'+dummsg;
   if (ochain1.innerHTML!="")
   {
    dummsg+='<div class="dpchain1">'+ochain1.innerHTML+'</div>';
    ochain1.innerHTML="";
    dcf='<div class="clearfloat"></div>';
   }
   if (ochain2.innerHTML!="")
   {
    dummsg+='<div class="dpchain2">'+ochain2.innerHTML+'</div>';
    ochain2.innerHTML="";
    dcf='<div class="clearfloat"></div>';
   }
   dummsg+=dcf+'</div>';
   omsgbrd1.innerHTML+=dummsg;
  } 
 } 
}

function addstep(psolved,method,cellinfo)
{
 var omsgbrd=document.getElementById('msgbrd');
 var omsgbrd1=document.getElementById('msgbrd1');
 var omsgbrd2=document.getElementById('msgbrd2');
 var ochain1=document.getElementById('chain1');
 var ochain2=document.getElementById('chain2');
 var otmpmsg=document.getElementById('tmpmsg');
 var osumbrd=document.getElementById('sumbrd');
 if (omsgbrd && omsgbrd1 && omsgbrd2 && ochain1 && ochain2 && otmpmsg) 
 {
  var dummsg=omsgbrd1.innerHTML;
  dummsg=dummsg.replace("currently demonstrated","back to this step");
  omsgbrd1.innerHTML=dummsg;
  solvedsqn[step]=method+":"+cellinfo;
  step++;
  dispstep=step;
  curstep=step;
  msgoffset[step-1]=getmsght('msgbrd1'); 
  if (!psolved)
  {
   dummsg=stepstrbegin+step+stepstrend+'<a class="gostep" href="javascript:back2this('+(step-1)+')">(currently demonstrated)</a>';
   omsgbrd2.innerHTML=dummsg;
   switch (method)
   {
     case "ns":
	   fullsum[0]+='<a href="javascript:back2this('+(step-1)+')">'+step+'</a> ';
	   stepsum[0]++;
	   break;
     case "hss":
     case "hsr":
     case "hsc":
	   fullsum[1]+='<a href="javascript:back2this('+(step-1)+')">'+step+'</a> ';
	   stepsum[1]++;
	   break;
     case "lcsr":
     case "lcsc":
     case "lcrs":
     case "lccs":
	   fullsum[2]+='<a href="javascript:back2this('+(step-1)+')">'+step+'</a> ';
	   if ('123'.indexOf(cellinfo.substr(6,1))>=0) fullsum[1]+='<a href="javascript:back2this('+(step-1)+')">'+step+'</a> ';
	   else if (cellinfo.substr(6,1)=="4") fullsum[0]+='<a href="javascript:back2this('+(step-1)+')">'+step+'</a> ';
	   stepsum[2]++;
	   break;
     case "ndblr":
     case "ndblc":
     case "ndbls":
	   fullsum[3]+='<a href="javascript:back2this('+(step-1)+')">'+step+'</a> ';
	   stepsum[3]++;
  	   break;
     case "hdblr":
     case "hdblc":
     case "hdbls":
	   fullsum[4]+='<a href="javascript:back2this('+(step-1)+')">'+step+'</a> ';
	   stepsum[4]++;
	   break;
     case "ntplr":
     case "ntplc":
     case "ntpls":
	   fullsum[5]+='<a href="javascript:back2this('+(step-1)+')">'+step+'</a> ';
	   stepsum[5]++;
       break;
     case "htplr":
     case "htplc":
     case "htpls":
	   fullsum[6]+='<a href="javascript:back2this('+(step-1)+')">'+step+'</a> ';
	   stepsum[6]++;
	   break;
     case "nquadr":
     case "nquadc":
     case "nquads":
	   fullsum[7]+='<a href="javascript:back2this('+(step-1)+')">'+step+'</a> ';
	   stepsum[7]++;
       break;
     case "hquadr":
     case "hquadc":
     case "hquads":
	   fullsum[8]+='<a href="javascript:back2this('+(step-1)+')">'+step+'</a> ';
	   stepsum[8]++;
	   break;
     case "xwr":
     case "xwc":
	   fullsum[9]+='<a href="javascript:back2this('+(step-1)+')">'+step+'</a> ';
	   stepsum[9]++;
	   break;
     case "sfr":
     case "sfc":
	   fullsum[10]+='<a href="javascript:back2this('+(step-1)+')">'+step+'</a> ';
	   stepsum[10]++;
	   break;
     case "xywt":
     case "xywr":
     case "xywc":
	   fullsum[11]+='<a href="javascript:back2this('+(step-1)+')">'+step+'</a> ';
	   stepsum[11]++;
	   break;
     case "xyzwr":
     case "xyzwc":
	   fullsum[12]+='<a href="javascript:back2this('+(step-1)+')">'+step+'</a> ';
	   stepsum[12]++;
  	   break;
     case "clr":
	   fullsum[13]+='<a href="javascript:back2this('+(step-1)+')">'+step+'</a> ';
	   stepsum[13]++;
	   break;
     case "frc":
	   fullsum[14]+='<a href="javascript:back2this('+(step-1)+')">'+step+'</a> ';
	   stepsum[14]++;
	   break;
     case "nishio":
	   fullsum[15]+='<a href="javascript:back2this('+(step-1)+')">'+step+'</a> ';
	   stepsum[15]++;
	   break;
     case "poss":
     case "possall":
	   fullsum[16]+='<a href="javascript:back2this('+(step-1)+')">'+step+'</a> ';
	   stepsum[16]++;
	   break;
     case "guess":
	   fullsum[17]+='<a href="javascript:back2this('+(step-1)+')">'+step+'</a> ';
	   stepsum[17]++;
	   break;   
     case "gfail":
	   fullsum[18]+='<a href="javascript:back2this('+(step-1)+')">'+step+'</a> ';
	   stepsum[18]++;
 	   break;   
     case "gconf":
	   fullsum[19]+='<a href="javascript:back2this('+(step-1)+')">'+step+'</a> ';
	   stepsum[19]++;
	   break;   
   }
  }
  else
  {
   omsgbrd2.innerHTML=fhstr;
   document.getElementById("swsum").style.color="";
  }
 }
}

function dpsummary()
{
 if (pzsolved && !sumwait)
 {
  sumwait=true;
  if (shwsum<0)
  {  
   var methodarr=new Array("Naked Single","Hidden Single","Locked Candidate","Naked Double","Hidden Double","Naked Triplet","Hidden Triplet","Naked Quad","Hidden Quad","X-Wing","Swordfish","XY-Wing","XYZ-Wing","Coloring","Forcing Chain","Nisho","Fill in Possibilities","Guess","Guess Failed","Guess Confirmed");
   var dummsg="", methodno=0;
   for (var i=0;i<20;i++)
   {
    if (stepsum[i]>0) methodno++;
   }
   if (methodno<=2)
   {
    var osumbrd=document.getElementById('sumbrd');
    for (i=0;i<20;i++)
    {
     if (stepsum[i]>0) dummsg+="<div class='sumitem'><h5>"+methodarr[i]+":</h5>"+fullsum[i]+"</div>";  
    }
    osumbrd.innerHTML=dummsg;
   }
   else
   {
    var osumbrdl=document.getElementById('sumbrdl'), osumbrdr=document.getElementById('sumbrdr');
    for (i=0;i<20;i++)
    {
     if (stepsum[i]>0) 
	 {
	  if (getmsght('sumbrdl')>getmsght('sumbrdr') || (i==0 && stepsum[0]<stepsum[1]))  osumbrdr.innerHTML+="<div class='sumitem'><h5>"+methodarr[i]+":</h5>"+fullsum[i]+"</div>";
	  else osumbrdl.innerHTML+="<div class='sumitem'><h5>"+methodarr[i]+":</h5>"+fullsum[i]+"</div>";
	 }
    }
   }
  }
  if (shwsum<=0)
  {  
   document.getElementById("swsum").style.backgroundColor="#5689ff";
   document.getElementById("swsum").style.color="#ffffff";
   shwsum=1;
   var totht=Math.max(getmsght('lup'),getmsght('rup'))+getmsght('sumbrdo')+5;
   for (i=1;i<=totht;i++)
   {
    setTimeout("document.getElementById('sumwrap').style.height='"+i+"px'",i*10);
   }
  }
  else
  {
   document.getElementById("swsum").style.backgroundColor="";
   document.getElementById("swsum").style.color="";
   shwsum=0;
   var totht=getmsght('sumwrap');
   for (i=totht;i>=0;i--)
   {
    setTimeout("document.getElementById('sumwrap').style.height='"+i+"px'",(totht-i)*10);
   }  
  } 
  setTimeout("sumwait=false",totht*10);
 } 
}

function testfn()
{
 document.getElementById('wmsg').innerHTML='abc';
}

function addmsg(msg)
{
 var omsgbrd=document.getElementById('msgbrd');
 var omsgbrd2=document.getElementById('msgbrd2');
 if (omsgbrd && omsgbrd2) 
 {
  var dummsg=omsgbrd2.innerHTML;
  if (msg.indexOf(">")<0) dummsg+='<p>'+msg+'</p>';
  else dummsg+=msg;
  omsgbrd2.innerHTML=dummsg;
 }
}

function addmsgr(msg)
{
 var omsgbrd=document.getElementById('msgbrd');
 var omsgbrd2=document.getElementById('msgbrd2');
 if (omsgbrd && omsgbrd2) 
 {
  var dummsg=omsgbrd2.innerHTML;
  dummsg+='<p class="ralign">'+msg+'</p>';
  omsgbrd2.innerHTML=dummsg;
 }
}

function c1step(msg)
{
 var omsgbrd=document.getElementById('msgbrd');
 var omsgbrd2=document.getElementById('msgbrd2');
 var ochain1=document.getElementById('chain1');
 if (omsgbrd && omsgbrd2 && ochain1) 
 {
  ochain1.innerHTML+='<p>'+msg+'</p>';
 }
}

function c1stepr(msg)
{
 var omsgbrd=document.getElementById('msgbrd');
 var omsgbrd2=document.getElementById('msgbrd2');
 var ochain1=document.getElementById('chain1');
 if (omsgbrd && omsgbrd2 && ochain1) 
 {
  ochain1.innerHTML+='<p>&nbsp;'+msg+'</p>';
 }
}

function c2step(msg)
{
 var omsgbrd=document.getElementById('msgbrd');
 var omsgbrd2=document.getElementById('msgbrd2');
 var ochain1=document.getElementById('chain1');
 var ochain2=document.getElementById('chain2');
 if (omsgbrd && omsgbrd2 && ochain1) 
 {
  ochain2.innerHTML+='<p>'+msg+'</p>';
 }
}

function c2stepr(msg)
{
 var omsgbrd=document.getElementById('msgbrd');
 var omsgbrd2=document.getElementById('msgbrd2');
 var ochain1=document.getElementById('chain1');
 var ochain2=document.getElementById('chain2');
 if (omsgbrd && omsgbrd2 && ochain1) 
 {
  ochain2.innerHTML+='<p>&nbsp;'+msg+'</p>';
 }
}

function addtmpmsg(msg)
{
 var omsgbrd=document.getElementById('msgbrd');
 var otmpmsg=document.getElementById('tmpmsg');
 var oa1cell=document.getElementById('a1cell');
 if (omsgbrd && otmpmsg) 
 {
  if (msg.indexOf(">")<0) otmpmsg.innerHTML+='<p>'+msg+'</p>';
  else otmpmsg.innerHTML+=msg;
 }
}

function next2cont()
{
 addtmpmsg('Press "Next" to continue ...');
}

function next2update()
{
 addtmpmsg('Press "Next" to update the grid for the changes.');
}

function qsolved()
{
 var done=true, i;
 for (i=0;i<81;i++)
 {
  if (document.getElementById('c'+i).className==smcls || document.getElementById('c'+i).innerHTML.length!=1)
  {
   done=false;
   break;
  }
 }
 return done;
}

function nsolvedorerr(a,poscell,krowcell,kcolcell,ksqrcell)
{
 var found="1",index1,index2,index3;
 // found variable:  =0: not solved, =1: solved, =2: invalid (no candidates in a cell) =3: invalid (missing a digit in a row)
 // =4: invalid (missing a digit in a column)   =5:  invalid (missing a digit in a square) 
 // =6: invalid (a digit confirmed in more than 1 cell within a row)
 // =7: invalid (a digit confirmed in more than 1 cell within a column)
 // =8: invalid (a digit confirmed in more than 1 cell within a square
 var chkrow=new Array(9),chkcol=new Array(9),chksqr=new Array(9);
 var i,j,k,isqr;
 for(i=0;i<=8;i++)
 {
  chkrow[i]=new Array(9);
  chkcol[i]=new Array(9);
  chksqr[i]=new Array(9);
 } 
 for(index1=0;index1<=8;index1++)
 {
  for(index2=0;index2<=8;index2++) 
  {
   chkrow[index1][index2]=0;
   chkcol[index1][index2]=0;
   chksqr[index1][index2]=0;   
   if (poscell[index1][index2]==0) found="2:"+index1+","+index2;	
   else if (krowcell[index1][index2]==0) found="3:"+index1+","+index2;
   else if (kcolcell[index1][index2]==0) found="4:"+index1+","+index2;
   else if (ksqrcell[index1][index2]==0) found="5:"+index1+","+index2;
   if (found.length>1) break;
   if(poscell[index1][index2]>1 || krowcell[index1][index2]>1 || kcolcell[index1][index2]>1 || ksqrcell[index1][index2]>1) found="0";
  }
  if (found.length>1) break;  
 }
 if (found=="0")
 {
  for(i=0;i<=8;i++)
  {
   for(j=0;j<=8;j++)
   {
    for(k=0;k<=8;k++)
	{
     if(a[i][j][k]==2)
     {
      isqr=rc2sqr(i,j);
      chkrow[i][k]++;
      chkcol[j][k]++;
      chksqr[isqr][k]++;
	  if (chkrow[i][k]>1) found="6:"+i+","+k;
	  else if (chkcol[j][k]>1) found="7:"+j+","+k;
	  else if (chksqr[isqr][k]>1) found="8:"+isqr+","+k;
	  if (found.length>1) break;
	 } 
    }
    if (found.length>1) break;	
   }
   if (found.length>1) break;
  }
 } 
 return found;
}

function showrc_t(id,rtype)  // rtype: 1 = row; 2 = col; 3 = square; 4 = row, col and square  
{
 var row=Math.floor(id/9), col=id%9, sqr=rc2sqr(row,col), i;
 for (i=0;i<81;i++)
 {
  if (((rtype==1 || rtype==4) && Math.floor(i/9)==row) || ((rtype==2 || rtype==4) && (i%9)==col) || ((rtype==3 || rtype==4) && rc2sqr(Math.floor(i/9),i%9)==sqr)) setclr_t(i);
 }
 if ((rtype==3 || rtype==4) && document.getElementById("sgrid"+sqr).className!="subgrido") document.getElementById("sgrid"+sqr).className="subgrido";
}

function setclr_t(id)
{
 var dumclr=colorToHex(document.getElementById("cell"+id).style.backgroundColor);
 if (dumclr==yellow) document.getElementById("cell"+id).style.backgroundColor=hyellow;
 else if (dumclr!=hnobgclr) document.getElementById("cell"+id).style.backgroundColor=hnobgclr;
}

function resetbgclr_t(id)
{
 var dumclr=colorToHex(document.getElementById("cell"+id).style.backgroundColor);
 if (dumclr!="") document.getElementById("cell"+id).style.backgroundColor="";
}

function resetrcclr_t()
{
 var i;
 for (i=0;i<81;i++)
 {
  if (document.getElementById("cell"+i).style.backgroundColor!="") document.getElementById("cell"+i).style.backgroundColor=""
  if (document.getElementById("c"+i).style.color!="") document.getElementById("c"+i).style.color="";
  if (document.getElementById("c"+i).style.fontWeight!="") document.getElementById("c"+i).style.fontWeight="";
  if (document.getElementById("oc"+i).style.color!="") document.getElementById("oc"+i).style.color="";
  if (document.getElementById("oc"+i).style.borderColor!="") document.getElementById("oc"+i).style.borderColor="";
  if (document.getElementById("oc"+i).innerHTML!="") document.getElementById("oc"+i).innerHTML="";
  if (!possmode && document.getElementById("c"+i).className==smcls)
  {
   document.getElementById("c"+i).className=ncls;
   document.getElementById("c"+i).innerHTML="";
   t_itemp[Math.floor(i/9)][i%9]=0;
  }
  if (i<9 && document.getElementById("sgrid"+i).className=="subgrido") document.getElementById("sgrid"+i).className="subgrid";
 }
 if (curguess!="" && !(pzsolved && dispstep==step)) ghl();
 if (document.getElementById("tmpmsg").innerHTML!="") document.getElementById("tmpmsg").innerHTML="";
 if (document.getElementById('tmpmsg').style.minHeight!="") document.getElementById('tmpmsg').style.minHeight="";
}

function colorToHex(c) 
{
 var m = /rgba?\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)/.exec(c);
 return m ? '#' + (1 << 24 | m[1] << 16 | m[2] << 8 | m[3]).toString(16).substr(1) : c;
}

function basic()
{
 var i,j,k,idx,isqr;
 clrcount=0;
 possmode=false;
 needconfirm=0;
 xtrastep=false;
 curguess="";
 for(i=0;i<=8;i++)
 {
  rowfill[i]=0;
  colfill[i]=0;
  sqrfill[i]=0;
  kfill[i]=0;
 } 
 for(i=0;i<=8;i++)
 {
  for(j=0;j<=8;j++)
  {
   idx=9*i+j;
   isqr=rc2sqr(i,j);
   if (orig[idx]!=0)
   {
    t_itemp[i][j]=1*document.getElementById('c'+idx).innerHTML;
	rowfill[i]++;
	colfill[j]++;
	sqrfill[isqr]++;
	kfill[t_itemp[i][j]]++;
   }
   else
   {
    t_itemp[i][j]=0;
   } 
  }
 }

 for (i=0;i<=8;i++)
 {
  for (j=0;j<=8;j++) 
  {
   t_poscell[i][j]=9;
   t_krowcell[i][j]=9;
   t_kcolcell[i][j]=9;
   t_ksqrcell[i][j]=9;
   for (k=0;k<=8;k++) 
   {
    if(t_itemp[i][j]==k+1) 
    {
     t_a[i][j][k]=2;
    }
    else
    {
     t_a[i][j][k]=1;
    } 
   }
  }
 }
 
 for (i=0;i<=8;i++)
 {
  for (j=0;j<=8;j++) 
  {
   for (k=0;k<=8;k++) 
   {
    if (t_a[i][j][k]==2) tgotacell(t_a,i,j,k,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
   }
  }
 }
}

function npgot1cell(i,j,k)
{
 var idx=i*9+j, isqr=rc2sqr(i,j);
 document.getElementById('c'+idx).innerHTML=k+1;
 document.getElementById('c'+idx).className=ncls;
 tgotacell(t_a,i,j,k,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
 t_itemp[i][j]=k+1;
 rowfill[i]++;
 colfill[j]++;
 sqrfill[isqr]++;
 kfill[k]++; 
}

function findrelatedrow(row,col,idx,did)
{
 var ifound=false, nidx=row*9+col, j, nidx2;
 for (j=0;j<9;j++)
 {
  nidx2=row*9+j;
  if (j!=col && nidx2!=idx && document.getElementById('c'+nidx2).innerHTML==(did+1))
  {
   ifound=true;
   if (document.getElementById('c'+nidx2).style.color=="" && document.getElementById('c'+nidx2).className!=smcls)
   {    
    document.getElementById('c'+nidx2).style.color=setcolor[clrcount%8];
    document.getElementById('oc'+nidx2).style.borderColor=setcolor[clrcount%8];
    clrcount++;
   }
   document.getElementById('oc'+nidx).style.color=document.getElementById('c'+nidx2).style.color;
   document.getElementById('oc'+nidx).innerHTML="--";
   break;
  }
 }
 return ifound;
}

function findrelatedcol(row,col,idx,did)
{
 var ifound=false, nidx=row*9+col, i, nidx2;
 for (i=0;i<9;i++)
 {
  nidx2=i*9+col;
  if (i!=row && nidx2!=idx && document.getElementById('c'+nidx2).innerHTML==(did+1))
  {
   ifound=true;
   if (document.getElementById('c'+nidx2).style.color=="")
   {
    document.getElementById('c'+nidx2).style.color=setcolor[clrcount%8];
    document.getElementById('oc'+nidx2).style.borderColor=setcolor[clrcount%8];
    clrcount++;
   }
   document.getElementById('oc'+nidx).style.color=document.getElementById('c'+nidx2).style.color;
   document.getElementById('oc'+nidx).innerHTML="|";
   break;
  }
 }
 return ifound;
}

function findrelatedsqr(row,col,idx,did)
{
 var ifound=false, nidx=row*9+col, nsqr=rc2sqr(row,col), sqr=rc2sqr(Math.floor(idx/9),idx%9), nidx2, ii, jj, newi, newj;
 for (ii=0;ii<=2;ii++)
 {
  for (jj=0;jj<=2;jj++)
  {
   newi=sqrc2r(nsqr,ii);
   newj=sqrc2c(nsqr,jj);
   nidx2=newi*9+newj;
   if ((newi!=row || newj!=col) && nidx2!=idx && document.getElementById('c'+nidx2).innerHTML==(did+1))
   {
    ifound=true;
    if (document.getElementById('c'+nidx2).style.color=="")
    {
     document.getElementById('c'+nidx2).style.color=setcolor[clrcount%8];
     document.getElementById('oc'+nidx2).style.borderColor=setcolor[clrcount%8];
     clrcount++;
    }
    document.getElementById('oc'+nidx).style.color=document.getElementById('c'+nidx2).style.color;
    document.getElementById('oc'+nidx).innerHTML="X";
    break;
   }	
  }
  if (ifound) break;
 }
 return ifound;
}

function needfill(fillorder)
{
 if (dispstep==step) combine2();
 resetrcclr_t();
 switch (fillorder)
 {
  case 1:
	addtmpmsg('Need to enter possibilities in empty cells.');
	xtrastep=true;
	break;
  case 2:
    fillpos(1);
	break;
  case 3:
    fillpos(80);
    break;	
  default:
    fillpos(1);
    break;
 }
 needconfirm=0;
 if (xtrastep)
 {
  addtmpmsg('Press "Next" button to fill in all empty cells, or press the button below to fill one empty cell at a time.');
  addtmpmsg('<div id="a1cell" class="igen5" onclick="needfill(2);">Fill next empty cell</div>');
 }
 else if (fillorder!=3)
 {
  addtmpmsg('No more empty cells. Press "Next" button to continue.');
 }
 else next2cont();
 scrolldw(dispstep);
}

function confirm()
{ 
 resetrcclr_t();
 fillpos(80);
 if (curguess!="" && !(pzsolved && dispstep==step)) ghl();
 needconfirm=0;
}

function hlnumber(idx,val)
{
 var dumstr="",intxt=document.getElementById('c'+idx).innerHTML;
 if (intxt.length>0)
 {
  for (var i=0;i<intxt.length;i++)
  {
   if (val.indexOf(intxt.substr(i,1))<0) dumstr+=intxt.substr(i,1);
   else dumstr+=wrapstrbegin+intxt.substr(i,1)+wrapend;
  }
 }
 document.getElementById('c'+idx).innerHTML=dumstr;
}

function dcell(i,j)
{
 return "(R"+(i+1)+",&nbsp;C"+(j+1)+")";
}

function drow(i)
{
 return "R"+(i+1);
}

function dcol(j)
{
 return "C"+(j+1);
}

function dsqr(i)
{
 return "S"+(i+1);
}

function ddig(i)
{
 return ""+(i+1);
}
function hlcell(idx,incolor)
{
 document.getElementById('cell'+idx).style.backgroundColor=incolor;
}
function rowfirst(row,col)
{
 var rempty=0, cempty=0, newrowidx, newcolidx;
 for (var i=0;i<3;i++)
 {
  newrowidx=(Math.floor(row/3)*3+i)*9+col;
  newcolidx=row*9+Math.floor(col/3)*3+i;
  if (document.getElementById('c'+newrowidx).innerHTML.length!=1 || document.getElementById('c'+newrowidx).className==smcls) cempty++;
  if (document.getElementById('c'+newcolidx).innerHTML.length!=1 || document.getElementById('c'+newcolidx).className==smcls) rempty++;
 }
 if (rempty>=cempty) return true;
 else return false;
}

function hssqr(did,a,poscell,krowcell,kcolcell,ksqrcell,fromlcd) 
{
  var index1,i,j,ii,jj,idx,isqr,newi,newj,nidx,ifindrelated,idone=false;
  if (curstep<step)
  {
   var cellinfo;
   if (fromlcd) cellinfo=solvedsqn[curstep].substr(solvedsqn[curstep].indexOf(">")+1);	
   else cellinfo=solvedsqn[curstep].substr(solvedsqn[curstep].indexOf(":")+1);	
   var cfi=cellinfo.substr(0,1)*1, cfj=cellinfo.substr(2,1)*1, did=cellinfo.substr(4,1)*1;
  }
  if (curstep<dispstep)
  {
   npgot1cell(cfi,cfj,did);
   if (possmode) needconfirm=1;
   idone=true;
  }
  else
  {  
   for(index1=0;index1<=8;index1++)
   {
    if (curstep<step) index1=rc2sqr(cfi,cfj); 
	if(ksqrcell[index1][did]==1)
	{
	 for(ii=0;ii<=2;ii++)
	 {
      for(jj=0;jj<=2;jj++)
      {
	   i=sqrc2r(index1,ii);
	   j=sqrc2c(index1,jj);
	   if (curstep<step)
	   {
	    i=cfi;
		j=cfj;
	   }
       if(a[i][j][did]==1)
	   {
	    var infostr=""+(did+1);
		idx=i*9+j;
		isqr=rc2sqr(i,j);
		if (!possmode)
		{
         document.getElementById('c'+idx).innerHTML=did+1;
		 document.getElementById('c'+idx).className=ncls;
		 if (curstep==dispstep)
		 {
 	      showrc_t(idx,"3");
 	      document.getElementById('cell'+idx).style.backgroundColor=sbuttoncolor;
          document.getElementById('c'+idx).style.fontWeight="bold";
          document.getElementById('c'+idx).style.color="#ffffff";
		 }
         if (curstep==step)
         {		 
		  if (!fromlcd) addstep(false,"hss",""+i+","+j+","+did);
		  else solvedsqn[step-1]+=";hss>"+i+","+j+","+did;
		  addmsg('In square '+dsqr(index1)+', the only cell that can host "'+ddig(did)+'" is '+dcell(i,j)+'.');
		  addmsgr('- Hidden Single');
		  next2cont();
		 } 
	     tgotacell(t_a,i,j,did,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
	     t_itemp[i][j]=did+1;
		 rowfill[i]++;
		 colfill[j]++;
		 sqrfill[isqr]++;
		 kfill[did]++;
		}
		else 
		{
		 if (curstep==dispstep)
		 {
		  hlnumber(idx,infostr);
		  for (newi=0;newi<9;newi++)
		  {
		   nidx=i*9+newi;
		   if (newi!=j && a[i][newi][did]==1) rmval(i*9+newi,infostr,1);
		   nidx=newi*9+j;
		   if (newi!=i && a[newi][j][did]==1) rmval(newi*9+j,infostr,1);
		  }
	      showrc_t(idx,"3");
		  hlcell(idx,hyellow);
		 } 
	     var rmks=tgotacell(t_a,i,j,did,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
	     t_itemp[i][j]=did+1;
		 rowfill[i]++;
		 colfill[j]++;
		 sqrfill[isqr]++;
		 kfill[did]++;
		 needconfirm=1;
		 if (curstep==step)
		 {
		  if (!fromlcd) addstep(false,"hss",""+i+","+j+","+did);
		  else solvedsqn[step-1]+=";hss>"+i+","+j+","+did;
		  addmsg('In square '+dsqr(index1)+', the only cell that can host "'+ddig(did)+'" is '+dcell(i,j)+'.  Therefore, this cell must be '+ddig(did)+'.');
		  addmsgr('- Hidden Single');
		  if (rmks) addmsg('All other '+ddig(did)+'(s) as possibilities in the same row ('+drow(i)+') or in the same column ('+dcol(j)+') can be removed.');
		  next2update();
		 } 
		} 
	    idone=true;
	   }
	   if (idone) break;
      }      
	  if (idone) break;
	 }
	}	
	if (idone) break;
   }
   if (idone && !possmode  && curstep==dispstep)
   {
    for (ii=0;ii<=2;ii++)
	{
     for (jj=0;jj<=2;jj++)
     {	 
      newi=sqrc2r(index1,ii);
	  newj=sqrc2c(index1,jj);
	  nidx=newi*9+newj;
	  if ((newi!=i || newj!=j) && (document.getElementById('c'+nidx).innerHTML.length!=1 || document.getElementById('c'+nidx).className==smcls))
	  {
	   if (rowfirst(newi,newj))
	   {
	    ifindrelated=findrelatedrow(newi,newj,idx,did);
	    if (!ifindrelated) ifindrelated=findrelatedcol(newi,newj,idx,did);
	   }
       else
	   {
	    ifindrelated=findrelatedcol(newi,newj,idx,did);
	    if (!ifindrelated) ifindrelated=findrelatedrow(newi,newj,idx,did);
	   } 	   
	  }
	 } 
	}
   }
  }
  return idone;
}

function hsrow(did,a,poscell,krowcell,kcolcell,ksqrcell,fromlcd)
{
  var index1,i,j,ii,jj,idx,nidx,isqr,idone=false;
  if (curstep<step)
  {
   var cellinfo;
   if (fromlcd) cellinfo=solvedsqn[curstep].substr(solvedsqn[curstep].indexOf(">")+1);	
   else cellinfo=solvedsqn[curstep].substr(solvedsqn[curstep].indexOf(":")+1);	
   var cfi=cellinfo.substr(0,1)*1, cfj=cellinfo.substr(2,1)*1, did=cellinfo.substr(4,1)*1;
  }
  if (curstep<dispstep)
  {
   npgot1cell(cfi,cfj,did);
   if (possmode) needconfirm=1;
   idone=true;
  }
  else
  {  
   for(index1=0;index1<=8;index1++)
   {
    if (curstep<step) index1=cfi;
    if(krowcell[index1][did]==1)
    {
     for(j=0;j<=8;j++)
     {
	  if (curstep<step) j=cfj;
      if(a[index1][j][did]==1) 
	  {
	   var infostr=""+(did+1);
	   idx=index1*9+j;
	   isqr=rc2sqr(index1,j);
	   if (!possmode)
	   {
        document.getElementById('c'+idx).innerHTML=did+1;
	    document.getElementById('c'+idx).className=ncls;
	    if (curstep==dispstep)
	    {
 	     showrc_t(idx,"1");
	     document.getElementById('cell'+idx).style.backgroundColor=sbuttoncolor;
         document.getElementById('c'+idx).style.fontWeight="bold";
         document.getElementById('c'+idx).style.color="#ffffff";
	    }
        if (curstep==step)
        {	   
		 if (!fromlcd) addstep(false,"hsr",""+index1+","+j+","+did);
		 else solvedsqn[step-1]+=";hsr>"+index1+","+j+","+did;
		 addmsg('In row '+drow(index1)+', the only cell that can host "'+ddig(did)+'" is in column '+dcol(j)+'.');
		 addmsgr('- Hidden Single');
		 next2cont();
	    }	
        tgotacell(t_a,index1,j,did,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
	    t_itemp[index1][j]=did+1;
	    rowfill[index1]++;
	    colfill[j]++;
	    sqrfill[isqr]++;
	    kfill[did]++;
       }
	   else 
	   {
	    if (curstep==dispstep)
	    {
		 hlnumber(idx,infostr);
		 for (var newi=0;newi<9;newi++)
		 {
		  nidx=newi*9+j;
		  if (newi!=index1 && a[newi][j][did]==1) rmval(newi*9+j,infostr,1);
		  ii=Math.floor(isqr/3)*3+Math.floor(newi/3);
		  jj=(isqr%3)*3+newi%3;
		  nidx=ii*9+jj;
		  if ((ii!=index1 || jj!=j) && a[ii][jj][did]==1) rmval(ii*9+jj,infostr,1);
		 }
	     showrc_t(idx,"1");
         if (document.getElementById("sgrid"+isqr).className!="subgrido") document.getElementById("sgrid"+isqr).className="subgrido";
		 hlcell(idx,hyellow);
	    }	
        var rmks=tgotacell(t_a,index1,j,did,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
	    t_itemp[index1][j]=did+1;
	    rowfill[index1]++;
	    colfill[j]++;
	    sqrfill[isqr]++;
	    kfill[did]++;
	    needconfirm=1;
	    if (curstep==step)
	    {
		 if (!fromlcd) addstep(false,"hsr",""+index1+","+j+","+did);
		 else solvedsqn[step-1]+=";hsr>"+index1+","+j+","+did;
		 addmsg('In row '+drow(index1)+', the only cell that can host "'+ddig(did)+'" is in column '+dcol(j)+'.  Therefore, this cell '+dcell(index1,j)+' must be '+ddig(did)+'.');
		 addmsgr('- Hidden Single');
		 if (rmks) addmsg('All other '+ddig(did)+'(s) as possibilities in the same column ('+dcol(j)+') or in the same square ('+dsqr(isqr)+') can be removed.');
		 next2update();
	    }	
	   } 
	   idone=true;
      }
	  if (idone) break;
     }	 	
    }
    if (idone) break;
   } 
   if (idone && !possmode && curstep==dispstep)
   {
    for (jj=0;jj<=8;jj++)
    {
	 nidx=index1*9+jj;
	 if (jj!=j && (document.getElementById('c'+nidx).innerHTML.length!=1 || document.getElementById('c'+nidx).className==smcls))
	 {
	  ifindrelated=findrelatedsqr(index1,jj,idx,did);
	  if (!ifindrelated) ifindrelated=findrelatedcol(index1,jj,idx,did);
	 }
    } 
   }	
  }
  return idone;
}

function hscol(did,a,poscell,krowcell,kcolcell,ksqrcell,fromlcd)
{
 var index1,i,j,ii,jj,idx,nidx,isqr,idone=false;
 if (curstep<step)
 {
  var cellinfo;
  if (fromlcd) cellinfo=solvedsqn[curstep].substr(solvedsqn[curstep].indexOf(">")+1);	
  else cellinfo=solvedsqn[curstep].substr(solvedsqn[curstep].indexOf(":")+1);	
  var cfi=cellinfo.substr(0,1)*1, cfj=cellinfo.substr(2,1)*1, did=cellinfo.substr(4,1)*1;
 }
 if (curstep<dispstep)
 {
  npgot1cell(cfi,cfj,did);
  if (possmode) needconfirm=1;
  idone=true;
 }
 else
 {  
  for(index1=0;index1<=8;index1++)
  {
   if (curstep<step) index1=cfj;
   if(kcolcell[index1][did]==1)
   {
    for(i=0;i<=8;i++)
    {
	 if (curstep<step) i=cfi;
     if(a[i][index1][did]==1) 
	 {
	  var infostr=""+(did+1);
	  idx=i*9+index1;
	  isqr=rc2sqr(i,index1);
	  if (!possmode)
	  {
       document.getElementById('c'+idx).innerHTML=did+1;
	   document.getElementById('c'+idx).className=ncls;
	   if (curstep==dispstep)
	   {
	    showrc_t(idx,"2");
 	    document.getElementById('cell'+idx).style.backgroundColor=sbuttoncolor;
        document.getElementById('c'+idx).style.fontWeight="bold";
        document.getElementById('c'+idx).style.color="#ffffff";
	   }
       if (curstep==step)
       {	   
		if (!fromlcd) addstep(false,"hsc",""+i+","+index1+","+did);
		else solvedsqn[step-1]+=";hsc>"+i+","+index1+","+did;
		addmsg('In column '+dcol(index1)+', the only cell that can host "'+ddig(did)+'" is in row '+drow(i)+'.');
		addmsgr('- Hidden Single');
		next2cont();
	   }	
	   tgotacell(t_a,i,index1,did,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
	   t_itemp[i][index1]=did+1;
	   rowfill[i]++;
       colfill[index1]++;
       sqrfill[isqr]++;
       kfill[did]++;
	  }
	  else 
	  {
	   if (curstep==dispstep)
	   {
		hlnumber(idx,infostr);
		for (var newj=0;newj<9;newj++)
		{
		 nidx=i*9+newj;
		 if (newj!=index1 && a[i][newj][did]==1) rmval(i*9+newj,infostr,1);
		 ii=Math.floor(isqr/3)*3+Math.floor(newj/3);
		 jj=(isqr%3)*3+newj%3;
		 nidx=ii*9+jj;
		 if ((ii!=i || jj!=index1) && a[ii][jj][did]==1) rmval(ii*9+jj,infostr,1);
		}
	    showrc_t(idx,"2");
        if (document.getElementById("sgrid"+isqr).className!="subgrido") document.getElementById("sgrid"+isqr).className="subgrido";
		hlcell(idx,hyellow);
	   }	
	   var rmks=tgotacell(t_a,i,index1,did,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
	   t_itemp[i][index1]=did+1;
	   rowfill[i]++;
       colfill[index1]++;
       sqrfill[isqr]++;
       kfill[did]++;
	   needconfirm=1;
	   if (curstep==step)
	   {
		if (!fromlcd) addstep(false,"hsc",""+i+","+index1+","+did);
		else solvedsqn[step-1]+=";hsc>"+i+","+index1+","+did;
		addmsg('In column '+dcol(index1)+', the only cell that can host "'+ddig(did)+'" is in row '+drow(i)+'.  Therefore, this cell '+dcell(i,index1)+' must be '+ddig(did)+'.');
		addmsgr('- Hidden Single');
		if (rmks) addmsg('All other '+ddig(did)+'(s) as possibilities in the same row ('+drow(i)+') or in the same square ('+dsqr(isqr)+') can be removed.');
		next2update();
	   }
	  }  
      idone=true;
     } 
     if (idone) break;
    }	 	
   }
   if (idone) break;
  } 
  if (idone && !possmode && curstep==dispstep)
  {
   for (ii=0;ii<=8;ii++)
   {
	nidx=ii*9+index1;
	if (ii!=i && (document.getElementById('c'+nidx).innerHTML.length!=1 || document.getElementById('c'+nidx).className==smcls))
	{
	 ifindrelated=findrelatedsqr(ii,index1,idx,did);
	 if (!ifindrelated) ifindrelated=findrelatedrow(ii,index1,idx,did);
	}
   } 
  }
 } 
 return idone;
}

function ochkhs()
{
 resetrcclr_t();
 clrcount=0;
 var fromlcd=false;
 var change=chkhs(t_a,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell,fromlcd);
 return change;
}

function chkhs(a,poscell,krowcell,kcolcell,ksqrcell,fromlcd)
{
 var findhs=false,inum;
 for(inum=0;inum<9;inum++)
 {
   findhs=hssqr((curdid+inum)%9,a,poscell,krowcell,kcolcell,ksqrcell,fromlcd);
   if (!findhs) findhs=hsrow((curdid+inum)%9,a,poscell,krowcell,kcolcell,ksqrcell,fromlcd);
   if (!findhs) findhs=hscol((curdid+inum)%9,a,poscell,krowcell,kcolcell,ksqrcell,fromlcd);
   if (findhs) 
   {
    curdid=(curdid+inum)%9;
    break;
   }	
 }
 return findhs;
}

function ochkns()
{
 resetrcclr_t();
 var fromlcd=false;
 var change=chkns(t_a,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell,fromlcd);
 return change;
}

function chkns(a,poscell,krowcell,kcolcell,ksqrcell,fromlcd)
{
 var index1,index2,k,idx,isqr,nidx,i1,j1,idone=false,infostr;
 if (curstep<step)
 {
  var cellinfo;
  if (fromlcd) cellinfo=solvedsqn[curstep].substr(solvedsqn[curstep].indexOf(">")+1);	
  else cellinfo=solvedsqn[curstep].substr(solvedsqn[curstep].indexOf(":")+1);	
  var cfi=cellinfo.substr(0,1)*1, cfj=cellinfo.substr(2,1)*1, cfk=cellinfo.substr(4,1)*1;
 }
 if (curstep<dispstep)
 {
  npgot1cell(cfi,cfj,cfk);
  if (possmode) needconfirm=1;
  idone=true;
 }
 else
 {  
  for(index1=0;index1<=8;index1++)
  {
   if (curstep<step) index1=cfi;
   for(index2=0;index2<=8;index2++)
   {
    if (curstep<step) index2=cfj;
    if (poscell[index1][index2]==1)
	{
     for(k=0;k<=8;k++)
     {
	  if (curstep<step) k=cfk;
      if(a[index1][index2][k]==1) 
	  {
	   infostr=""+(k+1);
	   idx=index1*9+index2;
	   isqr=rc2sqr(index1,index2);
	   if (!possmode)
	   {
	    document.getElementById('c'+idx).className=ncls;
	    document.getElementById('c'+idx).innerHTML=k+1;	
        if (curstep==dispstep)
        {		
	     showrc_t(idx,"4");
	     document.getElementById('cell'+idx).style.backgroundColor=sbuttoncolor;
         document.getElementById('c'+idx).style.color="#ffffff";
         document.getElementById('c'+idx).style.fontWeight="bold";
		}
        if (curstep==step)
        {		
	     if (!fromlcd) addstep(false,"ns",""+index1+","+index2+","+k);
		 else solvedsqn[step-1]+=";ns>"+index1+","+index2+","+k;
	     addmsg('The only candidate for cell '+dcell(index1,index2)+' is '+ddig(k)+'.  All other digits appear at least once in the related area (i.e., in the same row ('+drow(index1)+'), in the same column ('+dcol(index2)+') or in the same square ('+dsqr(isqr)+')).');
		 addmsgr('- Naked Single');
		 next2cont();
		} 
	    tgotacell(t_a,index1,index2,k,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
	    t_itemp[index1][index2]=k+1;
	    rowfill[index1]++;
	    colfill[index2]++;
	    sqrfill[isqr]++;
	    kfill[k]++;
	   }
	   else
	   {
	    if (curstep==dispstep)
		{
		 hlnumber(idx,infostr);
		 hlcell(idx,sbuttoncolor);
	     for (var ii=0;ii<9;ii++)
		 {
          if (ii!=index2 && a[index1][ii][k]==1) rmval(index1*9+ii,infostr,1);
          if (ii!=index1 && a[ii][index2][k]==1) rmval(ii*9+index2,infostr,1);
          i1=Math.floor(isqr/3)*3+Math.floor(ii/3);
          j1=(isqr%3)*3+ii%3;
          if ((i1!=index1 || j1!=index2) && a[i1][j1][k]==1) rmval(i1*9+j1,infostr,1);		 
		 }
		} 
		var rmks=tgotacell(t_a,index1,index2,k,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
	    t_itemp[index1][index2]=k+1;
	    rowfill[index1]++;
	    colfill[index2]++;
	    sqrfill[isqr]++;
	    kfill[k]++;
    	needconfirm=1;
		if (curstep==step)
		{
	     if (!fromlcd) addstep(false,"ns",""+index1+","+index2+","+k);
		 else solvedsqn[step-1]+=";ns>"+index1+","+index2+","+k;
	     addmsg('The only candidate for cell '+dcell(index1,index2)+' is '+ddig(k)+'.  Therefore, this cell must be '+ddig(k)+'.');
		 addmsgr('- Naked Single');
		 if (rmks) addmsg('All other '+ddig(k)+'(s) as possibilities in the same row ('+drow(index1)+'), in the same column ('+ dcol(index2)+') or in the same square ('+dsqr(isqr)+') can be removed.');
		 next2update();
	     if (document.getElementById('sgrid'+isqr).className!="subgrido") document.getElementById('sgrid'+isqr).className="subgrido";
		} 
	   }
	   idone=true;
      }
	  if (idone) break;
     }	 
	}
	if (idone) break;
   }
   if (idone) break;
  }
  if (idone && !possmode && curstep==dispstep)
  {
   var icount=0,numfill=new Array(0,0,0,0,0,0,0,0,0);
   numfill[k]=1;
   if (rowfill[index1]==Math.max(rowfill[index1],colfill[index2],sqrfill[isqr])) 
   {
    icount=nsrrowelt(index1,index2,icount,numfill);
    if (icount<8)
    {
	 if (colfill[index2]==Math.max(colfill[index2],sqrfill[isqr]))
     {
	  icount=nsrcolelt(index1,index2,icount,numfill);
	  if (icount<8) icount=nsrsqrelt(index1,index2,icount,numfill);
	 }
     else
     {
	  icount=nsrsqrelt(index1,index2,icount,numfill);
	  if (icount<8) icount=nsrcolelt(index1,index2,icount,numfill);
	 } 
	}
   }
   else if (colfill[index2]==Math.max(rowfill[index1],colfill[index2],sqrfill[isqr]))
   {
    icount=nsrcolelt(index1,index2,icount,numfill);
    if (icount<8)
    {
	 if (rowfill[index1]==Math.max(rowfill[index1],sqrfill[isqr]))
     {
	  icount=nsrrowelt(index1,index2,icount,numfill);
	  if (icount<8) icount=nsrsqrelt(index1,index2,icount,numfill);
	 }
     else
     {
	  icount=nsrsqrelt(index1,index2,icount,numfill);
	  if (icount<8) icount=nsrrowelt(index1,index2,icount,numfill);
	 } 
	}
   }
   else
   {
    icount=nsrsqrelt(index1,index2,icount,numfill);
    if (icount<8)
    {
	 if (rowfill[index1]==Math.max(rowfill[index1],colfill[index2]))
     {
	  icount=nsrrowelt(index1,index2,icount,numfill);
	  if (icount<8) icount=nsrcolelt(index1,index2,icount,numfill);
	 }
     else
     {
	  icount=nsrcolelt(index1,index2,icount,numfill);
	  if (icount<8) icount=nsrrowelt(index1,index2,icount,numfill);
	 } 
	}
   }  
  }
 } 
 return idone;  
}

function nsrrowelt(i,j,icount,numfill)
{
 var newj,nidx;
 for (newj=0;newj<9;newj++)
 {
  if (newj!=j && t_itemp[i][newj]>0 && numfill[t_itemp[i][newj]-1]==0)
  {
   nidx=i*9+newj;
   document.getElementById('c'+nidx).style.color=sbuttoncolor;
   icount++;
   numfill[t_itemp[i][newj]-1]=1;
   if (icount>=8) break;
  }
 }
 return icount;
}

function nsrcolelt(i,j,icount,numfill)
{
 var newi,nidx;
 for (newi=0;newi<9;newi++)
 {
  if (newi!=i && t_itemp[newi][j]>0 && numfill[t_itemp[newi][j]-1]==0)
  {
   nidx=newi*9+j;
   document.getElementById('c'+nidx).style.color=sbuttoncolor;
   icount++;
   numfill[t_itemp[newi][j]-1]=1;
   if (icount>=8) break;
  }
 }
 return icount;
}

function nsrsqrelt(i,j,icount,numfill)
{
 var isqr,ii,jj,newi,newj,idx,nidx;
 isqr=rc2sqr(i,j);
 idx=i*9+j;
 for (ii=0;ii<3;ii++)
 {
  for (jj=0;jj<3;jj++)
  {
   newi=sqrc2r(isqr,ii);
   newj=sqrc2c(isqr,jj);
   nidx=newi*9+newj;
   if (nidx!=idx && t_itemp[newi][newj]>0 && numfill[t_itemp[newi][newj]-1]==0)
   {
    document.getElementById('c'+nidx).style.color=sbuttoncolor;
    icount++;
    numfill[t_itemp[newi][newj]-1]=1;
    if (icount>=8) break;	    		 
   }
  }
  if (icount>=8) break;
 }
 return icount;
}

function fitin(intext)
{
 if (intext.length>4) intext=intext.substring(0,4)+" "+intext.substring(4,intext.length);
 return intext;
}

function fillapos(i,j)
{
 var idx=i*9+j, dumstr="";
 for (var k=1;k<=9;k++)
 {
  if (t_a[i][j][k-1]>0) dumstr+=k;
 }
 return dumstr;
}

function fillpos(num2fill)
{
 var numfilled=0, dumstr, idx;
 possmode=true;
 if (curstep<step && num2fill==1)
 {
  var cellinfo=solvedsqn[curstep].substr(solvedsqn[curstep].indexOf(":")+1);	
  var cfi=cellinfo.substr(0,1)*1, cfj=cellinfo.substr(2,1)*1;
 }
 for (var i=0;i<9;i++)
 {
  if (curstep<step && num2fill==1) i=cfi;
  for (var j=0;j<9;j++)
  {
   if (curstep<step && num2fill==1) j=cfj;
   idx=i*9+j;
   if ((t_itemp[i][j]==0 || num2fill>60) && (document.getElementById('c'+idx).innerHTML.length!=1 || document.getElementById('c'+idx).className==smcls))
   {
    dumstr=fillapos(i,j);
	t_itemp[i][j]=dumstr;
	document.getElementById('c'+idx).innerHTML=fitin(dumstr);
	if (t_itemp[i][j]<10 && t_a[i][j][t_itemp[i][j]-1]==2) 
	{
	 document.getElementById('c'+idx).className=ncls;
	 document.getElementById('oc'+idx).className=oncls;
	} 
    else 
	{
	 document.getElementById('c'+idx).className=smcls;
	 document.getElementById('oc'+idx).className=osmcls;
	 numfilled++;
	} 
	if (numfilled>=num2fill) break;
   }
  }   
  if (numfilled>=num2fill) break;
 }
 
 if (num2fill==1) 
 {
  if (curstep==dispstep) 
  {
   showrc_t(idx,4);
   document.getElementById('cell'+idx).style.backgroundColor=sbuttoncolor;
   document.getElementById('c'+idx).style.color="#ffffff";
  } 
  if (curstep==step)
  {
   addstep(false,"poss",""+i+","+j);
   addmsg('Candidates for cell '+dcell(i,j)+' were entered.');
   bstepno=dispstep-2;
  }
  xtrastep=false;
  for (var i=0;i<81;i++)
  {
   if (document.getElementById('c'+i).innerHTML=="") 
   {
    xtrastep=true;
	break;
   }	
  } 
 }
 else
 {
  if (curstep==step && xtrastep)
  {
   addstep(false,"possall","");
   addmsg('Candidates for all empty cells were entered.');  
  }
  xtrastep=false;
 }
}

function odumlockcd(a,poscell,krowcell,kcolcell,ksqrcell)
{
 resetrcclr_t();
 clrcount=0;
 var change=dumlockcd(a,poscell,krowcell,kcolcell,ksqrcell);
 return change;
}

function dumlockcd(a,poscell,krowcell,kcolcell,ksqrcell)
{
 var ksqrrow=new Array(9),ksqrcol=new Array(9),ksrno=new Array(9),kscno=new Array(9);
 var i,j,k,isqr,index,ihask,jhask,nsqr,nsqr2,dumj,jj,dumi,ii,dumidx,dumidx2,kk,i1,j1,rowlocked=-1,collocked=-1,change=false,gotrslt=0,lockstr="",infostr="",method="";
 var atemp=new Array(9),poscelltmp=new Array(9),krowcelltmp=new Array(9),kcolcelltmp=new Array(9),ksqrcelltmp=new Array(9);
 if (curstep<step)
 {
  method=solvedsqn[curstep].substr(0,solvedsqn[curstep].indexOf(":"));
  var cellinfo=solvedsqn[curstep].substr(solvedsqn[curstep].indexOf(":")+1);	
  var cf1=cellinfo.substr(0,1)*1, cf2=cellinfo.substr(2,1)*1, cf3=cellinfo.substr(4,1)*1, cf4=cellinfo.substr(6,1)*1;
 }
 if (curstep<dispstep)
 {
  if (cellinfo.indexOf(">")>=0)
  {
   switch (cellinfo.substring(cellinfo.indexOf(";")+1,cellinfo.indexOf(">")))
   {
    case "hss":
     hssqr(0,a,poscell,krowcell,kcolcell,ksqrcell,true);
	 break;
    case "hsr":
     hsrow(0,a,poscell,krowcell,kcolcell,ksqrcell,true);
     break;
    case "hsc":
     hscol(0,a,poscell,krowcell,kcolcell,ksqrcell,true);
     break;
    case "ns":
     chkns(a,poscell,krowcell,kcolcell,ksqrcell,true);
     break;	
   }	 
  }
  else if (cf4==0)
  {
   switch (method)
   {
    case "lcsr":
	  for (j=0;j<9;j++)
	  {
	   if (rc2sqr(cf2,j)!=cf1 && a[cf2][j][cf3]==1) rmapos(a,cf2,j,cf3,poscell,krowcell,kcolcell,ksqrcell);
	  }
	  break;
	case "lcsc":  
	  for (i=0;i<9;i++)
	  {
	   if (rc2sqr(i,cf2)!=cf1 && a[i][cf2][cf3]==1) rmapos(a,i,cf2,cf3,poscell,krowcell,kcolcell,ksqrcell);
	  }
	  break;
	case "lcrs":  
	  for (i=0;i<9;i++)
	  {
	   ii=Math.floor(cf2/3)*3+Math.floor(i/3);
	   jj=(cf2%3)*3+(i%3);
	   if (ii!=cf1 && a[ii][jj][cf3]==1) rmapos(a,ii,jj,cf3,poscell,krowcell,kcolcell,ksqrcell);
	  }
	  break;
	case "lccs":  
	  for (i=0;i<9;i++)
	  {
	   ii=Math.floor(cf2/3)*3+Math.floor(i/3);
	   jj=(cf2%3)*3+(i%3);
	   if (jj!=cf1 && a[ii][jj][cf3]==1) rmapos(a,ii,jj,cf3,poscell,krowcell,kcolcell,ksqrcell);
	  }
	  break;
   }
   needconfirm=1;
  }
  return true;
 }
 else
 {
  for(i=0;i<=8;i++)
  {
   ksqrrow[i]=new Array(9);
   ksqrcol[i]=new Array(9);
   ksrno[i]=new Array(9);
   kscno[i]=new Array(9);
   atemp[i]=new Array(9);
   poscelltmp[i]=new Array(9);
   krowcelltmp[i]=new Array(9);
   kcolcelltmp[i]=new Array(9);
   ksqrcelltmp[i]=new Array(9);
   for(j=0;j<=8;j++)
   {
    ksqrrow[i][j]=new Array(9);
    ksqrcol[i][j]=new Array(9);
    atemp[i][j]=new Array(9);
    ksrno[i][j]=0;
    kscno[i][j]=0;
    for (k=0;k<=8;k++) 
    {
     ksqrrow[i][j][k]=0;
	 ksqrcol[i][j][k]=0;
    }
   } 
  }
  for (i=0;i<=8;i++)
  {
   for (j=0;j<=8;j++) 
   {
    for (k=0;k<=8;k++) 
    {
     if (a[i][j][k]==1)
	 { 
      isqr=rc2sqr(i,j);  
      ksqrrow[isqr][i][k]=1;
	  ksqrcol[isqr][j][k]=1;
	 }
    }
   }
  }

  for (isqr=0;isqr<=8;isqr++)
  {
   for (k=0;k<=8;k++) 
   {
    for (index=0;index<=8;index++) 
    {
     if (ksqrrow[isqr][index][k]==1)
	 { 
	  ksrno[isqr][k]++;
	 } 
     if (ksqrcol[isqr][index][k]==1)
	 { 
	  kscno[isqr][k]++;
	 } 	
    }
   }
  }   
	
  for (isqr=0;isqr<=8;isqr++)
  {
   for (k=0;k<=8;k++) 
   {
    infostr=""+(k+1);
	change=false;
    if (ksrno[isqr][k]==1 && (curstep==step || (curstep<step && method=="lcsr" && isqr==cf1 && k==cf3)))
	{
      lockstr="";
      for (i=0;i<9;i++)
      {
	   if (ksqrrow[isqr][i][k]==1) 
	   {
	    ihask=i;
        for (j=0;j<=8;j++)
        {
         nsqr=rc2sqr(ihask,j);
         if (nsqr!=isqr && a[ihask][j][k]==1)
         {
	      if (possmode) 
	      {
	       needconfirm=1;
	      } 
	      else
	      {
           if (!change)
		   {
		    for (ii=0;ii<9;ii++)
            {    
             for (jj=0;jj<9;jj++)
             {
	          poscelltmp[ii][jj]=poscell[ii][jj];
	          krowcelltmp[ii][jj]=krowcell[ii][jj];
	          kcolcelltmp[ii][jj]=kcolcell[ii][jj];
	          ksqrcelltmp[ii][jj]=ksqrcell[ii][jj];
	          for (kk=0;kk<9;kk++)
	          {
	           atemp[ii][jj][kk]=a[ii][jj][kk];
	          }
	          nsqr=rc2sqr(ii,jj);
	          if (nsqr==isqr && a[ii][jj][k]==1) lockstr+='<'+ii+','+jj+'>';
	         }
		    }	   
		   }
     	   rmapos(atemp,ihask,j,k,poscelltmp,krowcelltmp,kcolcelltmp,ksqrcelltmp);
           gotrslt=chkfindcell(atemp,poscelltmp,krowcelltmp,kcolcelltmp,ksqrcelltmp,lockstr);
	      }
          change=true;		  
	      if (gotrslt>0 || (change && possmode)) break;
         }
        }
	   }	
	   if (gotrslt>0 || (change && possmode)) break;
	  }
      if (gotrslt>0 || (change && possmode))
      {
       for (j1=0;j1<=8;j1++)
       {
        nsqr=rc2sqr(ihask,j1);
	    ii=Math.floor(isqr/3)*3+Math.floor(j1/3);
	    jj=(isqr%3)*3+j1%3;
	    dumidx2= ii*9+jj;
	    if (curstep==dispstep)
	    {
         if (possmode) 
	     {
	      if (ii!=ihask) document.getElementById('cell'+dumidx2).style.backgroundColor=hnobgclr;
	      else document.getElementById('cell'+dumidx2).style.backgroundColor=hyellow;
	      if (nsqr!=isqr) document.getElementById('cell'+(ihask*9+j1)).style.backgroundColor=yellow;
	     } 
         else 
	     {
	      document.getElementById('cell'+dumidx2).style.backgroundColor=yellow;
	      if (document.getElementById('c'+dumidx2).innerHTML=="" && a[ii][jj][k]!=1)
	      {
	       ifindrelated=lcdrelatedrow(ii,jj,k,a);
	       if (!ifindrelated) ifindrelated=lcdrelatedcol(ii,jj,k,a);	  
	      }
		 } 
        }
        if (a[ihask][j1][k]==1)
        {	  
	     dumidx=ihask*9+j1;
	     if (nsqr==isqr)
	     {
		  if (curstep==dispstep)
		  {
	       if (!possmode)
	       {
	        document.getElementById('c'+dumidx).className=smcls;
            document.getElementById('c'+dumidx).style.color=lockcdcolor;
	        document.getElementById('c'+dumidx).innerHTML=k+1;
            document.getElementById('oc'+dumidx).style.borderColor=lockcdcolor;
	        t_itemp[ihask][j1]=k+1;
	       }
           else hlnumber(dumidx,infostr);	
		  } 
	     }
         else if (possmode)
         {
	      if (curstep==dispstep) rmval(dumidx,infostr,1);
          rmapos(a,ihask,j1,k,poscell,krowcell,kcolcell,ksqrcell);
	     }	   
	    } 
       }
	   if (curstep==dispstep && document.getElementById('sgrid'+isqr).className!="subgrido") document.getElementById('sgrid'+isqr).className="subgrido";
	   if (curstep==step)
	   {
	    addstep(false,"lcsr",""+isqr+","+ihask+","+k+","+gotrslt);
        addmsg('In square '+dsqr(isqr)+', digit "'+ddig(k)+'" must be in row '+drow(ihask)+'.');
	   }
	   if (gotrslt>0)
	   {
	    if (curstep==step)
		{
	     addmsgr('- Locked Candidates');
	     switch (gotrslt)
	     {
	      case 1:
	      case 2:
	      case 3:
	       chkhs(atemp,poscelltmp,krowcelltmp,kcolcelltmp,ksqrcelltmp,true);
	       break;
	      case 4:
	       chkns(atemp,poscelltmp,krowcelltmp,kcolcelltmp,ksqrcelltmp,true);
	       break;
	     }
        }
        else
        {
	     switch (cellinfo.substring(cellinfo.indexOf(";")+1,cellinfo.indexOf(">")))
		 {
          case "hss":
           hssqr(0,atemp,poscelltmp,krowcelltmp,kcolcelltmp,ksqrcelltmp,true);
	       break;
          case "hsr":
           hsrow(0,atemp,poscelltmp,krowcelltmp,kcolcelltmp,ksqrcelltmp,true);
	       break;
          case "hsc":
           hscol(0,atemp,poscelltmp,krowcelltmp,kcolcelltmp,ksqrcelltmp,true);
	       break;
          case "ns":
           chkns(atemp,poscelltmp,krowcelltmp,kcolcelltmp,ksqrcelltmp,true);
	       break;		 
		 }
	    }		
	   }
	   else if (curstep==step)
	   {
	    addmsg('Therefore, "'+ddig(k)+'" cannot be a candidate of any other cells in the same row ('+drow(ihask)+').');
	    addmsgr('- Locked Candidates');
	    next2update();
	   } 
	   break;
	  }
    }
    if (gotrslt>0 || (change && possmode)) break;
	change=false;
    if (kscno[isqr][k]==1 && (curstep==step || (curstep<step && method=="lcsc" && isqr==cf1 && k==cf3)))
 	{	
	  lockstr="";
      for (j=0;j<9;j++)
      {
	   if (ksqrcol[isqr][j][k]==1) 
	   {
	    jhask=j;
        for (i=0;i<=8;i++)
        {
         nsqr=rc2sqr(i,jhask);
         if (nsqr!=isqr && a[i][jhask][k]==1)
         {
	      if (possmode) 
	      {
	       needconfirm=1;
	      } 
	      else
	      {
           if (!change)
		   {
            for (ii=0;ii<9;ii++)
            {
             for (jj=0;jj<9;jj++)
             {
	          poscelltmp[ii][jj]=poscell[ii][jj];
	          krowcelltmp[ii][jj]=krowcell[ii][jj];
	          kcolcelltmp[ii][jj]=kcolcell[ii][jj];
	          ksqrcelltmp[ii][jj]=ksqrcell[ii][jj];
	          for (kk=0;kk<9;kk++)
	          {
	           atemp[ii][jj][kk]=a[ii][jj][kk];
	          }
	          nsqr=rc2sqr(ii,jj);
	          if (nsqr==isqr && a[ii][jj][k]==1) lockstr+='<'+ii+','+jj+'>';
	         }
	        }
		   }
  		   rmapos(atemp,i,jhask,k,poscelltmp,krowcelltmp,kcolcelltmp,ksqrcelltmp);
           gotrslt=chkfindcell(atemp,poscelltmp,krowcelltmp,kcolcelltmp,ksqrcelltmp,lockstr);
	      }
          change=true;		  
	      if (gotrslt>0 || (change && possmode)) break;
         }
        }
	   }
	  }
      if (gotrslt>0 || (change && possmode))
      {
       for (i1=0;i1<=8;i1++)
       {
        nsqr=rc2sqr(i1,jhask);
	    ii=Math.floor(isqr/3)*3+Math.floor(i1/3);
	    jj=(isqr%3)*3+i1%3;
	    dumidx2= ii*9+jj;
        if (curstep==dispstep)
		{
         if (possmode) 
	     {
	      if (jj!=jhask) document.getElementById('cell'+dumidx2).style.backgroundColor=hnobgclr;
	      else document.getElementById('cell'+dumidx2).style.backgroundColor=hyellow;
	      if (nsqr!=isqr) document.getElementById('cell'+(i1*9+jhask)).style.backgroundColor=yellow;
	     } 
         else 
	     {
	      document.getElementById('cell'+dumidx2).style.backgroundColor=yellow;
	      if (document.getElementById('c'+dumidx2).innerHTML=="" && a[ii][jj][k]!=1)
	      {
	       ifindrelated=lcdrelatedrow(ii,jj,k,a);
	       if (!ifindrelated) ifindrelated=lcdrelatedcol(ii,jj,k,a);	  
	      }
		 } 
        }
        if (a[i1][jhask][k]==1)
        {	  
	     dumidx=i1*9+jhask;
	     if (nsqr==isqr)
	     {
		  if (curstep==dispstep)
	      {
	       if (!possmode)
		   {
	        document.getElementById('c'+dumidx).className=smcls;
            document.getElementById('c'+dumidx).style.color=lockcdcolor;
	        document.getElementById('c'+dumidx).innerHTML=k+1;
            document.getElementById('oc'+dumidx).style.borderColor=lockcdcolor;
	        t_itemp[i1][jhask]=k+1;
		   }
           else hlnumber(dumidx,infostr);	
          }		   
	     }
         else if (possmode)
         {
	      if (curstep==dispstep) rmval(dumidx,infostr,1);
          rmapos(a,i1,jhask,k,poscell,krowcell,kcolcell,ksqrcell);
	     }	   
	    } 
       }
	   if (curstep==dispstep && document.getElementById('sgrid'+isqr).className!="subgrido") document.getElementById('sgrid'+isqr).className="subgrido";
	   if (curstep==step)
	   {
	    addstep(false,"lcsc",""+isqr+","+jhask+","+k+","+gotrslt);
        addmsg('In square '+dsqr(isqr)+', digit "'+ddig(k)+'" must be in column '+dcol(jhask)+'.');
	   }	
	   if (gotrslt>0)
	   {
	    if (curstep==step)
		{
	     addmsgr('- Locked Candidates');
	     switch (gotrslt)
	     {
	      case 1:
	      case 2:
	      case 3:
	       chkhs(atemp,poscelltmp,krowcelltmp,kcolcelltmp,ksqrcelltmp,true);
	       break;
	      case 4:
	       chkns(atemp,poscelltmp,krowcelltmp,kcolcelltmp,ksqrcelltmp,true);
	       break;
		 } 
	    }
		else
        {
		 switch (cellinfo.substring(cellinfo.indexOf(";")+1,cellinfo.indexOf(">")))
		 {
          case "hss":
           hssqr(0,atemp,poscelltmp,krowcelltmp,kcolcelltmp,ksqrcelltmp,true);
	       break;
          case "hsr":
           hsrow(0,atemp,poscelltmp,krowcelltmp,kcolcelltmp,ksqrcelltmp,true);
	       break;
          case "hsc":
           hscol(0,atemp,poscelltmp,krowcelltmp,kcolcelltmp,ksqrcelltmp,true);
	       break;
          case "ns":
           chkns(atemp,poscelltmp,krowcelltmp,kcolcelltmp,ksqrcelltmp,true);
	       break;		 
		 }
		}		
	   } 
	   else if (curstep==step)
	   { 
	    addmsg('Therefore, "'+ddig(k)+'" cannot be a candidate of any other cells in the same column ('+dcol(jhask)+').');
	    addmsgr('- Locked Candidates');
	    next2update();
	   }  
	   break;
	  }
	}
    if (gotrslt>0 || (change && possmode)) break;
	change=false;
    if (ksrno[isqr][k]>1 && (curstep==step || (curstep<step && method=="lcrs" && isqr==cf2 && k==cf3)))
 	{	
	  lockstr="";
	  for (i=0;i<3;i++)
	  {
	   dumi=Math.floor(isqr/3)*3+i;
	   if (curstep<step) dumi=cf1;
	   if (ksqrrow[isqr][dumi][k]==1)
	   {
	    rowlocked=dumi;
		change=true;
	    for (j=0;j<3;j++)
		{
		 nsqr=Math.floor(isqr/3)*3+j;
		 if (nsqr!=isqr && ksqrrow[nsqr][rowlocked][k]==1) change=false;
		}
		if (change)
		{
		 if (possmode) needconfirm=1;
		 else
		 {
	      for (jj=0;jj<9;jj++)
	      {
	       for (ii=0;ii<9;ii++)
	       {
	        poscelltmp[ii][jj]=poscell[ii][jj];
	        krowcelltmp[ii][jj]=krowcell[ii][jj];
	        kcolcelltmp[ii][jj]=kcolcell[ii][jj];
	        ksqrcelltmp[ii][jj]=ksqrcell[ii][jj];
	        for (kk=0;kk<9;kk++)
	        {
	         atemp[ii][jj][kk]=a[ii][jj][kk];
	        }
           }			
		   if (rowlocked>-1 && a[rowlocked][jj][k]==1) lockstr+='<'+rowlocked+','+jj+'>';
	      }
          for (ii=0;ii<9;ii++)
          {
		   dumi=Math.floor(isqr/3)*3+Math.floor(ii/3);
		   dumj=(isqr%3)*3+(ii%3);
		   if (dumi!=rowlocked && a[dumi][dumj][k]==1)
		   {
		    rmapos(atemp,dumi,dumj,k,poscelltmp,krowcelltmp,kcolcelltmp,ksqrcelltmp);
            gotrslt=chkfindcell(atemp,poscelltmp,krowcelltmp,kcolcelltmp,ksqrcelltmp,lockstr);
		   }
		   if (gotrslt>0) break;
		  }		 
		 }
		} 
	   }
	   if (gotrslt>0 || (change && possmode)) break;
	  }
      if (gotrslt>0 || (change && possmode))
      {
       for (j1=0;j1<=8;j1++)
       {
        nsqr2=Math.floor(isqr/3)*3+Math.floor(j1/3);
	    ii=Math.floor(isqr/3)*3+Math.floor(j1/3);
	    jj=(isqr%3)*3+j1%3;
		dumidx=ii*9+jj;
	    dumidx2= rowlocked*9+j1;
        if (possmode) 
	    {
	     if (curstep==dispstep)
	     {
	      if (nsqr2!=isqr) document.getElementById('cell'+dumidx2).style.backgroundColor=hnobgclr;
	      else document.getElementById('cell'+dumidx2).style.backgroundColor=hyellow;
	     } 
	     if (ii!=rowlocked) 
	     {
		  if (curstep==dispstep) document.getElementById('cell'+dumidx).style.backgroundColor=yellow;
	      if (a[ii][jj][k]==1)
	      {
	       if (curstep==dispstep) rmval(dumidx,infostr,1);
           rmapos(a,ii,jj,k,poscell,krowcell,kcolcell,ksqrcell);
		  }
		 }
         else if (a[ii][jj][k]==1 && curstep==dispstep) hlnumber(dumidx,infostr);			 
	    }  
        else if (curstep==dispstep)
	    {
	     document.getElementById('cell'+dumidx2).style.backgroundColor=yellow;
	     if (document.getElementById('c'+dumidx2).innerHTML=="" && a[rowlocked][j1][k]!=1)
	     {
	      ifindrelated=lcdrelatedsqr(rowlocked,j1,k,a);
	      if (!ifindrelated) ifindrelated=lcdrelatedcol(rowlocked,j1,k,a);	  
	     }
		 else if (a[rowlocked][j1][k]==1)
		 {
	      document.getElementById('c'+dumidx2).className=smcls;
          document.getElementById('c'+dumidx2).style.color=lockcdcolor;
	      document.getElementById('c'+dumidx2).innerHTML=k+1;
          document.getElementById('oc'+dumidx2).style.borderColor=lockcdcolor;
	      t_itemp[rowlocked][j1]=k+1;			 
		 }
        }
       }	
	   if (document.getElementById('sgrid'+isqr).className!="subgrido" && curstep==dispstep) document.getElementById('sgrid'+isqr).className="subgrido";
	   if (curstep==step)
	   {
	    addstep(false,"lcrs",""+rowlocked+","+isqr+","+k+","+gotrslt);
        addmsg('In row '+drow(rowlocked)+', digit "'+ddig(k)+'" must be in square '+dsqr(isqr)+'.');
	   }	
       if (gotrslt>0)
       {		  
	    if (curstep==step)
	    {
	     addmsgr('- Locked Candidates');
	     switch (gotrslt)
	     {
	      case 1:
	      case 2:
	      case 3:
	       chkhs(atemp,poscelltmp,krowcelltmp,kcolcelltmp,ksqrcelltmp,true);
	       break;
	      case 4:
	       chkns(atemp,poscelltmp,krowcelltmp,kcolcelltmp,ksqrcelltmp,true);
	       break;
	     }				 
	    }
	    else
        {
	     switch (cellinfo.substring(cellinfo.indexOf(";")+1,cellinfo.indexOf(">")))
	     {
          case "hss":
           hssqr(0,atemp,poscelltmp,krowcelltmp,kcolcelltmp,ksqrcelltmp,true);
	       break;
          case "hsr":
           hsrow(0,atemp,poscelltmp,krowcelltmp,kcolcelltmp,ksqrcelltmp,true);
	       break;
          case "hsc":
           hscol(0,atemp,poscelltmp,krowcelltmp,kcolcelltmp,ksqrcelltmp,true);
	       break;
          case "ns":
           chkns(atemp,poscelltmp,krowcelltmp,kcolcelltmp,ksqrcelltmp,true);
	       break;		 
	     }
	    }				
	   }
	   else if (curstep==step)
       {
	    addmsg('Therefore, "'+ddig(k)+'" cannot be a candidate of any other cells in the same square ('+dsqr(isqr)+').');
	    addmsgr('- Locked Candidates');
	    next2update();
       }
      }
    }
    if (gotrslt>0 || (change && possmode)) break;

	change=false;
    if (kscno[isqr][k]>1 && (curstep==step || (curstep<step && method=="lccs" && isqr==cf2 && k==cf3)))
    {	
	  lockstr="";
	  for (j=0;j<3;j++)
	  {
	   dumj=(isqr%3)*3+j;
	   if (curstep<step) dumj=cf1;
	   if (ksqrcol[isqr][dumj][k]==1)
	   {
	    collocked=dumj;
		change=true;
	    for (i=0;i<3;i++)
		{
		 nsqr=i*3+(isqr%3);
		 if (nsqr!=isqr && ksqrcol[nsqr][collocked][k]==1) change=false;
		}
  		if (change)
		{
		 if (possmode) needconfirm=1;
		 else
		 {
	      for (ii=0;ii<9;ii++)
	      {
	       for (jj=0;jj<9;jj++)
	       {
	        poscelltmp[ii][jj]=poscell[ii][jj];
	        krowcelltmp[ii][jj]=krowcell[ii][jj];
	        kcolcelltmp[ii][jj]=kcolcell[ii][jj];
	        ksqrcelltmp[ii][jj]=ksqrcell[ii][jj];
	        for (kk=0;kk<9;kk++)
	        {
	         atemp[ii][jj][kk]=a[ii][jj][kk];
	        }
           }			
		   if (collocked>-1 && a[ii][collocked][k]==1) lockstr+='<'+ii+','+collocked+'>';
	      }
          for (ii=0;ii<9;ii++)
          {
		   dumi=Math.floor(isqr/3)*3+Math.floor(ii/3);
		   dumj=(isqr%3)*3+(ii%3);
		   if (dumj!=collocked && a[dumi][dumj][k]==1)
		   {
		    rmapos(atemp,dumi,dumj,k,poscelltmp,krowcelltmp,kcolcelltmp,ksqrcelltmp);
            gotrslt=chkfindcell(atemp,poscelltmp,krowcelltmp,kcolcelltmp,ksqrcelltmp,lockstr);
		   }
		   if (gotrslt>0) break;
		  }		 
		 }
		} 
	   }
	   if (gotrslt>0 || (change && possmode)) break;
	  }
      if (gotrslt>0 || (change && possmode))
      {
       for (j1=0;j1<=8;j1++)
       {
        nsqr2=Math.floor(j1/3)*3+(isqr%3);
	    ii=Math.floor(isqr/3)*3+Math.floor(j1/3);
	    jj=(isqr%3)*3+j1%3;
		dumidx=ii*9+jj;
	    dumidx2= j1*9+collocked;
        if (possmode) 
	    {
		 if (curstep==dispstep)
		 {
	      if (nsqr2!=isqr) document.getElementById('cell'+dumidx2).style.backgroundColor=hnobgclr;
	      else document.getElementById('cell'+dumidx2).style.backgroundColor=hyellow;
		 } 
	     if (jj!=collocked) 
		 {
		  if (curstep==dispstep) document.getElementById('cell'+dumidx).style.backgroundColor=yellow;
	      if (a[ii][jj][k]==1)
	      {
	       if (curstep==dispstep) rmval(dumidx,infostr,1);
           rmapos(a,ii,jj,k,poscell,krowcell,kcolcell,ksqrcell);
		  }
		 }
         else if (a[ii][jj][k]==1 && curstep==dispstep) hlnumber(dumidx,infostr);			 
	    }  
        else if (curstep==dispstep)
	    {
	     document.getElementById('cell'+dumidx2).style.backgroundColor=yellow;
	     if (document.getElementById('c'+dumidx2).innerHTML=="" && a[j1][collocked][k]!=1)
	     {
	      ifindrelated=lcdrelatedsqr(j1,collocked,k,a);
	      if (!ifindrelated) ifindrelated=lcdrelatedrow(j1,collocked,k,a);	  
	     }
	     else if (a[j1][collocked][k]==1)
		 {
	      document.getElementById('c'+dumidx2).className=smcls;
          document.getElementById('c'+dumidx2).style.color=lockcdcolor;
	      document.getElementById('c'+dumidx2).innerHTML=k+1;
          document.getElementById('oc'+dumidx2).style.borderColor=lockcdcolor;
	      t_itemp[j1][collocked]=k+1;			 
	     }
        }
       }	
       if (document.getElementById('sgrid'+isqr).className!="subgrido" && curstep==dispstep) document.getElementById('sgrid'+isqr).className="subgrido";
       if (curstep==step)
	   {
	    addstep(false,"lccs",""+collocked+","+isqr+","+k+","+gotrslt);
        addmsg('In column '+dcol(collocked)+', digit "'+ddig(k)+'" must be in square '+dsqr(isqr)+'.');
	   } 	
       if (gotrslt>0)
       {		  
	    if (curstep==step)
	    {
	     addmsgr('- Locked Candidates');
	     switch (gotrslt)
	     {
	      case 1:
	      case 2:
	      case 3:
	       chkhs(atemp,poscelltmp,krowcelltmp,kcolcelltmp,ksqrcelltmp,true);
	       break;
	      case 4:
	       chkns(atemp,poscelltmp,krowcelltmp,kcolcelltmp,ksqrcelltmp,true);
	       break;
	     }	
	    }
	    else
        {
	     switch (cellinfo.substring(cellinfo.indexOf(";")+1,cellinfo.indexOf(">")))
	     {
          case "hss":
             hssqr(0,atemp,poscelltmp,krowcelltmp,kcolcelltmp,ksqrcelltmp,true);
	         break;
          case "hsr":
             hsrow(0,atemp,poscelltmp,krowcelltmp,kcolcelltmp,ksqrcelltmp,true);
	         break;
          case "hsc":
             hscol(0,atemp,poscelltmp,krowcelltmp,kcolcelltmp,ksqrcelltmp,true);
	         break;
          case "ns":
             chkns(atemp,poscelltmp,krowcelltmp,kcolcelltmp,ksqrcelltmp,true);
	         break;		 
	     }
	    }							
       } 
	   else if (curstep==step)
	   {
	   	addmsg('Therefore, "'+ddig(k)+'" cannot be a candidate of any other cells in the same square ('+dsqr(isqr)+').');
	    addmsgr('- Locked Candidates');
        next2update();
       }
	  }
    }
    if (gotrslt>0 || (change && possmode)) break;
   }
   if (gotrslt>0 || (change && possmode)) break;
  }
  if (gotrslt>0 || (change && possmode)) return true;
  else return false;
 } 
} 

function chkfindcell(a,poscell,krowcell,kcolcell,ksqrcell,lockstr)
{
 var index1,index2,i,j,k,ii,jj,idone=0,dumstr;
  for(index1=0;index1<=8;index1++)
  {
   for(index2=0;index2<=8;index2++)
   {
	if(ksqrcell[index1][index2]==1)
	{
	 for(ii=0;ii<=2;ii++)
	 {
      for(jj=0;jj<=2;jj++)
      {
	   i=sqrc2r(index1,ii);
	   j=sqrc2c(index1,jj);
	   dumstr='<'+i+','+j+'>';
       if( a[i][j][index2]==1 && lockstr.indexOf(dumstr)<0)
	   {
	    idone=1;
		break;
	   }
      }      
	  if (idone!=0) break;
	 }
	}
	if (idone!=0) break;
	if(krowcell[index1][index2]==1)
	{
     for(j=0;j<=8;j++)
     {
	  dumstr='<'+index1+','+j+'>';
      if(a[index1][j][index2]==1 && lockstr.indexOf(dumstr)<0) 
	  {
	   idone=2;
	   break;
      } 
     }	 	
	}
	if (idone!=0) break;
	if(kcolcell[index1][index2]==1)
	{
     for(i=0;i<=8;i++)
     {
	  dumstr='<'+i+','+index1+'>';
      if(a[i][index1][index2]==1 && lockstr.indexOf(dumstr)<0) 
	  {
	   idone=3;
	   break;
      } 
     }	 	
	}
	if (idone!=0) break;
    if (poscell[index1][index2]==1)
	{
     for(k=0;k<=8;k++)
     {
	  dumstr='<'+index1+','+index2+'>';
      if(a[index1][index2][k]==1 && lockstr.indexOf(dumstr)<0) 
	  {	   
	   idone=4;
	   break;
      } 
     }	 
	}
	if (idone!=0) break;
  }	
   if (idone!=0) break;
  }
  return idone;
}

function lcdrelatedrow(row,col,did,a)
{
 var ifound=false, nidx=row*9+col, j, nidx2;
 for (j=0;j<9;j++)
 {
  nidx2=row*9+j;
  if (j!=col && document.getElementById('c'+nidx2).innerHTML==(did+1) && a[row][j][did]==2) //no pencil marks
  {
   ifound=true;
   if (document.getElementById('c'+nidx2).style.color=="" && document.getElementById('c'+nidx2).className!=smcls)
   {    
    document.getElementById('c'+nidx2).style.color=setcolor[clrcount%8];
    document.getElementById('oc'+nidx2).style.borderColor=setcolor[clrcount%8];
    clrcount++;
   }
   document.getElementById('oc'+nidx).style.color=document.getElementById('c'+nidx2).style.color;
   document.getElementById('oc'+nidx).innerHTML="--";
   break;
  }
 }
 return ifound;
}

function lcdrelatedcol(row,col,did,a)
{
 var ifound=false, nidx=row*9+col, i, nidx2;
 for (i=0;i<9;i++)
 {
  nidx2=i*9+col;
  if (i!=row && document.getElementById('c'+nidx2).innerHTML==(did+1) && a[i][col][did]==2) //no pencil marks
  {
   ifound=true;
   if (document.getElementById('c'+nidx2).style.color=="")
   {
    document.getElementById('c'+nidx2).style.color=setcolor[clrcount%8];
    document.getElementById('oc'+nidx2).style.borderColor=setcolor[clrcount%8];
    clrcount++;
   }
   document.getElementById('oc'+nidx).style.color=document.getElementById('c'+nidx2).style.color;
   document.getElementById('oc'+nidx).innerHTML="|";
   break;
  }
 }
 return ifound;
}

function lcdrelatedsqr(row,col,did,a)
{
 var ifound=false, nidx=row*9+col, isqr=rc2sqr(row,col),i,newi,newj,nidx2;
 for (i=0;i<9;i++)
 {
  newi=Math.floor(isqr/3)*3+Math.floor(i/3);
  newj=(isqr%3)*3+i%3;
  nidx2=newi*9+newj;
  if ((newi!=row || newj!=col) && document.getElementById('c'+nidx2).innerHTML==(did+1) && a[newi][newj][did]==2) //no pencil marks
  {
   ifound=true;
   if (document.getElementById('c'+nidx2).style.color=="")
   {
    document.getElementById('c'+nidx2).style.color=setcolor[clrcount%8];
    document.getElementById('oc'+nidx2).style.borderColor=setcolor[clrcount%8];
    clrcount++;
   }
   document.getElementById('oc'+nidx).style.color=document.getElementById('c'+nidx2).style.color;
   document.getElementById('oc'+nidx).innerHTML="X";
   break;
  }
 }
 return ifound;
}

function rmval(idx,val,borderyn)
{
 var dumstr=document.getElementById('c'+idx).innerHTML, dumln=dumstr.length, fstr="";
 if (dumln>0)
 {
  for (var i=0;i<dumln;i++)
  {
   if ("123456789".indexOf(dumstr.substr(i,1))>=0)
   {
    if (val.indexOf(dumstr.substr(i,1))<0) fstr+="&nbsp;";
	else fstr+="\\";
   }
   else fstr+=dumstr.substr(i,1);
  }
  document.getElementById('oc'+idx).className=osmcls;
  if (borderyn==1) document.getElementById('oc'+idx).style.borderColor=sbuttoncolor;
  document.getElementById('oc'+idx).innerHTML=fstr;
 }
}

function kpval(idx,val,borderyn)
{
 var dumstr=document.getElementById('c'+idx).innerHTML, dumln=dumstr.length, fstr="";
 if (dumln>0)
 {
  for (var i=0;i<dumln;i++)
  {
   if ("123456789".indexOf(dumstr.substr(i,1))>=0)
   {
    if (val.indexOf(dumstr.substr(i,1))>=0) fstr+="&nbsp;";
	else fstr+="\\";
   }
   else fstr+=dumstr.substr(i,1);
  }
  document.getElementById('oc'+idx).className=osmcls;
  if (borderyn==1) document.getElementById('oc'+idx).style.borderColor=sbuttoncolor;
  document.getElementById('oc'+idx).innerHTML=fstr;
 }
}

function ndbl(a,poscell,krowcell,kcolcell,ksqrcell)
{
 var i,j1,j2,k,jj,kk,idx,kv1=-1,kv2=-1,match=false,change=false,infostr="",method="";
 resetrcclr_t();
 fillpos(80);
 if (curstep<step)
 {
  method=solvedsqn[curstep].substr(0,solvedsqn[curstep].indexOf(":"));
  var cellinfo=solvedsqn[curstep].substr(solvedsqn[curstep].indexOf(":")+1);	
  var cf1=cellinfo.substr(0,1)*1, cf2=cellinfo.substr(2,1)*1, cf3=cellinfo.substr(4,1)*1, cf4=cellinfo.substr(6,1)*1, cf5=cellinfo.substr(8,1)*1;
 }
 if (curstep<dispstep)
 {
  switch (method)
  {
   case "ndblr":
     for (i=0;i<9;i++)
	 {
	  if (i!=cf2 && i!=cf3)
	  {
	   if (a[cf1][i][cf4]==1) rmapos(a,cf1,i,cf4,poscell,krowcell,kcolcell,ksqrcell);
	   if (a[cf1][i][cf5]==1) rmapos(a,cf1,i,cf5,poscell,krowcell,kcolcell,ksqrcell);
	  }
	 }
	 break;
   case "ndblc":
     for (i=0;i<9;i++)
	 {
	  if (i!=cf2 && i!=cf3)
	  {
	   if (a[i][cf1][cf4]==1) rmapos(a,i,cf1,cf4,poscell,krowcell,kcolcell,ksqrcell);
	   if (a[i][cf1][cf5]==1) rmapos(a,i,cf1,cf5,poscell,krowcell,kcolcell,ksqrcell);
	  }
	 }
	 break;
   case "ndbls":
     for (i=0;i<9;i++)
	 {
	  if (i!=cf2 && i!=cf3)
	  {
       ii=Math.floor(cf1/3)*3+Math.floor(i/3);
       jj=(cf1%3)*3+i%3
	   if (a[ii][jj][cf4]==1) rmapos(a,ii,jj,cf4,poscell,krowcell,kcolcell,ksqrcell);
	   if (a[ii][jj][cf5]==1) rmapos(a,ii,jj,cf5,poscell,krowcell,kcolcell,ksqrcell);
	  }
	 }
	 break;
  }
  needconfirm=1;
  change=true;
 }
 else
 {
  for(i=0;i<=8;i++)
  {
   if (curstep<step) i=cf1;
   if (curstep==step || (curstep<step && method=="ndblr"))
   {
    if (rowfill[i]<=5)   //change <=6 to <=5
    {
     for(j1=0;j1<=7;j1++)
     {
      if (curstep<step) j1=cf2;
      if (poscell[i][j1]==2)
      {
       for(j2=j1+1;j2<=8;j2++)
       {	
        if (curstep<step) j2=cf3;
        match=false;
	    if (poscell[i][j2]==2)
        {
	     match=true;
	     infostr="";
	     kv1=-1;
	     kv2=-1;
	     for(k=0;k<=8;k++)
	     {
	      if(a[i][j1][k]!=a[i][j2][k]) 
	      {
	       match=false;
		   infostr="";
		   break;
	      }
          else if (a[i][j1][k]>0) 
		  {
		   if (kv1<0) kv1=k;
		   else kv2=k;
		   infostr+=(k+1);
		  }
	     }
	     if (match)
	     {
	      for(jj=0;jj<=8;jj++)
	      {
	       if(jj!=j1 && jj!=j2)
		   {
		    if (a[i][jj][kv1]!=0 || a[i][jj][kv2]!=0)
		    {
		     idx=i*9+jj;
             change=true;
             if (curstep==dispstep) rmval(idx,infostr,0);
             if (a[i][jj][kv1]!=0) rmapos(a,i,jj,kv1,poscell,krowcell,kcolcell,ksqrcell);		   
             if (a[i][jj][kv2]!=0) rmapos(a,i,jj,kv2,poscell,krowcell,kcolcell,ksqrcell);		   
            }
           }		  
	      }
	     }
        }	
	    if (change) 
	    {
	     needconfirm=1;
	     if (curstep==dispstep)
	     {
          showrc_t(i*9,1);
          document.getElementById("oc"+(i*9+j1)).style.borderColor=sbuttoncolor;
          document.getElementById("oc"+(i*9+j2)).style.borderColor=sbuttoncolor;
	     }
         if (curstep==step)
         {	   
	      addstep(false,"ndblr",""+i+","+j1+","+j2+","+kv1+","+kv2);
	      addmsg('In row '+drow(i)+', cells '+dcell(i,j1)+' and '+dcell(i,j2)+' have exactly the same 2 possibilities '+ddig(kv1)+' and '+ddig(kv2)+'.  Therefore, these 2 digits must reside in one of these 2 cells respectively and cannot be possibilities in any other cells of this row.');
	      addmsgr('- Naked Double');
	      next2update();
	     } 	
         break;
	    } 
       }
      }
      if (change) break;   
     }
     if (change) break;
    }	
   }

   if (change) break;
   if (curstep==step || (curstep<step && method=="ndblc"))
   {
    if (colfill[i]<=5)   //  change <=6 to <=5
    {
     for(j1=0;j1<=7;j1++)
     { 
	  if (curstep<step) j1=cf2;
      if (poscell[j1][i]==2)
      {
       for(j2=j1+1;j2<=8;j2++)
       {	
	    if (curstep<step) j2=cf3;
        match=false;
	    if (poscell[j2][i]==2)
        {
	     match=true;
	     infostr="";
	     kv1=-1;
	     kv2=-1;
	     for(k=0;k<=8;k++)
	     {
	      if(a[j1][i][k]!=a[j2][i][k]) 
	      {
	       match=false;
		   infostr="";
		   break;
	      }
          else if (a[j1][i][k]>0) 
		  {
		   if (kv1<0) kv1=k;
		   else kv2=k;
		   infostr+=(k+1);
		  }
	     }
	     if (match)
	     {
	      for(jj=0;jj<=8;jj++)
	      {
	       if(jj!=j1 && jj!=j2)
		   {
		    if (a[jj][i][kv1]!=0 || a[jj][i][kv2]!=0)
		    {
		     idx=jj*9+i;
             change=true;
             if (curstep==dispstep) rmval(idx,infostr,0);
             if (a[jj][i][kv1]!=0) rmapos(a,jj,i,kv1,poscell,krowcell,kcolcell,ksqrcell);		   
             if (a[jj][i][kv2]!=0) rmapos(a,jj,i,kv2,poscell,krowcell,kcolcell,ksqrcell);		   
            }
           }		  
	      }
	     }
        }	
	    if (change) 
	    {
	     needconfirm=1;
		 if (curstep==dispstep)
		 {
          showrc_t(i,2);
          document.getElementById("oc"+(j1*9+i)).style.borderColor=sbuttoncolor;
          document.getElementById("oc"+(j2*9+i)).style.borderColor=sbuttoncolor;
		 }
         if (curstep==step)
         {		
	      addstep(false,"ndblc",""+i+","+j1+","+j2+","+kv1+","+kv2);
	      addmsg('In column '+dcol(i)+', cells '+dcell(j1,i)+' and '+dcell(j2,i)+' have exactly the same 2 possibilities '+ddig(kv1)+' and '+ddig(kv2)+'.  Therefore, these 2 digits must reside in one of these 2 cells respectively and cannot be possibilities in any other cells of this column.');
	      addmsgr('- Naked Double');
	      next2update();
		 } 
         break;
	    } 
       }
      }
      if (change) break;   
     }
     if (change) break;
    }
   }
  
   if (change) break;
  
   if (curstep==step || (curstep<step && method=="ndbls"))
   {
    if (sqrfill[i]<=5)   // change <=6 to <=5
    {
     for(index1=0;index1<=7;index1++)
     {
	  if (curstep<step) index1=cf2;
      i1=Math.floor(i/3)*3+Math.floor(index1/3);
      j1=(i%3)*3+index1%3;
      if (poscell[i1][j1]==2)
      {
       for(index2=index1+1;index2<=8;index2++)
       {
	    if (curstep<step) index2=cf3;
        i2=Math.floor(i/3)*3+Math.floor(index2/3);
        j2=(i%3)*3+index2%3;
        match=false;
	    if (poscell[i2][j2]==2)
	    {
	     match=true;
	     infostr="";
	     kv1=-1;
	     kv2=-1;
	     for(k=0;k<=8;k++)
	     {
	      if(a[i1][j1][k]!=a[i2][j2][k]) 
	      {
	       match=false;
	 	   infostr="";
	 	   break;
	      }
          else if (a[i1][j1][k]>0) 
		  {
		   if (kv1<0) kv1=k;
		   else kv2=k;
		   infostr+=(k+1);
		  }
	     }
	     if (match)
	     {
	      for(nindex=0;nindex<=8;nindex++)
	      {
		   if (nindex!=index1 && nindex!=index2)
		   {
            ii=Math.floor(i/3)*3+Math.floor(nindex/3);
            jj=(i%3)*3+nindex%3
		    if (a[ii][jj][kv1]!=0 || a[ii][jj][kv2]!=0)
		    {
		     idx=ii*9+jj;
		     change=true;
		     if (curstep==dispstep) rmval(idx,infostr,0);
		     if (a[ii][jj][kv1]!=0) rmapos(a,ii,jj,kv1,poscell,krowcell,kcolcell,ksqrcell);
		     if (a[ii][jj][kv2]!=0) rmapos(a,ii,jj,kv2,poscell,krowcell,kcolcell,ksqrcell);
            }		
	       }
	      }
	     }
        }	
	    if (change) 
	    {
	     needconfirm=1;
		 if (curstep==dispstep)
		 {
          showrc_t(i1*9+j1,3);
          document.getElementById("oc"+(i1*9+j1)).style.borderColor=sbuttoncolor;
          document.getElementById("oc"+(i2*9+j2)).style.borderColor=sbuttoncolor;
		 }
         if (curstep==step)
         {		
	      addstep(false,"ndbls",""+i+","+index1+","+index2+","+kv1+","+kv2);
	      addmsg('In square '+dsqr(i)+', cells '+dcell(i1,j1)+' and '+dcell(i2,j2)+' have exactly the same 2 possibilities '+ddig(kv1)+' and '+ddig(kv2)+'.  Therefore, these 2 digits must reside in one of these 2 cells respectively and cannot be possibilities in any other cells of this square.');
	      addmsgr('- Naked Double');
	      next2update();
		 } 
         break;
	    } 
       }
      }
      if (change) break;   
     }
     if (change) break;
    }
   }
  }
 }
 return change;
} 

function ntpl(a,poscell,krowcell,kcolcell,ksqrcell)
{
 var i,j,i1,i2,i3,j1,j2,j3,k,ii,jj,kk,idx,isqr,index1,index2,index3,nindex,kv=new Array(-1,-1,-1),icount=0,change=false,infostr="",method="";
 resetrcclr_t();
 fillpos(80);
 if (curstep<step)
 {
  method=solvedsqn[curstep].substr(0,solvedsqn[curstep].indexOf(":"));
  var cellinfo=solvedsqn[curstep].substr(solvedsqn[curstep].indexOf(":")+1);	
  var cf1=cellinfo.substr(0,1)*1, cf2=cellinfo.substr(2,1)*1, cf3=cellinfo.substr(4,1)*1, cf4=cellinfo.substr(6,1)*1;
  var cf5=cellinfo.substr(8,1)*1, cf6=cellinfo.substr(10,1)*1, cf7=cellinfo.substr(12,1)*1
 }
 if (curstep<dispstep)
 {
  switch (method)
  {
   case "ntplr":
     for (i=0;i<9;i++)
	 {
	  if (i!=cf2 && i!=cf3 && i!=cf4)
	  {
	   if (a[cf1][i][cf5]==1) rmapos(a,cf1,i,cf5,poscell,krowcell,kcolcell,ksqrcell);
	   if (a[cf1][i][cf6]==1) rmapos(a,cf1,i,cf6,poscell,krowcell,kcolcell,ksqrcell);
	   if (a[cf1][i][cf7]==1) rmapos(a,cf1,i,cf7,poscell,krowcell,kcolcell,ksqrcell);
	  }
	 }
	 break;
   case "ntplc":
     for (i=0;i<9;i++)
	 {
	  if (i!=cf2 && i!=cf3 && i!=cf4)
	  {
	   if (a[i][cf1][cf5]==1) rmapos(a,i,cf1,cf5,poscell,krowcell,kcolcell,ksqrcell);
	   if (a[i][cf1][cf6]==1) rmapos(a,i,cf1,cf6,poscell,krowcell,kcolcell,ksqrcell);
	   if (a[i][cf1][cf7]==1) rmapos(a,i,cf1,cf7,poscell,krowcell,kcolcell,ksqrcell);
	  }
	 }
	 break;
   case "ntpls":
     for (i=0;i<9;i++)
	 {
	  if (i!=cf2 && i!=cf3 && i!=cf4)
	  {
       ii=Math.floor(cf1/3)*3+Math.floor(i/3);
       jj=(cf1%3)*3+i%3
	   if (a[ii][jj][cf5]==1) rmapos(a,ii,jj,cf5,poscell,krowcell,kcolcell,ksqrcell);
	   if (a[ii][jj][cf6]==1) rmapos(a,ii,jj,cf6,poscell,krowcell,kcolcell,ksqrcell);
	   if (a[ii][jj][cf7]==1) rmapos(a,ii,jj,cf7,poscell,krowcell,kcolcell,ksqrcell);
	  }
	 }
	 break;
  }
  needconfirm=1;
  change=true;
 }
 else
 {
  if (curstep==step || (curstep<step && method=="ntplr"))
  {
   for(i=0;i<=8;i++)
   {
    if (curstep<step) i=cf1;
    if (rowfill[i]<=4)    // change <=5 to <=4
    {
     for(j1=0;j1<=6;j1++)
     {
      if (curstep<step) j1=cf2;
      if (poscell[i][j1]<=3 && poscell[i][j1]>=2)
	  {
       for(j2=j1+1;j2<=7;j2++)
       {
        if (curstep<step) j2=cf3;
	    if (poscell[i][j2]<=3 && poscell[i][j2]>=2)
	    {
         for(j3=j2+1;j3<=8;j3++)
         { 
          if (curstep<step) j3=cf4;
	      if (poscell[i][j3]<=3 && poscell[i][j3]>=2)
          {
	       icount=0;
		   infostr="";
		   kv=[-1,-1,-1];
	       for(k=0;k<=8;k++)
	       {
	        if(a[i][j1][k]+a[i][j2][k]+a[i][j3][k]>0) 
		    {
		     if (icount<3) kv[icount]=k;
		     icount++;
		     if (icount>3) break;
		     infostr+=(k+1);
		    } 
	       }
	       if (icount==3)
	       {	   
	        for(jj=0;jj<=8;jj++)
	        {
	         if(jj!=j1 && jj!=j2 && jj!=j3) 
		     {
     		  if (a[i][jj][kv[0]]!=0 || a[i][jj][kv[1]]!=0 || a[i][jj][kv[2]]!=0)
			  {
		       idx=i*9+jj;
		       change=true;
		       if (curstep==dispstep) rmval(idx,infostr,0);
		       if (a[i][jj][kv[0]]!=0) rmapos(a,i,jj,kv[0],poscell,krowcell,kcolcell,ksqrcell);
		       if (a[i][jj][kv[1]]!=0) rmapos(a,i,jj,kv[1],poscell,krowcell,kcolcell,ksqrcell);
		       if (a[i][jj][kv[2]]!=0) rmapos(a,i,jj,kv[2],poscell,krowcell,kcolcell,ksqrcell);			
			  }
             }		 
	        }
	       }
		  }
		  if (change)
		  {
	       needconfirm=1;
		   if (curstep==dispstep)
		   {
            showrc_t(i*9,1);
            document.getElementById("oc"+(i*9+j1)).style.borderColor=sbuttoncolor;
            document.getElementById("oc"+(i*9+j2)).style.borderColor=sbuttoncolor;
            document.getElementById("oc"+(i*9+j3)).style.borderColor=sbuttoncolor;
		   }
           if (curstep==step)
           {		  
 	        addstep(false,"ntplr",""+i+","+j1+","+j2+","+j3+","+kv[0]+","+kv[1]+","+kv[2]);
	        addmsg('In row '+drow(i)+', these 3 cells '+dcell(i,j1)+', '+dcell(i,j2)+' and '+dcell(i,j3)+' together have 3 digits '+ddig(kv[0])+', '+ddig(kv[1])+' and '+ddig(kv[2])+' as candidates.  Therefore, these 3 digits must reside in one of these 3 cells respectively and cannot be possibilities in any other cells of this row.');
	        addmsgr('- Naked Triplet');
	        next2update();
		   } 
           break;
		  }
		  if (curstep<step) break;
	     }
        }
	    if (change || curstep<step) break;
       }
      }
	  if (change || curstep<step) break;
     }
    }
    if (change || curstep<step) break;
   } 
  } 

  if (!change && (curstep==step || (curstep<step && method=="ntplc")))
  {
   for(j=0;j<=8;j++)
   {
    if (curstep<step) j=cf1;
    if (colfill[j]<=4)   // change <=5 to <=4
    {
     for(i1=0;i1<=6;i1++)
     {
	  if (curstep<step) i1=cf2;
	  if (poscell[i1][j]<=3 && poscell[i1][j]>=2)
	  {
       for(i2=i1+1;i2<=7;i2++)
       {
	    if (curstep<step) i2=cf3;
	    if (poscell[i2][j]<=3 && poscell[i2][j]>=2)
	    {
         for(i3=i2+1;i3<=8;i3++)
         {	
	      if (curstep<step) i3=cf4;
	      if (poscell[i3][j]<=3 && poscell[i3][j]>=2)
          {
	       icount=0;
		   infostr="";
		   kv=[-1,-1,-1];
	       for(k=0;k<=8;k++)
	       {
	        if (a[i1][j][k]+a[i2][j][k]+a[i3][j][k]>0)
		    {
		     if (icount<3) kv[icount]=k;
		     icount++;
		     if (icount>3) break;
		     infostr+=(k+1);
		    } 
	       }
	       if (icount==3)
	       {	   
	        for(ii=0;ii<=8;ii++)
	        {
	         if(ii!=i1 && ii!=i2 && ii!=i3) 
		     {
     		  if (a[ii][j][kv[0]]!=0 || a[ii][j][kv[1]]!=0 || a[ii][j][kv[2]]!=0)
			  {
		       idx=ii*9+j;
		       change=true;
		       if (curstep==dispstep) rmval(idx,infostr,0);
		       if (a[ii][j][kv[0]]!=0) rmapos(a,ii,j,kv[0],poscell,krowcell,kcolcell,ksqrcell);
		       if (a[ii][j][kv[1]]!=0) rmapos(a,ii,j,kv[1],poscell,krowcell,kcolcell,ksqrcell);
		       if (a[ii][j][kv[2]]!=0) rmapos(a,ii,j,kv[2],poscell,krowcell,kcolcell,ksqrcell);			
			  }
             }		 
	        }
	       }
		  } 
		  if (change)
		  {
	       needconfirm=1;
		   if (curstep==dispstep)
		   {
            showrc_t(j,2);
            document.getElementById("oc"+(i1*9+j)).style.borderColor=sbuttoncolor;
            document.getElementById("oc"+(i2*9+j)).style.borderColor=sbuttoncolor;
            document.getElementById("oc"+(i3*9+j)).style.borderColor=sbuttoncolor;
		   }
           if (curstep==step)
           {		  
 	        addstep(false,"ntplc",""+j+","+i1+","+i2+","+i3+","+kv[0]+","+kv[1]+","+kv[2]);
	        addmsg('In column '+dcol(j)+', these 3 cells '+dcell(i1,j)+', '+dcell(i2,j)+' and '+dcell(i3,j)+' together have 3 digits '+ddig(kv[0])+', '+ddig(kv[1])+' and '+ddig(kv[2])+' as candidates.  Therefore, these 3 digits must reside in one of these 3 cells respectively and cannot be possibilities in any other cells of this column.');
	        addmsgr('- Naked Triplet');
	        next2update();
		   } 
           break;
		  }
		  if (curstep<step) break;
	     }
        }
	    if (change || curstep<step) break;
       }
      }
	  if (change || curstep<step) break;
     }
    }
    if (change || curstep<step) break;
   } 
  }

  if (!change && (curstep==step || (curstep<step && method=="ntpls")))
  {
   for(isqr=0;isqr<=8;isqr++)
   {
    if (curstep<step) isqr=cf1;
    if (sqrfill[isqr]<=4)    // change <=5 to <=4
    {
     for(index1=0;index1<=6;index1++)
     {
	  if (curstep<step) index1=cf2;
      i1=Math.floor(isqr/3)*3+Math.floor(index1/3);
      j1=(isqr%3)*3+index1%3;
      if (poscell[i1][j1]<=3 && poscell[i1][j1]>=2)
      {	
       for(index2=index1+1;index2<=7;index2++)
       {
	    if (curstep<step) index2=cf3;
        i2=Math.floor(isqr/3)*3+Math.floor(index2/3);
        j2=(isqr%3)*3+index2%3;
        if (poscell[i2][j2]<=3 && poscell[i2][j2]>=2)
        {	  
         for(index3=index2+1;index3<=8;index3++)
         {
	      if (curstep<step) index3=cf4;
          i3=Math.floor(isqr/3)*3+Math.floor(index3/3);
          j3=(isqr%3)*3+index3%3;      
	      if (poscell[i3][j3]<=3 && poscell[i3][j3]>=2)
          {
	       icount=0;
		   infostr="";
		   kv=[-1,-1,-1];
	       for(k=0;k<=8;k++)
	       {
	        if (a[i1][j1][k]+a[i2][j2][k]+a[i3][j3][k]>0)
		    {
		     if (icount<3) kv[icount]=k;
		     icount++;
		     if (icount>3) break;
		     infostr+=(k+1);
		    } 
	       }
	       if (icount==3)
	       {	   
	        for(nindex=0;nindex<=8;nindex++)
	        {
             ii=Math.floor(isqr/3)*3+Math.floor(nindex/3);
             jj=(isqr%3)*3+nindex%3;
	         if(nindex!=index1 && nindex!=index2 && nindex!=index3) 
		     {
     		  if (a[ii][jj][kv[0]]!=0 || a[ii][jj][kv[1]]!=0 || a[ii][jj][kv[2]]!=0)
			  {
		       idx=ii*9+jj;
		       change=true;
		       if (curstep==dispstep) rmval(idx,infostr,0);
		       if (a[ii][jj][kv[0]]!=0) rmapos(a,ii,jj,kv[0],poscell,krowcell,kcolcell,ksqrcell);
		       if (a[ii][jj][kv[1]]!=0) rmapos(a,ii,jj,kv[1],poscell,krowcell,kcolcell,ksqrcell);
		       if (a[ii][jj][kv[2]]!=0) rmapos(a,ii,jj,kv[2],poscell,krowcell,kcolcell,ksqrcell);			
			  }
             }		 
	        }
	       }
		  } 
		  if (change)
		  {
	       needconfirm=1;
		   if (curstep==dispstep)
		   {
            showrc_t(idx,3);
            document.getElementById("oc"+(i1*9+j1)).style.borderColor=sbuttoncolor;
            document.getElementById("oc"+(i2*9+j2)).style.borderColor=sbuttoncolor;
            document.getElementById("oc"+(i3*9+j3)).style.borderColor=sbuttoncolor;
		   }
           if (curstep==step)
           {		  
 	        addstep(false,"ntpls",""+isqr+","+index1+","+index2+","+index3+","+kv[0]+","+kv[1]+","+kv[2]);
	        addmsg('In square '+dsqr(isqr)+', these 3 cells '+dcell(i1,j1)+', '+dcell(i2,j2)+' and '+dcell(i3,j3)+' together have 3 digits '+ddig(kv[0])+', '+ddig(kv[1])+' and '+ddig(kv[2])+' as candidates.  Therefore, these 3 digits must reside in one of these 3 cells respectively and cannot be possibilities in any other cells of this square.');
	        addmsgr('- Naked Triplet');
	        next2update();
		   } 
           break;
		  }
		  if (curstep<step) break;
	     }
        }
	    if (change || curstep<step) break;
       }
      }
	  if (change || curstep<step) break;
     }
    }
    if (change || curstep<step) break;
   }	
  } 
 }
 return change;
}

function nquad(a,poscell,krowcell,kcolcell,ksqrcell)
{
 var i,j,i1,i2,i3,i4,j1,j2,j3,j4,k,ii,jj,kk,idx,isqr,index1,index2,index3,index4,nindex;
 var kv=new Array(-1,-1,-1,-1),icount=0,change=false,infostr="",method="";
 resetrcclr_t();
 fillpos(80);
 if (curstep<step)
 {
  method=solvedsqn[curstep].substr(0,solvedsqn[curstep].indexOf(":"));
  var cellinfo=solvedsqn[curstep].substr(solvedsqn[curstep].indexOf(":")+1);	
  var cf1=cellinfo.substr(0,1)*1, cf2=cellinfo.substr(2,1)*1, cf3=cellinfo.substr(4,1)*1, cf4=cellinfo.substr(6,1)*1, cf5=cellinfo.substr(8,1)*1;
  var cf6=cellinfo.substr(10,1)*1, cf7=cellinfo.substr(12,1)*1, cf8=cellinfo.substr(14,1)*1, cf9=cellinfo.substr(16,1)*1;
 }
 if (curstep<dispstep)
 {
  switch (method)
  {
   case "nquadr":
     for (i=0;i<9;i++)
	 {
	  if (i!=cf2 && i!=cf3 && i!=cf4 && i!=cf5)
	  {
	   if (a[cf1][i][cf6]==1) rmapos(a,cf1,i,cf6,poscell,krowcell,kcolcell,ksqrcell);
	   if (a[cf1][i][cf7]==1) rmapos(a,cf1,i,cf7,poscell,krowcell,kcolcell,ksqrcell);
	   if (a[cf1][i][cf8]==1) rmapos(a,cf1,i,cf8,poscell,krowcell,kcolcell,ksqrcell);
	   if (a[cf1][i][cf9]==1) rmapos(a,cf1,i,cf9,poscell,krowcell,kcolcell,ksqrcell);
	  }
	 }
	 break;
   case "nquadc":
     for (i=0;i<9;i++)
	 {
	  if (i!=cf2 && i!=cf3 && i!=cf4 && i!=cf5)
	  {
	   if (a[i][cf1][cf6]==1) rmapos(a,i,cf1,cf6,poscell,krowcell,kcolcell,ksqrcell);
	   if (a[i][cf1][cf7]==1) rmapos(a,i,cf1,cf7,poscell,krowcell,kcolcell,ksqrcell);
	   if (a[i][cf1][cf8]==1) rmapos(a,i,cf1,cf8,poscell,krowcell,kcolcell,ksqrcell);
	   if (a[i][cf1][cf9]==1) rmapos(a,i,cf1,cf9,poscell,krowcell,kcolcell,ksqrcell);
	  }
	 }
	 break;
   case "nquads":
     for (i=0;i<9;i++)
	 {
	  if (i!=cf2 && i!=cf3 && i!=cf4 && i!=cf5)
	  {
       ii=Math.floor(cf1/3)*3+Math.floor(i/3);
       jj=(cf1%3)*3+i%3
	   if (a[ii][jj][cf6]==1) rmapos(a,ii,jj,cf6,poscell,krowcell,kcolcell,ksqrcell);
	   if (a[ii][jj][cf7]==1) rmapos(a,ii,jj,cf7,poscell,krowcell,kcolcell,ksqrcell);
	   if (a[ii][jj][cf8]==1) rmapos(a,ii,jj,cf8,poscell,krowcell,kcolcell,ksqrcell);
	   if (a[ii][jj][cf9]==1) rmapos(a,ii,jj,cf9,poscell,krowcell,kcolcell,ksqrcell);
	  }
	 }
	 break;
  }
  needconfirm=1;
  change=true;
 }
 else
 {
  if (curstep==step || (curstep<step && method=="nquadr"))
  {
   for(i=0;i<=8;i++)
   {
    if (curstep<step) i=cf1;
    if (rowfill[i]<=3)   
    {
     for(j1=0;j1<=5;j1++)
     {
      if (curstep<step) j1=cf2;
      if (poscell[i][j1]<=4 && poscell[i][j1]>=2)
	  {
       for(j2=j1+1;j2<=6;j2++)
       {
        if (curstep<step) j2=cf3;
	    if (poscell[i][j2]<=4 && poscell[i][j2]>=2)
	    {
         for(j3=j2+1;j3<=7;j3++)
         { 
          if (curstep<step) j3=cf4;
	      if (poscell[i][j3]<=4 && poscell[i][j3]>=2)
          {
           for(j4=j3+1;j4<=8;j4++)
           { 
            if (curstep<step) j4=cf5;
	        if (poscell[i][j4]<=4 && poscell[i][j4]>=2)
            {
	         icount=0;
		     infostr="";
		     kv=[-1,-1,-1,-1];
	         for(k=0;k<=8;k++)
	         {
	          if(a[i][j1][k]+a[i][j2][k]+a[i][j3][k]+a[i][j4][k]>0) 
		      {
		       if (icount<4) kv[icount]=k;
		       icount++;
		       if (icount>4) break;
		       infostr+=(k+1);
		      } 
	         }
	         if (icount==4)
	         {	   
	          for(jj=0;jj<=8;jj++)
	          {
	           if (jj!=j1 && jj!=j2 && jj!=j3 && jj!=j4) 
		       {
     		    if (a[i][jj][kv[0]]!=0 || a[i][jj][kv[1]]!=0 || a[i][jj][kv[2]]!=0 || a[i][jj][kv[3]]!=0)
			    {
		         idx=i*9+jj;
		         change=true;
		         if (curstep==dispstep) rmval(idx,infostr,0);
		         if (a[i][jj][kv[0]]!=0) rmapos(a,i,jj,kv[0],poscell,krowcell,kcolcell,ksqrcell);
		         if (a[i][jj][kv[1]]!=0) rmapos(a,i,jj,kv[1],poscell,krowcell,kcolcell,ksqrcell);
		         if (a[i][jj][kv[2]]!=0) rmapos(a,i,jj,kv[2],poscell,krowcell,kcolcell,ksqrcell);			
		         if (a[i][jj][kv[3]]!=0) rmapos(a,i,jj,kv[3],poscell,krowcell,kcolcell,ksqrcell);			
			    }
               }		 
	          }
	         }
		    }
		    if (change)
		    {
	         needconfirm=1;
		     if (curstep==dispstep)
		     {
              showrc_t(i*9,1);
              document.getElementById("oc"+(i*9+j1)).style.borderColor=sbuttoncolor;
              document.getElementById("oc"+(i*9+j2)).style.borderColor=sbuttoncolor;
              document.getElementById("oc"+(i*9+j3)).style.borderColor=sbuttoncolor;
              document.getElementById("oc"+(i*9+j4)).style.borderColor=sbuttoncolor;
		     }
             if (curstep==step)
             {		  
 	          addstep(false,"nquadr",""+i+","+j1+","+j2+","+j3+","+j4+","+kv[0]+","+kv[1]+","+kv[2]+","+kv[3]);
	          addmsg('In row '+drow(i)+', these 4 cells '+dcell(i,j1)+', '+dcell(i,j2)+', '+dcell(i,j3)+' and '+dcell(i,j4)+' together have 4 digits '+ddig(kv[0])+', '+ddig(kv[1])+', '+ddig(kv[2])+' and '+ddig(kv[3])+' as candidates.  Therefore, these 4 digits must reside in one of these 4 cells respectively and cannot be possibilities in any other cells of this row.');
	          addmsgr('- Naked Quad');
	          next2update();
		     } 
             break;
		    }
		    if (curstep<step) break;
	       }
          }
	      if (change || curstep<step) break;
         }
        }
	    if (change || curstep<step) break;
       }
      }
	  if (change || curstep<step) break;
     }
    }
    if (change || curstep<step) break;
   } 
  } 

  if (!change && (curstep==step || (curstep<step && method=="nquadc")))
  {
   for(j=0;j<=8;j++)
   {
    if (curstep<step) j=cf1;
    if (colfill[j]<=3)  
    {
     for(i1=0;i1<=5;i1++)
     {
	  if (curstep<step) i1=cf2;
	  if (poscell[i1][j]<=4 && poscell[i1][j]>=2)
	  {
       for(i2=i1+1;i2<=6;i2++)
       {
	    if (curstep<step) i2=cf3;
	    if (poscell[i2][j]<=4 && poscell[i2][j]>=2)
	    {
         for(i3=i2+1;i3<=7;i3++)
         {	
	      if (curstep<step) i3=cf4;
	      if (poscell[i3][j]<=4 && poscell[i3][j]>=2)
          {
           for(i4=i3+1;i4<=8;i4++)
           {	
	        if (curstep<step) i4=cf5;
	        if (poscell[i4][j]<=4 && poscell[i4][j]>=2)
            {
	         icount=0;
		     infostr="";
		     kv=[-1,-1,-1,-1];
	         for(k=0;k<=8;k++)
	         {
	          if (a[i1][j][k]+a[i2][j][k]+a[i3][j][k]+a[i4][j][k]>0)
		      {
		       if (icount<4) kv[icount]=k;
		       icount++;
		       if (icount>4) break;
		       infostr+=(k+1);
		      } 
	         }
	         if (icount==4)
	         {	   
	          for(ii=0;ii<=8;ii++)
	          {
	           if(ii!=i1 && ii!=i2 && ii!=i3 && ii!=i4) 
		       {
     		    if (a[ii][j][kv[0]]!=0 || a[ii][j][kv[1]]!=0 || a[ii][j][kv[2]]!=0 || a[ii][j][kv[3]]!=0)
			    {
		         idx=ii*9+j;
		         change=true;
		         if (curstep==dispstep) rmval(idx,infostr,0);
		         if (a[ii][j][kv[0]]!=0) rmapos(a,ii,j,kv[0],poscell,krowcell,kcolcell,ksqrcell);
		         if (a[ii][j][kv[1]]!=0) rmapos(a,ii,j,kv[1],poscell,krowcell,kcolcell,ksqrcell);
		         if (a[ii][j][kv[2]]!=0) rmapos(a,ii,j,kv[2],poscell,krowcell,kcolcell,ksqrcell);			
		         if (a[ii][j][kv[3]]!=0) rmapos(a,ii,j,kv[3],poscell,krowcell,kcolcell,ksqrcell);			
			    }
               }		 
	          }
	         }
		    } 
		    if (change)
		    {
	         needconfirm=1;
		     if (curstep==dispstep)
		     {
              showrc_t(j,2);
              document.getElementById("oc"+(i1*9+j)).style.borderColor=sbuttoncolor;
              document.getElementById("oc"+(i2*9+j)).style.borderColor=sbuttoncolor;
              document.getElementById("oc"+(i3*9+j)).style.borderColor=sbuttoncolor;
              document.getElementById("oc"+(i4*9+j)).style.borderColor=sbuttoncolor;
		     }
             if (curstep==step)
             {		  
 	          addstep(false,"nquadc",""+j+","+i1+","+i2+","+i3+","+i4+","+kv[0]+","+kv[1]+","+kv[2]+","+kv[3]);
	          addmsg('In column '+dcol(j)+', these 4 cells '+dcell(i1,j)+', '+dcell(i2,j)+', '+dcell(i3,j)+' and '+dcell(i4,j)+' together have 4 digits '+ddig(kv[0])+', '+ddig(kv[1])+', '+ddig(kv[2])+' and '+ddig(kv[3])+' as candidates.  Therefore, these 4 digits must reside in one of these 4 cells respectively and cannot be possibilities in any other cells of this column.');
	          addmsgr('- Naked Quad');
	          next2update();
		     } 
             break;
		    }
		    if (curstep<step) break;
	       }
          }
	      if (change || curstep<step) break;
         }
        }
	    if (change || curstep<step) break;
       }
      }
	  if (change || curstep<step) break;
     }
    }
    if (change || curstep<step) break;
   } 
  }

  if (!change && (curstep==step || (curstep<step && method=="nquads")))
  {
   for(isqr=0;isqr<=8;isqr++)
   {
    if (curstep<step) isqr=cf1;
    if (sqrfill[isqr]<=3) 
    {
     for(index1=0;index1<=5;index1++)
     {
	  if (curstep<step) index1=cf2;
      i1=Math.floor(isqr/3)*3+Math.floor(index1/3);
      j1=(isqr%3)*3+index1%3;
      if (poscell[i1][j1]<=4 && poscell[i1][j1]>=2)
      {	
       for(index2=index1+1;index2<=6;index2++)
       {
	    if (curstep<step) index2=cf3;
        i2=Math.floor(isqr/3)*3+Math.floor(index2/3);
        j2=(isqr%3)*3+index2%3;
        if (poscell[i2][j2]<=4 && poscell[i2][j2]>=2)
        {	  
         for(index3=index2+1;index3<=7;index3++)
         {
	      if (curstep<step) index3=cf4;
          i3=Math.floor(isqr/3)*3+Math.floor(index3/3);
          j3=(isqr%3)*3+index3%3;      
	      if (poscell[i3][j3]<=4 && poscell[i3][j3]>=2)
          {
           for(index4=index3+1;index4<=8;index4++)
           {
	        if (curstep<step) index4=cf5;
            i4=Math.floor(isqr/3)*3+Math.floor(index4/3);
            j4=(isqr%3)*3+index4%3;      
	        if (poscell[i4][j4]<=4 && poscell[i4][j4]>=2)
            {
	         icount=0;
		     infostr="";
		     kv=[-1,-1,-1,-1];
	         for(k=0;k<=8;k++)
	         {
	          if (a[i1][j1][k]+a[i2][j2][k]+a[i3][j3][k]+a[i4][j4][k]>0)
		      {
		       if (icount<4) kv[icount]=k;
		       icount++;
		       if (icount>4) break;
		       infostr+=(k+1);
		      } 
	         }
	         if (icount==4)
	         {	   
	          for(nindex=0;nindex<=8;nindex++)
	          {
               ii=Math.floor(isqr/3)*3+Math.floor(nindex/3);
               jj=(isqr%3)*3+nindex%3;
	           if(nindex!=index1 && nindex!=index2 && nindex!=index3 && nindex!=index4) 
		       {
     		    if (a[ii][jj][kv[0]]!=0 || a[ii][jj][kv[1]]!=0 || a[ii][jj][kv[2]]!=0 || a[ii][jj][kv[3]]!=0)
			    {
		         idx=ii*9+jj;
		         change=true;
		         if (curstep==dispstep) rmval(idx,infostr,0);
		         if (a[ii][jj][kv[0]]!=0) rmapos(a,ii,jj,kv[0],poscell,krowcell,kcolcell,ksqrcell);
		         if (a[ii][jj][kv[1]]!=0) rmapos(a,ii,jj,kv[1],poscell,krowcell,kcolcell,ksqrcell);
		         if (a[ii][jj][kv[2]]!=0) rmapos(a,ii,jj,kv[2],poscell,krowcell,kcolcell,ksqrcell);			
		         if (a[ii][jj][kv[3]]!=0) rmapos(a,ii,jj,kv[3],poscell,krowcell,kcolcell,ksqrcell);			
			    }
               }		 
	          }
	         }
		    } 
		    if (change)
		    {
	         needconfirm=1;
		     if (curstep==dispstep)
		     {
              showrc_t(idx,3);
              document.getElementById("oc"+(i1*9+j1)).style.borderColor=sbuttoncolor;
              document.getElementById("oc"+(i2*9+j2)).style.borderColor=sbuttoncolor;
              document.getElementById("oc"+(i3*9+j3)).style.borderColor=sbuttoncolor;
              document.getElementById("oc"+(i4*9+j4)).style.borderColor=sbuttoncolor;
		     }
             if (curstep==step)
             {		  
 	          addstep(false,"nquads",""+isqr+","+index1+","+index2+","+index3+","+index4+","+kv[0]+","+kv[1]+","+kv[2]+","+kv[3]);
	          addmsg('In square '+dsqr(isqr)+', these 4 cells '+dcell(i1,j1)+', '+dcell(i2,j2)+', '+dcell(i3,j3)+' and '+dcell(i4,j4)+' together have 4 digits '+ddig(kv[0])+', '+ddig(kv[1])+', '+ddig(kv[2])+' and '+ddig(kv[3])+' as candidates.  Therefore, these 4 digits must reside in one of these 4 cells respectively and cannot be possibilities in any other cells of this square.');
	          addmsgr('- Naked Quad');
	          next2update();
		     } 
             break;
		    }
		    if (curstep<step) break;
	       }
          }
	      if (change || curstep<step) break;
         }
        }
	    if (change || curstep<step) break;
       }
      }
	  if (change || curstep<step) break;
     }
    }
    if (change || curstep<step) break;
   }	
  } 
 }
 return change;
}

function hdbl(a,poscell,krowcell,kcolcell,ksqrcell)
{
 var i,j,k1,k2,k,jj,kk,idx,i1,j1,i2,j2,iv1=-1,iv2=-1,jv1=-1,jv2=-1,match=false,change=false,infostr="",method="";
 resetrcclr_t();
 fillpos(80);
 if (curstep<step)
 {
  method=solvedsqn[curstep].substr(0,solvedsqn[curstep].indexOf(":"));
  var cellinfo=solvedsqn[curstep].substr(solvedsqn[curstep].indexOf(":")+1);	
  var cf1=cellinfo.substr(0,1)*1, cf2=cellinfo.substr(2,1)*1, cf3=cellinfo.substr(4,1)*1;
  var cf4=cellinfo.substr(6,1)*1, cf5=cellinfo.substr(8,1)*1;
  if (method=="hdbls") var cf6=cellinfo.substr(10,1)*1, cf7=cellinfo.substr(12,1)*1;
 }
 if (curstep<dispstep)
 {
  switch (method)
  {
   case "hdblr":
     for (k=0;k<9;k++)
	 {
	  if (k!=cf2 && k!=cf3)
	  {
	   if (a[cf1][cf4][k]==1) rmapos(a,cf1,cf4,k,poscell,krowcell,kcolcell,ksqrcell);
	   if (a[cf1][cf5][k]==1) rmapos(a,cf1,cf5,k,poscell,krowcell,kcolcell,ksqrcell);
	  }
	 }
	 break;
   case "hdblc":
     for (k=0;k<9;k++)
	 {
	  if (k!=cf2 && k!=cf3)
	  {
	   if (a[cf4][cf1][k]==1) rmapos(a,cf4,cf1,k,poscell,krowcell,kcolcell,ksqrcell);
	   if (a[cf5][cf1][k]==1) rmapos(a,cf5,cf1,k,poscell,krowcell,kcolcell,ksqrcell);
	  }
	 }
	 break;
   case "hdbls":
     for (k=0;k<9;k++)
	 {
	  if (k!=cf2 && k!=cf3)
	  {
	   if (a[cf4][cf5][k]==1) rmapos(a,cf4,cf5,k,poscell,krowcell,kcolcell,ksqrcell);
	   if (a[cf6][cf7][k]==1) rmapos(a,cf6,cf7,k,poscell,krowcell,kcolcell,ksqrcell);
	  }
	 }
	 break;
  }
  needconfirm=1;
  change=true;
 }
 else
 {
  for(i=0;i<=8;i++)
  {
   if (curstep<step) i=cf1;
   if (curstep==step || (curstep<step && method=="hdblr"))
   {
    if (rowfill[i]<=5)   // change <=6  to <=5
    {
     for(k1=0;k1<=7;k1++)
     {
      if (curstep<step) k1=cf2;	
      if (krowcell[i][k1]==2)
      {
       for(k2=k1+1;k2<=8;k2++)
       {
        if (curstep<step) k2=cf3;	  
        match=false;
	    if (krowcell[i][k2]==2)
        {
	     match=true;
	     infostr=""+(k1+1)+(k2+1);
	     jv1=-1;
	     jv2=-1;
	     for(j=0;j<=8;j++)
	     {
	      if(a[i][j][k1]!=a[i][j][k2]) 
	      {
	       match=false;
		   infostr="";
		   break;
	      }
          else if (a[i][j][k1]>0) 
		  {
		   if (jv1<0) jv1=j;
		   else jv2=j;
		  }
	     }
	     if (match && (poscell[i][jv1]>2 || poscell[i][jv2]>2))
	     {
	      change=true;
		  idx=i*9+jv1;
		  if (poscell[i][jv1]>2)
		  {
		   for (kk=0;kk<9;kk++)
		   {
            if (kk!=k1 && kk!=k2 && a[i][jv1][kk]!=0) rmapos(a,i,jv1,kk,poscell,krowcell,kcolcell,ksqrcell);
           }		   
	      }
		  if (curstep==dispstep)
		  {
           kpval(idx,infostr,1);
		   hlnumber(idx,infostr);
		  } 
		  idx=i*9+jv2;
		  if (poscell[i][jv2]>2)
		  {
		   for (kk=0;kk<9;kk++)
		   {
            if (kk!=k1 && kk!=k2 && a[i][jv2][kk]!=0) rmapos(a,i,jv2,kk,poscell,krowcell,kcolcell,ksqrcell);
           }		   
	      }
		  if (curstep==dispstep)
		  {
           kpval(idx,infostr,1);
		   hlnumber(idx,infostr);
		  } 
	      needconfirm=1;
          if (curstep==dispstep) showrc_t(i*9,1);
		  if (curstep==step)
		  {
	       addstep(false,"hdblr",""+i+","+k1+","+k2+","+jv1+","+jv2);
	       addmsg('In row '+drow(i)+', digits "'+ddig(k1)+'" and "'+ddig(k2)+'" are candidates for exactly the same 2 cells '+dcell(i,jv1)+' and '+dcell(i,jv2)+'.  Therefore, these 2 digits must reside in one of these 2 cells respectively and other possibilities in these 2 cells can be removed.');
	       addmsgr('- Hidden Double');
	       next2update();
		  } 
	     }
        }	
	    if (change || curstep<step) break; 
       }
      }
      if (change || curstep<step) break;   
     }
    }	
   }

   if (change) break;
  
   if (curstep==step || (curstep<step && method=="hdblc"))
   {
    if (colfill[i]<=5)   // change <=6 to <=5
    {
     for(k1=0;k1<=7;k1++)
     { 
	  if (curstep<step) k1=cf2;
      if (kcolcell[i][k1]==2)
      {
       for(k2=k1+1;k2<=8;k2++)
       {	
	    if (curstep<step) k2=cf3;
        match=false;
	    if (kcolcell[i][k2]==2)
        {
	     match=true;
	     infostr=""+(k1+1)+(k2+1);
	     jv1=-1;
	     jv2=-1;
	     for(j=0;j<=8;j++)
	     {
	      if(a[j][i][k1]!=a[j][i][k2]) 
	      {
	       match=false;
		   infostr="";
		   break;
	      }
          else if (a[j][i][k1]>0) 
		  {
		   if (jv1<0) jv1=j;
		   else jv2=j;
		  }
	     }
	     if (match && (poscell[jv1][i]>2 || poscell[jv2][i]>2))
	     {
	      change=true;
		  idx=jv1*9+i;
		  if (poscell[jv1][i]>2)
		  {
		   for (kk=0;kk<9;kk++)
		   {
            if (kk!=k1 && kk!=k2 && a[jv1][i][kk]!=0) rmapos(a,jv1,i,kk,poscell,krowcell,kcolcell,ksqrcell);
           } 		   
	      }
		  if (curstep==dispstep)
		  {
           kpval(idx,infostr,1);
		   hlnumber(idx,infostr);
		  } 
		  idx=jv2*9+i;
		  if (poscell[jv2][i]>2)
		  {
		   for (kk=0;kk<9;kk++)
		   {
            if (kk!=k1 && kk!=k2 && a[jv2][i][kk]!=0) rmapos(a,jv2,i,kk,poscell,krowcell,kcolcell,ksqrcell);
           }		   
	      }
		  if (curstep==dispstep)
		  {
           kpval(idx,infostr,1);
		   hlnumber(idx,infostr);
		  } 
	      needconfirm=1;
		  if (curstep==dispstep) showrc_t(i,2);
		  if (curstep==step)
		  {
	       addstep(false,"hdblc",""+i+","+k1+","+k2+","+jv1+","+jv2);
	       addmsg('In column '+dcol(i)+', digits "'+ddig(k1)+'" and "'+ddig(k2)+'" are candidates for exactly the same 2 cells '+dcell(jv1,i)+' and '+dcell(jv2,i)+'.  Therefore, these 2 digits must reside in one of these 2 cells respectively and other possibilities in these 2 cells can be removed.');
	       addmsgr('- Hidden Double');
	       next2update();
		  } 
	     }
        }	
	    if (change || curstep<step) break; 
       }
      }
      if (change || curstep<step) break;   
     }
    }	
   }  

   if (change) break;
  
   if (curstep==step || (curstep<step && method=="hdbls"))
   {
    if (sqrfill[i]<=5)     // change <=6 to <=5
    {
     for(k1=0;k1<=7;k1++)
     { 
	  if (curstep<step) k1=cf2;
      if (ksqrcell[i][k1]==2)
      {
       for(k2=k1+1;k2<=8;k2++)
       {	
	    if (curstep<step) k2=cf3;
        match=false;
	    if (ksqrcell[i][k2]==2)
        {
	     match=true;
	     infostr=""+(k1+1)+(k2+1);
         iv1=-1;
	     iv2=-1;
	     jv1=-1;
	     jv2=-1;
	     for(j=0;j<=8;j++)
	     {
	      i1=Math.floor(i/3)*3+Math.floor(j/3);
		  j1=(i%3)*3+j%3
	      if(a[i1][j1][k1]!=a[i1][j1][k2]) 
	      {
	       match=false;
		   infostr="";
		   break;
	      }
          else if (a[i1][j1][k1]>0) 
		  {
		   if (jv1<0) 
		   {
		    iv1=i1;
		    jv1=j1;
		   } 
		   else
		   {
		    iv2=i1;
		    jv2=j1;
		   } 
		  }
	     }
	     if (match && (poscell[iv1][jv1]>2 || poscell[iv2][jv2]>2))
	     {
	      change=true;
		  idx=iv1*9+jv1;
		  if (poscell[iv1][jv1]>2)
		  {
		   for (kk=0;kk<9;kk++)
		   {
            if (kk!=k1 && kk!=k2 && a[iv1][jv1][kk]!=0) rmapos(a,iv1,jv1,kk,poscell,krowcell,kcolcell,ksqrcell);
           }		   
	      }
		  if (curstep==dispstep)
		  {
           kpval(idx,infostr,1);
		   hlnumber(idx,infostr);
		  } 
		  idx=iv2*9+jv2;
		  if (poscell[iv2][jv2]>2)
		  {
		   for (kk=0;kk<9;kk++)
		   {
            if (kk!=k1 && kk!=k2 && a[iv2][jv2][kk]!=0) rmapos(a,iv2,jv2,kk,poscell,krowcell,kcolcell,ksqrcell);
           }		   
	      }
		  if (curstep==dispstep)
		  {
           kpval(idx,infostr,1);
		   hlnumber(idx,infostr);
		  } 
	      needconfirm=1;
          if (curstep==dispstep) showrc_t(idx,3);
		  if (curstep==step)
		  {
	       addstep(false,"hdbls",""+i+","+k1+","+k2+","+iv1+","+jv1+","+iv2+","+jv2);
	       addmsg('In square '+dsqr(i)+', digits "'+ddig(k1)+'" and "'+ddig(k2)+'" are candidates for exactly the same 2 cells '+dcell(iv1,jv1)+' and '+dcell(iv2,jv2)+'.  Therefore, these 2 digits must reside in one of these 2 cells respectively and other possibilities in these 2 cells can be removed.');
	       addmsgr('- Hidden Double');
	       next2update();
		  } 
	     }
        }	
	    if (change || curstep<step) break;
       }
      }
      if (change || curstep<step) break;   
     }
    }
   }   
   if (change || curstep<step) break;
  }
 } 
 return change;
}

function htpl(a,poscell,krowcell,kcolcell,ksqrcell)
{
 var i,j,i1,i2,i3,j1,j2,j3,k,k1,k2,k3,ii,jj,kk,idx,isqr,index1,index2,index3,nindex,iv=new Array(-1,-1,-1),jv=new Array(-1,-1,-1),icount=0,change=false,infostr="",method="";
 resetrcclr_t();
 fillpos(80);
 if (curstep<step)
 {
  method=solvedsqn[curstep].substr(0,solvedsqn[curstep].indexOf(":"));
  var cellinfo=solvedsqn[curstep].substr(solvedsqn[curstep].indexOf(":")+1);	
  var cf1=cellinfo.substr(0,1)*1, cf2=cellinfo.substr(2,1)*1, cf3=cellinfo.substr(4,1)*1, cf4=cellinfo.substr(6,1)*1;
  var cf5=cellinfo.substr(8,1)*1, cf6=cellinfo.substr(10,1)*1, cf7=cellinfo.substr(12,1)*1;
  if (method=="htpls") var cf8=cellinfo.substr(14,1)*1, cf9=cellinfo.substr(16,1)*1, cf10=cellinfo.substr(18,1)*1;
 }
 if (curstep<dispstep)
 {
  switch (method)
  {
   case "htplr":
     for (k=0;k<9;k++)
	 {
	  if (k!=cf2 && k!=cf3 && k!=cf4)
	  {
	   if (a[cf1][cf5][k]==1) rmapos(a,cf1,cf5,k,poscell,krowcell,kcolcell,ksqrcell);
	   if (a[cf1][cf6][k]==1) rmapos(a,cf1,cf6,k,poscell,krowcell,kcolcell,ksqrcell);
	   if (a[cf1][cf7][k]==1) rmapos(a,cf1,cf7,k,poscell,krowcell,kcolcell,ksqrcell);
	  }
	 }
	 break;
   case "htplc":
     for (k=0;k<9;k++)
	 {
	  if (k!=cf2 && k!=cf3 && k!=cf4)
	  {
	   if (a[cf5][cf1][k]==1) rmapos(a,cf5,cf1,k,poscell,krowcell,kcolcell,ksqrcell);
	   if (a[cf6][cf1][k]==1) rmapos(a,cf6,cf1,k,poscell,krowcell,kcolcell,ksqrcell);
	   if (a[cf7][cf1][k]==1) rmapos(a,cf7,cf1,k,poscell,krowcell,kcolcell,ksqrcell);
	  }
	 }
	 break;
   case "htpls":
     for (k=0;k<9;k++)
	 {
	  if (k!=cf2 && k!=cf3 && k!=cf4)
	  {
	   if (a[cf5][cf6][k]==1) rmapos(a,cf5,cf6,k,poscell,krowcell,kcolcell,ksqrcell);
	   if (a[cf7][cf8][k]==1) rmapos(a,cf7,cf8,k,poscell,krowcell,kcolcell,ksqrcell);
	   if (a[cf9][cf10][k]==1) rmapos(a,cf9,cf10,k,poscell,krowcell,kcolcell,ksqrcell);
	  }
	 }
	 break;
  }
  needconfirm=1;
  change=true;
 }
 else
 {
  if (curstep==step || (curstep<step && method=="htplr"))
  {
   for(i=0;i<=8;i++)
   {
    if (curstep<step) i=cf1;
    if (rowfill[i]<=4)    // change <=5 to <=4
    {
     for(k1=0;k1<=6;k1++)
     {
      if (curstep<step) k1=cf2;
      if (krowcell[i][k1]<=3 && krowcell[i][k1]>=2)
	  {
       for(k2=k1+1;k2<=7;k2++)
       {
        if (curstep<step) k2=cf3;
	    if (krowcell[i][k2]<=3 && krowcell[i][k2]>=2)
	    {
         for(k3=k2+1;k3<=8;k3++)
         { 
          if (curstep<step) k3=cf4;
	      if (krowcell[i][k3]<=3 && krowcell[i][k3]>=2)
          {
	       icount=0;
		   infostr=""+(k1+1)+(k2+1)+(k3+1);
		   jv=[-1,-1,-1];
	       for(j=0;j<=8;j++)
	       {
	        if(a[i][j][k1]+a[i][j][k2]+a[i][j][k3]>0) 
		    {
		     if (icount<3) jv[icount]=j;
		     icount++;
		     if (icount>3) break;
		    } 
	       }
	       if (icount==3)
	       {	   
	        for(kk=0;kk<=8;kk++)
	        {
	         if (kk!=k1 && kk!=k2 && kk!=k3 && (a[i][jv[0]][kk]!=0 || a[i][jv[1]][kk]!=0 || a[i][jv[2]][kk]!=0))
		     {
		      change=true;
		      if (a[i][jv[0]][kk]!=0) rmapos(a,i,jv[0],kk,poscell,krowcell,kcolcell,ksqrcell);
		      if (a[i][jv[1]][kk]!=0) rmapos(a,i,jv[1],kk,poscell,krowcell,kcolcell,ksqrcell);
		      if (a[i][jv[2]][kk]!=0) rmapos(a,i,jv[2],kk,poscell,krowcell,kcolcell,ksqrcell);			
             }		 
	        }
	       }
	 	  }
		  if (change)
		  {
	       needconfirm=1;
		   if (curstep==dispstep)
		   {
            showrc_t(i*9,1);
		    for (ii=0;ii<3;ii++)
		    {
		     idx=i*9+jv[ii];
		     kpval(idx,infostr,1);
		     hlnumber(idx,infostr);
		    }
		   } 
           if (curstep==step)
           {		  
	        addstep(false,"htplr",""+i+","+k1+","+k2+","+k3+","+jv[0]+","+jv[1]+","+jv[2]);
	        addmsg('In row '+drow(i)+', only 3 cells '+dcell(i,jv[0])+', '+dcell(i,jv[1])+' and '+dcell(i,jv[2])+' may have digits "'+ddig(k1)+'", "'+ddig(k2)+'" and "'+ddig(k3)+'" as candidates.  Therefore, these 3 digits must reside in one of these 3 cells respectively and other possibilities in these 3 cells can be removed.');
	        addmsgr('- Hidden Triplet');
	        next2update();
		   } 
		  }
		  if (change || curstep<step) break;
	     }
        }
	    if (change || curstep<step) break;
       }
      }
	  if (change || curstep<step) break;
     }
    }
    if (change || curstep<step) break;
   } 
  } 
 
  if (!change && (curstep==step || (curstep<step && method=="htplc")))
  {
   for(j=0;j<=8;j++)
   {
    if (curstep<step) j=cf1;
    if (colfill[j]<=4)    // change <=5 to <=4
    {
     for(k1=0;k1<=6;k1++)
     {
      if (curstep<step) k1=cf2;
      if (kcolcell[j][k1]<=3 && kcolcell[j][k1]>=2)
	  {
       for(k2=k1+1;k2<=7;k2++)
       {
        if (curstep<step) k2=cf3;
	    if (kcolcell[j][k2]<=3 && kcolcell[j][k2]>=2)
	    {
         for(k3=k2+1;k3<=8;k3++)
         { 
          if (curstep<step) k3=cf4;
	      if (kcolcell[j][k3]<=3 && kcolcell[j][k3]>=2)
          {
	       icount=0;
		   infostr=""+(k1+1)+(k2+1)+(k3+1);
		   iv=[-1,-1,-1];
	       for(i=0;i<=8;i++)
	       {
	        if(a[i][j][k1]+a[i][j][k2]+a[i][j][k3]>0) 
		    {
		     if (icount<3) iv[icount]=i;
		     icount++;
		     if (icount>3) break;
		    } 
	       }
	       if (icount==3)
	       {	   
	        for(kk=0;kk<=8;kk++)
	        {
	         if (kk!=k1 && kk!=k2 && kk!=k3 && (a[iv[0]][j][kk]!=0 || a[iv[1]][j][kk]!=0 || a[iv[2]][j][kk]!=0))
		     {
		      change=true;
		      if (a[iv[0]][j][kk]!=0) rmapos(a,iv[0],j,kk,poscell,krowcell,kcolcell,ksqrcell);
		      if (a[iv[1]][j][kk]!=0) rmapos(a,iv[1],j,kk,poscell,krowcell,kcolcell,ksqrcell);
		      if (a[iv[2]][j][kk]!=0) rmapos(a,iv[2],j,kk,poscell,krowcell,kcolcell,ksqrcell);			
             }		 
	        }
	       }
		  }
		  if (change)
		  {
	       needconfirm=1;
		   if (curstep==dispstep)
		   {
            showrc_t(j,2);
		    for (ii=0;ii<3;ii++)
		    {
		     idx=iv[ii]*9+j;
		     kpval(idx,infostr,1);
		     hlnumber(idx,infostr);
		    }
		   }
           if (curstep==step)
           {		  
	        addstep(false,"htplc",""+j+","+k1+","+k2+","+k3+","+iv[0]+","+iv[1]+","+iv[2]);
	        addmsg('In column '+dcol(j)+', only 3 cells '+dcell(iv[0],j)+', '+dcell(iv[1],j)+' and '+dcell(iv[2],j)+' may have digits "'+ddig(k1)+'", "'+ddig(k2)+'" and "'+ddig(k3)+'" as candidates.  Therefore, these 3 digits must reside in one of these 3 cells respectively and other possibilities in these 3 cells can be removed.');
	        addmsgr('- Hidden Triplet');
	        next2update();
		   } 
		  }
	      if (change || curstep<step) break;
	     }
        }
	    if (change || curstep<step) break;
       }
      }
	  if (change || curstep<step) break;
     }
    }
    if (change || curstep<step) break;
   } 
  }
 
  if (!change && (curstep==step || (curstep<step && method=="htpls")))
  {
   for(isqr=0;isqr<=8;isqr++)
   {
    if (curstep<step) isqr=cf1;
    if (sqrfill[isqr]<=4)   // change <=5 to <=4
    {
     for(k1=0;k1<=6;k1++)
     {
      if (curstep<step) k1=cf2;
      if (ksqrcell[isqr][k1]<=3 && ksqrcell[isqr][k1]>=2)
	  {
       for(k2=k1+1;k2<=7;k2++)
       {
        if (curstep<step) k2=cf3;
	    if (ksqrcell[isqr][k2]<=3 && ksqrcell[isqr][k2]>=2)
	    {
         for(k3=k2+1;k3<=8;k3++)
         { 
          if (curstep<step) k3=cf4;
	      if (ksqrcell[isqr][k3]<=3 && ksqrcell[isqr][k3]>=2)
          {
	       icount=0;
		   infostr=""+(k1+1)+(k2+1)+(k3+1);
		   iv=[-1,-1,-1];
		   jv=[-1,-1,-1];
	       for(i=0;i<=8;i++)
	       {
		    i1=Math.floor(isqr/3)*3+Math.floor(i/3);
		    j1=(isqr%3)*3+(i%3);
	        if(a[i1][j1][k1]+a[i1][j1][k2]+a[i1][j1][k3]>0) 
		    {
		     if (icount<3) 
			 {
			  iv[icount]=i1;
			  jv[icount]=j1;
			 } 
		     icount++;
		     if (icount>3) break;
		    } 
	       }
	       if (icount==3)
	       {	   
	        for(kk=0;kk<=8;kk++)
	        {
	         if (kk!=k1 && kk!=k2 && kk!=k3 && (a[iv[0]][jv[0]][kk]!=0 || a[iv[1]][jv[1]][kk]!=0 || a[iv[2]][jv[2]][kk]!=0))
		     {
		      change=true;
		      if (a[iv[0]][jv[0]][kk]!=0) rmapos(a,iv[0],jv[0],kk,poscell,krowcell,kcolcell,ksqrcell);
		      if (a[iv[1]][jv[1]][kk]!=0) rmapos(a,iv[1],jv[1],kk,poscell,krowcell,kcolcell,ksqrcell);
		      if (a[iv[2]][jv[2]][kk]!=0) rmapos(a,iv[2],jv[2],kk,poscell,krowcell,kcolcell,ksqrcell);			
             }		 
	        }
	       } 
		  }
		  if (change)
		  {
	       needconfirm=1;
		   if (curstep==dispstep)
		   {
            showrc_t(iv[0]*9+jv[0],3);
		    for (ii=0;ii<3;ii++)
		    {
		     idx=iv[ii]*9+jv[ii];
		     kpval(idx,infostr,1);
		     hlnumber(idx,infostr);
		    }
		   }
           if (curstep==step)
           {		  
	        addstep(false,"htpls",""+isqr+","+k1+","+k2+","+k3+","+iv[0]+","+jv[0]+","+iv[1]+","+jv[1]+","+iv[2]+","+jv[2]);
	        addmsg('In square '+dsqr(isqr)+', only 3 cells '+dcell(iv[0],jv[0])+', '+dcell(iv[1],jv[1])+' and '+dcell(iv[2],jv[2])+' may have digits "'+ddig(k1)+'", "'+ddig(k2)+'" and "'+ddig(k3)+'" as candidates.  Therefore, these 3 digits must reside in one of these 3 cells respectively and other possibilities in these 3 cells can be removed.');
	        addmsgr('- Hidden Triplet');
	        next2update();
           }
		  }
	      if (change || curstep<step) break;
	     }
        }
	    if (change || curstep<step) break;
       }
      }
	  if (change || curstep<step) break;
     } 
    }
    if (change || curstep<step) break;
   } 
  }
 }
 return change;
}

function hquad(a,poscell,krowcell,kcolcell,ksqrcell)
{
 var i,j,i1,i2,i3,i4,j1,j2,j3,j4,k,k1,k2,k3,k4,ii,jj,kk,idx,isqr,index1,index2,index3,index4,nindex;
 var iv=new Array(-1,-1,-1,-1),jv=new Array(-1,-1,-1,-1),icount=0,change=false,infostr="",method="";
 resetrcclr_t();
 fillpos(80);
 if (curstep<step)
 {
  method=solvedsqn[curstep].substr(0,solvedsqn[curstep].indexOf(":"));
  var cellinfo=solvedsqn[curstep].substr(solvedsqn[curstep].indexOf(":")+1);	
  var cf1=cellinfo.substr(0,1)*1, cf2=cellinfo.substr(2,1)*1, cf3=cellinfo.substr(4,1)*1;
  var cf4=cellinfo.substr(6,1)*1, cf5=cellinfo.substr(8,1)*1, cf6=cellinfo.substr(10,1)*1;
  var cf7=cellinfo.substr(12,1)*1, cf8=cellinfo.substr(14,1)*1, cf9=cellinfo.substr(16,1)*1;
  if (method=="hquads") var cf10=cellinfo.substr(18,1)*1, cf11=cellinfo.substr(20,1)*1, cf12=cellinfo.substr(22,1)*1, cf13=cellinfo.substr(24,1)*1;
 }
 if (curstep<dispstep)
 {
  switch (method)
  {
   case "hquadr":
     for (k=0;k<9;k++)
	 {
	  if (k!=cf2 && k!=cf3 && k!=cf4 && k!=cf5)
	  {
	   if (a[cf1][cf6][k]==1) rmapos(a,cf1,cf6,k,poscell,krowcell,kcolcell,ksqrcell);
	   if (a[cf1][cf7][k]==1) rmapos(a,cf1,cf7,k,poscell,krowcell,kcolcell,ksqrcell);
	   if (a[cf1][cf8][k]==1) rmapos(a,cf1,cf8,k,poscell,krowcell,kcolcell,ksqrcell);
	   if (a[cf1][cf9][k]==1) rmapos(a,cf1,cf9,k,poscell,krowcell,kcolcell,ksqrcell);
	  }
	 }
	 break;
   case "hquadc":
     for (k=0;k<9;k++)
	 {
	  if (k!=cf2 && k!=cf3 && k!=cf4 && k!=cf5)
	  {
	   if (a[cf6][cf1][k]==1) rmapos(a,cf6,cf1,k,poscell,krowcell,kcolcell,ksqrcell);
	   if (a[cf7][cf1][k]==1) rmapos(a,cf7,cf1,k,poscell,krowcell,kcolcell,ksqrcell);
	   if (a[cf8][cf1][k]==1) rmapos(a,cf8,cf1,k,poscell,krowcell,kcolcell,ksqrcell);
	   if (a[cf9][cf1][k]==1) rmapos(a,cf9,cf1,k,poscell,krowcell,kcolcell,ksqrcell);
	  }
	 }
	 break;
   case "hquads":
     for (k=0;k<9;k++)
	 {
	  if (k!=cf2 && k!=cf3 && k!=cf4 && k!=cf5)
	  {
	   if (a[cf6][cf7][k]==1) rmapos(a,cf6,cf7,k,poscell,krowcell,kcolcell,ksqrcell);
	   if (a[cf8][cf9][k]==1) rmapos(a,cf8,cf9,k,poscell,krowcell,kcolcell,ksqrcell);
	   if (a[cf10][cf11][k]==1) rmapos(a,cf10,cf11,k,poscell,krowcell,kcolcell,ksqrcell);
	   if (a[cf12][cf13][k]==1) rmapos(a,cf12,cf13,k,poscell,krowcell,kcolcell,ksqrcell);
	  }
	 }
	 break;
  }
  needconfirm=1;
  change=true;
 }
 else
 {
  if (curstep==step || (curstep<step && method=="hquadr"))
  {
   for(i=0;i<=8;i++)
   {
    if (curstep<step) i=cf1;
    if (rowfill[i]<=3) 
    {
     for(k1=0;k1<=5;k1++)
     {
      if (curstep<step) k1=cf2;
      if (krowcell[i][k1]<=4 && krowcell[i][k1]>=2)
	  {
       for(k2=k1+1;k2<=6;k2++)
       {
        if (curstep<step) k2=cf3;
	    if (krowcell[i][k2]<=4 && krowcell[i][k2]>=2)
	    {
         for(k3=k2+1;k3<=7;k3++)
         { 
          if (curstep<step) k3=cf4;
	      if (krowcell[i][k3]<=4 && krowcell[i][k3]>=2)
          {
           for(k4=k3+1;k4<=8;k4++)
           { 
            if (curstep<step) k4=cf5;
	        if (krowcell[i][k4]<=4 && krowcell[i][k4]>=2)
            {
	         icount=0;
		     infostr=""+(k1+1)+(k2+1)+(k3+1)+(k4+1);
		     jv=[-1,-1,-1,-1];
	         for(j=0;j<=8;j++)
	         {
	          if(a[i][j][k1]+a[i][j][k2]+a[i][j][k3]+a[i][j][k4]>0) 
		      {
		       if (icount<4) jv[icount]=j;
		       icount++;
		       if (icount>4) break;
		      } 
	         }
	         if (icount==4)
	         {	   
	          for(kk=0;kk<=8;kk++)
	          {
	           if (kk!=k1 && kk!=k2 && kk!=k3 && kk!=k4 && (a[i][jv[0]][kk]!=0 || a[i][jv[1]][kk]!=0 || a[i][jv[2]][kk]!=0 || a[i][jv[3]][kk]!=0))
		       {
		        change=true;
		        if (a[i][jv[0]][kk]!=0) rmapos(a,i,jv[0],kk,poscell,krowcell,kcolcell,ksqrcell);
		        if (a[i][jv[1]][kk]!=0) rmapos(a,i,jv[1],kk,poscell,krowcell,kcolcell,ksqrcell);
		        if (a[i][jv[2]][kk]!=0) rmapos(a,i,jv[2],kk,poscell,krowcell,kcolcell,ksqrcell);			
		        if (a[i][jv[3]][kk]!=0) rmapos(a,i,jv[3],kk,poscell,krowcell,kcolcell,ksqrcell);			
               }		 
	          }
	         }
	 	    }
		    if (change)
		    {
	         needconfirm=1;
		     if (curstep==dispstep)
		     {
              showrc_t(i*9,1);
		      for (ii=0;ii<4;ii++)
		      {
		       idx=i*9+jv[ii];
		       kpval(idx,infostr,1);
		       hlnumber(idx,infostr);
		      }
		     } 
             if (curstep==step)
             {		  
	          addstep(false,"hquadr",""+i+","+k1+","+k2+","+k3+","+k4+","+jv[0]+","+jv[1]+","+jv[2]+","+jv[3]);
	          addmsg('In row '+drow(i)+', only 4 cells '+dcell(i,jv[0])+', '+dcell(i,jv[1])+', '+dcell(i,jv[2])+' and '+dcell(i,jv[3])+' may have digits "'+ddig(k1)+'", "'+ddig(k2)+'", "'+ddig(k3)+'" and "'+ddig(k4)+'" as candidates.  Therefore, these 4 digits must reside in one of these 4 cells respectively and other possibilities in these 4 cells can be removed.');
	          addmsgr('- Hidden Quad');
	          next2update();
		     } 
		    }
		    if (change || curstep<step) break;
	       }
          }
	      if (change || curstep<step) break;
         }
        }
	    if (change || curstep<step) break;
       }
      }
	  if (change || curstep<step) break;
     }
    }
    if (change || curstep<step) break;
   } 
  } 
 
  if (!change && (curstep==step || (curstep<step && method=="hquadc")))
  {
   for(j=0;j<=8;j++)
   {
    if (curstep<step) j=cf1;
    if (colfill[j]<=3)   
    {
     for(k1=0;k1<=5;k1++)
     {
      if (curstep<step) k1=cf2;
      if (kcolcell[j][k1]<=4 && kcolcell[j][k1]>=2)
	  {
       for(k2=k1+1;k2<=6;k2++)
       {
        if (curstep<step) k2=cf3;
	    if (kcolcell[j][k2]<=4 && kcolcell[j][k2]>=2)
	    {
         for(k3=k2+1;k3<=7;k3++)
         { 
          if (curstep<step) k3=cf4;
	      if (kcolcell[j][k3]<=4 && kcolcell[j][k3]>=2)
          {
           for(k4=k3+1;k4<=8;k4++)
           { 
            if (curstep<step) k4=cf5;
	        if (kcolcell[j][k4]<=4 && kcolcell[j][k4]>=2)
            {
	         icount=0;
		     infostr=""+(k1+1)+(k2+1)+(k3+1)+(k4+1);
		     iv=[-1,-1,-1,-1];
	         for(i=0;i<=8;i++)
	         {
	          if(a[i][j][k1]+a[i][j][k2]+a[i][j][k3]+a[i][j][k4]>0) 
		      {
		       if (icount<4) iv[icount]=i;
		       icount++;
		       if (icount>4) break;
		      } 
	         }
	         if (icount==4)
	         {	   
	          for(kk=0;kk<=8;kk++)
	          {
	           if (kk!=k1 && kk!=k2 && kk!=k3 && kk!=k4 && (a[iv[0]][j][kk]!=0 || a[iv[1]][j][kk]!=0 || a[iv[2]][j][kk]!=0 || a[iv[3]][j][kk]!=0))
		       {
		        change=true;
		        if (a[iv[0]][j][kk]!=0) rmapos(a,iv[0],j,kk,poscell,krowcell,kcolcell,ksqrcell);
		        if (a[iv[1]][j][kk]!=0) rmapos(a,iv[1],j,kk,poscell,krowcell,kcolcell,ksqrcell);
		        if (a[iv[2]][j][kk]!=0) rmapos(a,iv[2],j,kk,poscell,krowcell,kcolcell,ksqrcell);			
		        if (a[iv[3]][j][kk]!=0) rmapos(a,iv[3],j,kk,poscell,krowcell,kcolcell,ksqrcell);			
               }		 
	          }
	         }
		    }
		    if (change)
		    {
	         needconfirm=1;
		     if (curstep==dispstep)
		     {
              showrc_t(j,2);
		      for (ii=0;ii<4;ii++)
		      {
		       idx=iv[ii]*9+j;
		       kpval(idx,infostr,1);
		       hlnumber(idx,infostr);
		      }
		     }
             if (curstep==step)
             {		  
	          addstep(false,"hquadc",""+j+","+k1+","+k2+","+k3+","+k4+","+iv[0]+","+iv[1]+","+iv[2]+","+iv[3]);
	          addmsg('In column '+dcol(j)+', only 4 cells '+dcell(iv[0],j)+', '+dcell(iv[1],j)+', '+dcell(iv[2],j)+' and '+dcell(iv[3],j)+' may have digits "'+ddig(k1)+'", "'+ddig(k2)+'", "'+ddig(k3)+'" and "'+ddig(k4)+'" as candidates.  Therefore, these 4 digits must reside in one of these 4 cells respectively and other possibilities in these 4 cells can be removed.');
	          addmsgr('- Hidden Quad');
	          next2update();
		     } 
		    }
	        if (change || curstep<step) break;
	       }
          }
	      if (change || curstep<step) break;
         }
        }
	    if (change || curstep<step) break;
       }
      }
	  if (change || curstep<step) break;
     }
    }
    if (change || curstep<step) break;
   } 
  }
 
  if (!change && (curstep==step || (curstep<step && method=="hquads")))
  {
   for(isqr=0;isqr<=8;isqr++)
   {
    if (curstep<step) isqr=cf1;
    if (sqrfill[isqr]<=3)  
    {
     for(k1=0;k1<=5;k1++)
     {
      if (curstep<step) k1=cf2;
      if (ksqrcell[isqr][k1]<=4 && ksqrcell[isqr][k1]>=2)
	  {
       for(k2=k1+1;k2<=6;k2++)
       {
        if (curstep<step) k2=cf3;
	    if (ksqrcell[isqr][k2]<=4 && ksqrcell[isqr][k2]>=2)
	    {
         for(k3=k2+1;k3<=7;k3++)
         { 
          if (curstep<step) k3=cf4;
	      if (ksqrcell[isqr][k3]<=4 && ksqrcell[isqr][k3]>=2)
          {
           for(k4=k3+1;k4<=8;k4++)
           { 
            if (curstep<step) k4=cf5;
	        if (ksqrcell[isqr][k4]<=4 && ksqrcell[isqr][k4]>=2)
            {
	         icount=0;
		     infostr=""+(k1+1)+(k2+1)+(k3+1)+(k4+1);
		     iv=[-1,-1,-1,-1];
		     jv=[-1,-1,-1,-1];
	         for(i=0;i<=8;i++)
	         {
		      i1=Math.floor(isqr/3)*3+Math.floor(i/3);
		      j1=(isqr%3)*3+(i%3);
	          if(a[i1][j1][k1]+a[i1][j1][k2]+a[i1][j1][k3]+a[i1][j1][k4]>0) 
		      {
		       if (icount<4) 
			   {
			    iv[icount]=i1;
			    jv[icount]=j1;
			   } 
		       icount++;
		       if (icount>4) break;
		      } 
	         }
	         if (icount==4)
	         {	   
	          for(kk=0;kk<=8;kk++)
	          {
	           if (kk!=k1 && kk!=k2 && kk!=k3 && kk!=k4 && (a[iv[0]][jv[0]][kk]!=0 || a[iv[1]][jv[1]][kk]!=0 || a[iv[2]][jv[2]][kk]!=0 || a[iv[3]][jv[3]][kk]!=0))
		       {
		        change=true;
		        if (a[iv[0]][jv[0]][kk]!=0) rmapos(a,iv[0],jv[0],kk,poscell,krowcell,kcolcell,ksqrcell);
		        if (a[iv[1]][jv[1]][kk]!=0) rmapos(a,iv[1],jv[1],kk,poscell,krowcell,kcolcell,ksqrcell);
		        if (a[iv[2]][jv[2]][kk]!=0) rmapos(a,iv[2],jv[2],kk,poscell,krowcell,kcolcell,ksqrcell);			
		        if (a[iv[3]][jv[3]][kk]!=0) rmapos(a,iv[3],jv[3],kk,poscell,krowcell,kcolcell,ksqrcell);			
               }		 
	          }
	         } 
		    }
		    if (change)
		    {
	         needconfirm=1;
		     if (curstep==dispstep)
		     {
              showrc_t(iv[0]*9+jv[0],3);
		      for (ii=0;ii<4;ii++)
		      {
		       idx=iv[ii]*9+jv[ii];
		       kpval(idx,infostr,1);
		       hlnumber(idx,infostr);
		      }
		     }
             if (curstep==step)
             {		  
	          addstep(false,"hquads",""+isqr+","+k1+","+k2+","+k3+","+k4+","+iv[0]+","+jv[0]+","+iv[1]+","+jv[1]+","+iv[2]+","+jv[2]+","+iv[3]+","+jv[3]);
	          addmsg('In square '+dsqr(isqr)+', only 4 cells '+dcell(iv[0],jv[0])+', '+dcell(iv[1],jv[1])+', '+dcell(iv[2],jv[2])+' and '+dcell(iv[3],jv[3])+' may have digits "'+ddig(k1)+'", "'+ddig(k2)+'", "'+ddig(k3)+'" and "'+ddig(k4)+'" as candidates.  Therefore, these 4 digits must reside in one of these 4 cells respectively and other possibilities in these 4 cells can be removed.');
	          addmsgr('- Hidden Quad');
	          next2update();
             }
		    }
	        if (change || curstep<step) break;
	       }
          }
	      if (change || curstep<step) break;
         }
        }
	    if (change || curstep<step) break;
       }
      }
	  if (change || curstep<step) break;
     } 
    }
    if (change || curstep<step) break;
   } 
  }
 }
 return change;
}

function xwing(a,poscell,krowcell,kcolcell,ksqrcell)
{
 var i1,i2,j1,j2,i,j,k,ii,jj,iv=new Array(-1,-1),jv=new Array(-1,-1),infostr,icount=0,match=false,change=false,method="";
 if (curstep<step)
 {
  method=solvedsqn[curstep].substr(0,solvedsqn[curstep].indexOf(":"));
  var cellinfo=solvedsqn[curstep].substr(solvedsqn[curstep].indexOf(":")+1);	
  var cf1=cellinfo.substr(0,1)*1, cf2=cellinfo.substr(2,1)*1, cf3=cellinfo.substr(4,1)*1, cf4=cellinfo.substr(6,1)*1, cf5=cellinfo.substr(8,1)*1;
 }
 if (curstep<dispstep)
 {
  switch (method)
  {
   case "xwr":
     for (i=0;i<9;i++)
	 {
	  if (i!=cf1 && i!=cf2)
	  {
	   if (a[i][cf4][cf3]==1) rmapos(a,i,cf4,cf3,poscell,krowcell,kcolcell,ksqrcell);
	   if (a[i][cf5][cf3]==1) rmapos(a,i,cf5,cf3,poscell,krowcell,kcolcell,ksqrcell);
	  }
	 }
	 break;
   case "xwc":
     for (i=0;i<9;i++)
	 {
	  if (i!=cf1 && i!=cf2)
	  {
	   if (a[cf4][i][cf3]==1) rmapos(a,cf4,i,cf3,poscell,krowcell,kcolcell,ksqrcell);
	   if (a[cf5][i][cf3]==1) rmapos(a,cf5,i,cf3,poscell,krowcell,kcolcell,ksqrcell);
	  }
	 }
	 break;
  }
  needconfirm=1;
  change=true;
 }
 else
 {
  for(k=0;k<=8;k++)
  {
   if (curstep<step) k=cf3;
   if (kfill[k]<8)
   {
    if (curstep==step || (curstep<step && method=="xwr"))
    {
     for(i1=0;i1<=7;i1++)
     {
      if (curstep<step) i1=cf1;	
      if (krowcell[i1][k]==2)
	  {
       for(i2=i1+1;i2<=8;i2++)
       {	
        if (curstep<step) i2=cf2;	
	    if (krowcell[i2][k]==2)
        {
	     match=true;
	     infostr=""+(k+1);
	     jv=[-1,-1];
	     icount=0;
	     for(j=0;j<=8;j++)
	     {
	      if(a[i1][j][k]!=a[i2][j][k])
          {
           match=false;
		   break;
		  }
          else if (a[i1][j][k]==1)
          {
           if (icount<2) jv[icount]=j;
		   icount++;
		  } 
	     }
	     if (match)
	     {
	      for(ii=0;ii<=8;ii++)
	      {
	       if (ii!=i1 && ii!=i2 && (a[ii][jv[0]][k]==1 || a[ii][jv[1]][k]==1)) 
		   {
            change=true;  
		    if (a[ii][jv[0]][k]==1) 
		    {
		     rmapos(a,ii,jv[0],k,poscell,krowcell,kcolcell,ksqrcell);
		     if (curstep==dispstep) rmval(ii*9+jv[0],infostr,1);
		    } 
		    if (a[ii][jv[1]][k]==1) 
		    {
		     rmapos(a,ii,jv[1],k,poscell,krowcell,kcolcell,ksqrcell);
		     if (curstep==dispstep) rmval(ii*9+jv[1],infostr,1);
		    }
		   }
		  }         		
	     }
	     if (change)
	     {
		  if (curstep==dispstep)
		  {
           showrc_t(i1*9,1);
           showrc_t(i2*9,1);
	       hlnumber(i1*9+jv[0],infostr);
	       hlnumber(i1*9+jv[1],infostr);
	       hlnumber(i2*9+jv[0],infostr);
	       hlnumber(i2*9+jv[1],infostr);
		  }
          if (curstep==step)
          {		 
	       addstep(false,"xwr",""+i1+","+i2+","+k+","+jv[0]+","+jv[1]);
	       addmsg('In rows '+drow(i1)+' and '+drow(i2)+', digit "'+ddig(k)+'" is a candidate for cells in exactly the same 2 columns '+dcol(jv[0])+' and '+dcol(jv[1])+'.  Therefore, "'+ddig(k)+'" must reside either in '+dcell(i1,jv[0])+' and '+dcell(i2,jv[1])+' or in '+dcell(i1,jv[1])+' and '+dcell(i2,jv[0])+'.  In either case, "'+ddig(k)+'" cannot be possibilities for other cells in columns '+dcol(jv[0])+' and '+dcol(jv[1])+'.');
	       addmsgr('- X-Wing');
	       next2update();
		  } 
	     }
	    }
	    if (change || curstep<step) break;
	   }
      }	
	  if (change || curstep<step) break;
     }
    }	
    if (!change && (curstep==step || (curstep<step && method=="xwc")))
    {
     for(j1=0;j1<=7;j1++)
     { 
      if (curstep<step) j1=cf1;	
      if (kcolcell[j1][k]==2)
	  {
       for(j2=j1+1;j2<=8;j2++)
       {	
        if (curstep<step) j2=cf2;	
	    if (kcolcell[j2][k]==2)
        {
	     match=true;
	     infostr=""+(k+1);
	     iv=[-1,-1];
	     icount=0;
	     for(i=0;i<=8;i++)
	     {
	      if(a[i][j1][k]!=a[i][j2][k])
          {
           match=false;
		   break;
		  }
          else if (a[i][j1][k]==1)
          {
           if (icount<2) iv[icount]=i;
		   icount++;
		  } 
	     }
	     if (match)
	     {
	      for(jj=0;jj<=8;jj++)
	      {
	       if (jj!=j1 && jj!=j2 && (a[iv[0]][jj][k]==1 || a[iv[1]][jj][k]==1)) 
		   {
            change=true;  
		    if (a[iv[0]][jj][k]==1) 
		    {
		     rmapos(a,iv[0],jj,k,poscell,krowcell,kcolcell,ksqrcell);
		     if (curstep==dispstep) rmval(iv[0]*9+jj,infostr,1);
		    } 
		    if (a[iv[1]][jj][k]==1) 
		    {
		     rmapos(a,iv[1],jj,k,poscell,krowcell,kcolcell,ksqrcell);
		     if (curstep==dispstep) rmval(iv[1]*9+jj,infostr,1);
		    }
		   }
		  }         		
	     }
	     if (change)
	     {
		  if (curstep==dispstep)
		  {
           showrc_t(j1,2);
           showrc_t(j2,2);
	       hlnumber(iv[0]*9+j1,infostr);
	       hlnumber(iv[0]*9+j2,infostr);
	       hlnumber(iv[1]*9+j1,infostr);
	       hlnumber(iv[1]*9+j2,infostr);
		  }
          if (curstep==step)
          {		 
	       addstep(false,"xwc",""+j1+","+j2+","+k+","+iv[0]+","+iv[1]);
	       addmsg('In columns '+dcol(j1)+' and '+dcol(j2)+', digit "'+ddig(k)+'" is a candidate for cells in exactly the same 2 rows '+drow(iv[0])+' and '+drow(iv[1])+'.  Therefore, "'+ddig(k)+'" must reside either in '+dcell(iv[0],j1)+' and '+dcell(iv[1],j2)+' or in '+dcell(iv[0],j2)+' and '+dcell(iv[1],j1)+'.  In either case, "'+ddig(k)+'" cannot be possibilities for other cells in rows '+drow(iv[0])+' and '+drow(iv[1])+'.');
	       addmsgr('- X-Wing');
	       next2update();
		  }
	     }
	    }
	    if (change || curstep<step) break;
	   }
      } 	
	  if (change || curstep<step) break;
     } 
    }
   }
   if (change || curstep<step) break;
  }
  if (change) needconfirm=1;
 }
 return change;
} 

function swfish(a,poscell,krowcell,kcolcell,ksqrcell)
{
 var i1,i2,i3,j1,j2,j3,i,j,k,iv=new Array(-1,-1,-1),jv=new Array(-1,-1,-1),icount,ii,jj,change=false,infostr,method="";
 if (curstep<step)
 {
  method=solvedsqn[curstep].substr(0,solvedsqn[curstep].indexOf(":"));
  var cellinfo=solvedsqn[curstep].substr(solvedsqn[curstep].indexOf(":")+1);	
  var cf1=cellinfo.substr(0,1)*1, cf2=cellinfo.substr(2,1)*1, cf3=cellinfo.substr(4,1)*1, cf4=cellinfo.substr(6,1)*1;
  var cf5=cellinfo.substr(8,1)*1, cf6=cellinfo.substr(10,1)*1, cf7=cellinfo.substr(12,1)*1;
 }
 if (curstep<dispstep)
 {
  switch (method)
  {
   case "sfr":
     for (i=0;i<9;i++)
	 {
	  if (i!=cf1 && i!=cf2 && i!=cf3)
	  {
	   if (a[i][cf5][cf4]==1) rmapos(a,i,cf5,cf4,poscell,krowcell,kcolcell,ksqrcell);
	   if (a[i][cf6][cf4]==1) rmapos(a,i,cf6,cf4,poscell,krowcell,kcolcell,ksqrcell);
	   if (a[i][cf7][cf4]==1) rmapos(a,i,cf7,cf4,poscell,krowcell,kcolcell,ksqrcell);
	  }
	 }
	 break;
   case "sfc":
     for (i=0;i<9;i++)
	 {
	  if (i!=cf1 && i!=cf2 && i!=cf3)
	  {
	   if (a[cf5][i][cf4]==1) rmapos(a,cf5,i,cf4,poscell,krowcell,kcolcell,ksqrcell);
	   if (a[cf6][i][cf4]==1) rmapos(a,cf6,i,cf4,poscell,krowcell,kcolcell,ksqrcell);
	   if (a[cf7][i][cf4]==1) rmapos(a,cf7,i,cf4,poscell,krowcell,kcolcell,ksqrcell);
	  }
	 }
	 break;
  }
  needconfirm=1;
  change=true;
 }
 else
 {
  for(k=0;k<=8;k++)
  {
   if (curstep<step) k=cf4;
   if (kfill[k]<8)
   {
    if (curstep==step || (curstep<step && method=="sfr"))
    {
    for(i1=0;i1<=6;i1++)
    {
	  if (curstep<step) i1=cf1;
      if (krowcell[i1][k]<=3 && krowcell[i1][k]>=2)
	  {
       for(i2=i1+1;i2<=7;i2++)
       {
	    if (curstep<step) i2=cf2;
	    if (krowcell[i2][k]<=3 && krowcell[i2][k]>=2)
	    {
         for(i3=i2+1;i3<=8;i3++)
         { 
	      if (curstep<step) i3=cf3;
	      if (krowcell[i3][k]<=3 && krowcell[i3][k]>=2)
          {
	       icount=0;
	       infostr=""+(k+1);
	       jv=[-1,-1,-1];
	       for(j=0;j<=8;j++)
	       {
	        if (a[i1][j][k]+a[i2][j][k]+a[i3][j][k]>0) 
		    {
		     if (icount<3) jv[icount]=j;
		     icount++;
		     if (icount>3) break;
		    } 
	       }
	       if (icount==3)
	       {	   
	        for(ii=0;ii<=8;ii++)
	        {
	         if (ii!=i1 && ii!=i2 && ii!=i3 && (a[ii][jv[0]][k]==1 || a[ii][jv[1]][k]==1 || a[ii][jv[2]][k]==1)) 
		     {
              change=true;  
		      if (a[ii][jv[0]][k]==1) 
		      {
		       rmapos(a,ii,jv[0],k,poscell,krowcell,kcolcell,ksqrcell);
		       if (curstep==dispstep) rmval(ii*9+jv[0],infostr,1);
		      } 
		      if (a[ii][jv[1]][k]==1) 
		      {
		       rmapos(a,ii,jv[1],k,poscell,krowcell,kcolcell,ksqrcell);
		       if (curstep==dispstep) rmval(ii*9+jv[1],infostr,1);
		      } 
		      if (a[ii][jv[2]][k]==1) 
		      {
		       rmapos(a,ii,jv[2],k,poscell,krowcell,kcolcell,ksqrcell);
		       if (curstep==dispstep) rmval(ii*9+jv[2],infostr,1);
		      } 
		     }
		    }         		
           }
	       if (change)
	       {
		    if (curstep==dispstep)
		    {
             showrc_t(i1*9,1);
             showrc_t(i2*9,1);
             showrc_t(i3*9,1);
	         hlnumber(i1*9+jv[0],infostr);
	         hlnumber(i1*9+jv[1],infostr);
	         hlnumber(i1*9+jv[2],infostr);
	         hlnumber(i2*9+jv[0],infostr);
	         hlnumber(i2*9+jv[1],infostr);
	         hlnumber(i2*9+jv[2],infostr);
	         hlnumber(i3*9+jv[0],infostr);
	         hlnumber(i3*9+jv[1],infostr);
	         hlnumber(i3*9+jv[2],infostr);
		    }
            if (curstep==step)
            {		   
	         addstep(false,"sfr",""+i1+","+i2+","+i3+","+k+","+jv[0]+","+jv[1]+","+jv[2]);
	         addmsg('In rows '+drow(i1)+', '+drow(i2)+' and '+drow(i3)+', only cells in columns '+dcol(jv[0])+', '+dcol(jv[1])+' and '+dcol(jv[2])+' may have digit "'+ddig(k)+'" as a candidate.  Therefore, within each of these 3 columns, "'+ddig(k)+'" must reside in one of the cells in rows '+drow(i1)+', '+drow(i2)+' and '+drow(i3)+' and cannot be possibilities for cells in other rows.');
	         addmsgr('- Swordfish');
	         next2update();
		    }	
	       }
          }		 
	      if (change || curstep<step) break;
	     }
	    }
	    if (change || curstep<step) break;
	   }
      }
	  if (change || curstep<step) break;	
	 }
    }
   
    if (!change && (curstep==step || (curstep<step && method=="sfc")))
    {
     for(j1=0;j1<=6;j1++)
     {
	  if (curstep<step) j1=cf1;
      if (kcolcell[j1][k]<=3 && kcolcell[j1][k]>=2)
	  {
       for(j2=j1+1;j2<=7;j2++)
       {
	    if (curstep<step) j2=cf2;
	    if (kcolcell[j2][k]<=3 && kcolcell[j2][k]>=2)
	    {
         for(j3=j2+1;j3<=8;j3++)
         { 
	      if (curstep<step) j3=cf3;
	      if (kcolcell[j3][k]<=3 && kcolcell[j3][k]>=2)
          {
	       icount=0;
	       infostr=""+(k+1);
	       iv=[-1,-1,-1];
	       for(i=0;i<=8;i++)
	       {
	        if (a[i][j1][k]+a[i][j2][k]+a[i][j3][k]>0) 
		    {
		     if (icount<3) iv[icount]=i;
		     icount++;
		     if (icount>3) break;
		    } 
	       }
	       if (icount==3)
	       {	   
	        for(jj=0;jj<=8;jj++)
	        {
	         if (jj!=j1 && jj!=j2 && jj!=j3 && (a[iv[0]][jj][k]==1 || a[iv[1]][jj][k]==1 || a[iv[2]][jj][k]==1)) 
		     {
              change=true;  
		      if (a[iv[0]][jj][k]==1) 
		      {
		       rmapos(a,iv[0],jj,k,poscell,krowcell,kcolcell,ksqrcell);
		       if (curstep==dispstep) rmval(iv[0]*9+jj,infostr,1);
		      } 
		      if (a[iv[1]][jj][k]==1) 
		      {
		       rmapos(a,iv[1],jj,k,poscell,krowcell,kcolcell,ksqrcell);
		       if (curstep==dispstep) rmval(iv[1]*9+jj,infostr,1);
		      } 
		      if (a[iv[2]][jj][k]==1) 
		      {
		       rmapos(a,iv[2],jj,k,poscell,krowcell,kcolcell,ksqrcell);
		       if (curstep==dispstep) rmval(iv[2]*9+jj,infostr,1);
		      } 
		     }
		    }         		
           }
	       if (change)
	       {
		    if (curstep==dispstep)
		    {
             showrc_t(j1,2);
             showrc_t(j2,2);
             showrc_t(j3,2);
	         hlnumber(iv[0]*9+j1,infostr);
	         hlnumber(iv[0]*9+j2,infostr);
	         hlnumber(iv[0]*9+j3,infostr);
	         hlnumber(iv[1]*9+j1,infostr);
	         hlnumber(iv[1]*9+j2,infostr);
	         hlnumber(iv[1]*9+j3,infostr);
	         hlnumber(iv[2]*9+j1,infostr);
	         hlnumber(iv[2]*9+j2,infostr);
	         hlnumber(iv[2]*9+j3,infostr);
		    }
            if (curstep==step)
            {		   
	         addstep(false,"sfc",""+j1+","+j2+","+j3+","+k+","+iv[0]+","+iv[1]+","+iv[2]);
	         addmsg('In columns '+dcol(j1)+', '+dcol(j2)+' and '+dcol(j3)+', only cells in rows '+drow(iv[0])+', '+drow(iv[1])+' and '+drow(iv[2])+' may have digit "'+ddig(k)+'" as a candidate.  Therefore, within each of these 3 rows, "'+ddig(k)+'" must reside in one of the cells in columns '+dcol(j1)+', '+dcol(j2)+' and '+dcol(j3)+' and cannot be possibilities for cells in other columns.');
	         addmsgr('- Swordfish');
	         next2update();
		    }
	       }
          }		 
	      if (change || curstep<step) break;
	     }
	    }
	    if (change || curstep<step) break;
	   }
      }
	  if (change || curstep<step) break;	
     }
    }
   }
   if (change || curstep<step) break;   
  }
  if (change) needconfirm=1; 
 }
 return change;
}

function xywing(a,poscell,krowcell,kcolcell,ksqrcell)
{
 var i,i1,j1,j2,k,k1,k2,isqr1,isqr2,ii,jj,newi1,newj1,newi2,newj2,rjindex,jindex1,jindex2,kmatch,match,change=false,method="";
 if (curstep<step)
 {
  method=solvedsqn[curstep].substr(0,solvedsqn[curstep].indexOf(":"));
  var cellinfo=solvedsqn[curstep].substr(solvedsqn[curstep].indexOf(":")+1);	
  var cf1=cellinfo.substr(0,1)*1, cf2=cellinfo.substr(2,1)*1, cf3=cellinfo.substr(4,1)*1, cf4=cellinfo.substr(6,1)*1, cf5=cellinfo.substr(8,1)*1;
  if (method=="xywr" || method=="xywc") cf6=cellinfo.substr(10,1)*1;
 }
 if (curstep<dispstep)
 {
  switch (method)
  {
   case "xywt":
     if (a[cf1][cf2][cf5]==0 && a[cf4][cf3][cf5]==1) rmapos(a,cf4,cf3,cf5,poscell,krowcell,kcolcell,ksqrcell);
	 else if (a[cf1][cf3][cf5]==0 && a[cf4][cf2][cf5]==1) rmapos(a,cf4,cf2,cf5,poscell,krowcell,kcolcell,ksqrcell);
	 break;
   case "xywr":
     for (jj=0;jj<3;jj++)
	 {
	  j1=Math.floor(cf5/3)*3+jj;
	  if (j1!=cf2 && j1!=cf3 && a[cf1][j1][cf6]==1) rmapos(a,cf1,j1,cf6,poscell,krowcell,kcolcell,ksqrcell);
	  if (Math.floor(cf5/3)!=Math.floor(cf2/3)) 
	  {
	   j2=Math.floor(cf2/3)*3+jj;
	   if (a[cf4][j2][cf6]==1) rmapos(a,cf4,j2,cf6,poscell,krowcell,kcolcell,ksqrcell);
	  } 
	  else if (Math.floor(cf5/3)!=Math.floor(cf3/3))
	  {
	   j2=Math.floor(cf3/3)*3+jj;
	   if (a[cf4][j2][cf6]==1) rmapos(a,cf4,j2,cf6,poscell,krowcell,kcolcell,ksqrcell);
	  } 
     }
	 break;
   case "xywc":
     for (ii=0;ii<3;ii++)
	 {
	  i1=Math.floor(cf5/3)*3+ii;
	  if (i1!=cf2 && i1!=cf3 && a[i1][cf1][cf6]==1) rmapos(a,i1,cf1,cf6,poscell,krowcell,kcolcell,ksqrcell);
	  if (Math.floor(cf5/3)!=Math.floor(cf2/3)) 
	  {
	   i2=Math.floor(cf2/3)*3+ii;
	   if (a[i2][cf4][cf6]==1) rmapos(a,i2,cf4,cf6,poscell,krowcell,kcolcell,ksqrcell);
	  } 
	  else if (Math.floor(cf5/3)!=Math.floor(cf3/3))
	  {
	   i2=Math.floor(cf3/3)*3+ii;
	   if (a[i2][cf4][cf6]==1) rmapos(a,i2,cf4,cf6,poscell,krowcell,kcolcell,ksqrcell);
	  } 
     }
	 break;
  }
  needconfirm=1;
  change=true;
 }
 else
 {
  if (curstep==step || (curstep<step && method=="xywt"))
  {
   for(i=0;i<=8;i++)
   {
    if (curstep<step) i=cf1;
    if (rowfill[i]<8)
    {
     for(j1=0;j1<=7;j1++)
     {
	  if (curstep<step) j1=cf2;
      if (poscell[i][j1]==2)
      {	
       for(j2=j1+1;j2<=8;j2++)
       {	
	    if (curstep<step) j2=cf3;
	    if (poscell[i][j2]==2)
        {
	     match=0;
	     for(k=0;k<=8;k++)
	     {
	      if (a[i][j1][k]==1 && a[i][j2][k]==1) 
	      {
	       match++;
	       kmatch=k;
	      }
	      else if (a[i][j1][k]==1 && a[i][j2][k]==0)
	      {
	       k1=k;
	      }
	      else if (a[i][j1][k]==0 && a[i][j2][k]==1)
	      {
	       k2=k;
		  }
	     } 
	     if (match==1)
	     {
	      for(i1=0;i1<=8;i1++)
	      {
		   if (curstep<step) i1=cf4;
		   if (i1!=i)
		   {
	        if (poscell[i1][j1]==2 && a[i1][j1][k1]==1 && a[i1][j1][k2]==1 && a[i1][j2][k2]!=0)
	        {
		     rmapos(a,i1,j2,k2,poscell,krowcell,kcolcell,ksqrcell);
			 if (curstep==dispstep)
			 {
		      hlcell(i*9+j1,red);
		      hlcell(i*9+j2,yellow);
		      hlcell(i1*9+j1,yellow);
		      rmval(i1*9+j2,""+(k2+1),1);
		      hlnumber(i*9+j2,""+(k2+1));
		      hlnumber(i1*9+j1,""+(k2+1));
			 }
             if (curstep==step)
             {			
	          addstep(false,"xywt",""+i+","+j1+","+j2+","+i1+","+k2);
	          addmsg('The red cell '+dcell(i,j1)+' has 2 candidates "'+ddig(Math.min(k1,kmatch))+'" and "'+ddig(Math.max(k1,kmatch))+'".  However, no matter what value this red cell eventually is, one of the yellow cells '+dcell(i,j2)+' and '+dcell(i1,j1)+' must be "'+ddig(k2)+'".  Therefore, "'+ddig(k2)+'" cannot be a candidate for cell '+dcell(i1,j2)+'.');
	          addmsgr('- XY-Wing');
	          next2update();
			} 
            change=true;  
            }	
	        if (!change && poscell[i1][j2]==2 && a[i1][j2][k1]==1 && a[i1][j2][k2]==1 && a[i1][j1][k1]!=0)
	        {
	         rmapos(a,i1,j1,k1,poscell,krowcell,kcolcell,ksqrcell);
			 if (curstep==dispstep)
			 {
		      hlcell(i*9+j1,yellow);
		      hlcell(i*9+j2,red);
		      hlcell(i1*9+j2,yellow);
		      rmval(i1*9+j1,""+(k1+1),1);
		      hlnumber(i*9+j1,""+(k1+1));
		      hlnumber(i1*9+j2,""+(k1+1));
			 }
             if (curstep==step)
             {			
	          addstep(false,"xywt",""+i+","+j1+","+j2+","+i1+","+k1);
	          addmsg('The red cell '+dcell(i,j2)+' has 2 candidates "'+ddig(Math.min(k2,kmatch))+'" and "'+ddig(Math.max(k2,kmatch))+'".  However, no matter what value this red cell eventually is, one of the yellow cells '+dcell(i,j1)+' and '+dcell(i1,j2)+' must be "'+ddig(k1)+'".  Therefore, "'+ddig(k1)+'" cannot be a candidate for cell '+dcell(i1,j1)+'.');
	          addmsgr('- XY-Wing');
	          next2update();
			 } 
             change=true;
            }		   
	       }
		   if (change || curstep<step) break;
	      }
	     }
        }	
	    if (change || curstep<step) break;
       }
	  } 
      if (change || curstep<step) break; 
     }	
    }
    if (change || curstep<step) break;
   }
  }
 
  if (!change && (curstep==step || (curstep<step && method=="xywr")))
  {
   for(i=0;i<=8;i++)
   {
    if (curstep<step) i=cf1;
    for(j1=0;j1<=7;j1++)
    { 
     if (curstep<step) j1=cf2;
     if (poscell[i][j1]==2)
	 {
      isqr1=rc2sqr(i,j1);
      for(j2=j1+1;j2<=8;j2++)
      {
       if (curstep<step) j2=cf3;
       isqr2=rc2sqr(i,j2);
	   if (isqr1!=isqr2 && poscell[i][j2]==2)
       {
	    match=0;
	    for(k=0;k<=8;k++)
	    {
	     if (a[i][j1][k]==1 && a[i][j2][k]==1) 
	     {
	      match++;
	      kmatch=k;
	     }
	     else if (a[i][j1][k]==1 && a[i][j2][k]==0)
	     {
	      k1=k;
	     }
	     else if (a[i][j1][k]==0 && a[i][j2][k]==1)
	     {
	      k2=k;
	     }
	    } 
	    if (match==1 & isqr1!=isqr2)
	    {
	     for(ii=0;ii<=2;ii++)
	     {
	      newi1=sqrc2r(isqr1,ii);
		  if (curstep<step && rc2sqr(cf4,cf5)==isqr1) newi1=cf4;
		  if (newi1!=i || curstep<step)
		  {
	       for(jj=0;jj<=2;jj++)
	       {
		    newj1=sqrc2c(isqr1,jj);
		    if (curstep<step && rc2sqr(cf4,cf5)==isqr1) newj1=cf5;
	        if (poscell[newi1][newj1]==2 && a[newi1][newj1][k1]==1 && a[newi1][newj1][k2]==1)
	        {
             for(rjindex=0;rjindex<=2;rjindex++)
             {
              jindex1=sqrc2c(isqr1,rjindex);
		      jindex2=sqrc2c(isqr2,rjindex);
              if ((i!=newi1 || jindex1!=newj1) && a[i][jindex1][k2]!=0)
              { 		  
		       rmapos(a,i,jindex1,k2,poscell,krowcell,kcolcell,ksqrcell);
			   if (curstep==dispstep) rmval(i*9+jindex1,""+(k2+1),1);
               change=true;  
		      }
              if ((i!=newi1 || jindex2!=j2) && a[newi1][jindex2][k2]!=0)
              {
		       rmapos(a,newi1,jindex2,k2,poscell,krowcell,kcolcell,ksqrcell);
			   if (curstep==dispstep) rmval(newi1*9+jindex2,""+(k2+1),1);
               change=true;  
		      }
		     }		  
            }
		    if (change) 
		    {
		     if (curstep==dispstep)
			 {
		      hlcell(i*9+j1,red);
		      hlcell(i*9+j2,yellow);
		      hlcell(newi1*9+newj1,yellow);
			  hlnumber(i*9+j2,""+(k2+1));
			  hlnumber(newi1*9+newj1,""+(k2+1));
			 }
             if (curstep==step)
             {			
	          addstep(false,"xywr",""+i+","+j1+","+j2+","+newi1+","+newj1+","+k2);
	          addmsg('The red cell '+dcell(i,j1)+' has 2 candidates "'+ddig(Math.min(k1,kmatch))+'" and "'+ddig(Math.max(k1,kmatch))+'".  However, no matter what value this red cell eventually is, one of the yellow cells '+dcell(i,j2)+' and '+dcell(newi1,newj1)+' must be "'+ddig(k2)+'".  Therefore, "'+ddig(k2)+'" cannot be a candidate for those cells that share the same block with one of the yellow cells and simultaneously share the same row with the other yellow cell.');
	          addmsgr('- XY-Wing');
	          next2update();
			 } 
		    } 
		    else
		    {
	         if (curstep<step && rc2sqr(cf4,cf5)==isqr2)
			 {
			  newi2=cf4;
		      newj2=cf5;			
		     } 
		     else
			 {
			  newi2=sqrc2r(isqr2,ii);
		      newj2=sqrc2c(isqr2,jj);
			 }
	         if (poscell[newi2][newj2]==2 && a[newi2][newj2][k1]==1 && a[newi2][newj2][k2]==1)
	         {
              for(rjindex=0;rjindex<=2;rjindex++)
              {
               jindex1=sqrc2c(isqr1,rjindex);
		       jindex2=sqrc2c(isqr2,rjindex);
               if ((i!=newi2 || jindex2!=newj2) && a[i][jindex2][k1]!=0)
               { 		  
		        rmapos(a,i,jindex2,k1,poscell,krowcell,kcolcell,ksqrcell);
			    if (curstep==dispstep) rmval(i*9+jindex2,""+(k1+1),1);
                change=true;  
		       }
               if ((i!=newi2 || jindex1!=j1) && a[newi2][jindex1][k1]!=0)
               {
		        rmapos(a,newi2,jindex1,k1,poscell,krowcell,kcolcell,ksqrcell);
			    if (curstep==dispstep) rmval(newi2*9+jindex1,""+(k1+1),1);
                change=true; 
               } 			  
		      }
		     }
             if (change) 
		     {
			  if (curstep==dispstep)
			  {
		       hlcell(i*9+j1,yellow);
		       hlcell(i*9+j2,red);
		       hlcell(newi2*9+newj2,yellow);
			   hlnumber(i*9+j1,""+(k1+1));
			   hlnumber(newi2*9+newj2,""+(k1+1));
			  }
              if (curstep==step)
              {			 
	           addstep(false,"xywr",""+i+","+j1+","+j2+","+newi2+","+newj2+","+k1);
	           addmsg('The red cell '+dcell(i,j2)+' has 2 candidates "'+ddig(Math.min(k2,kmatch))+'" and "'+ddig(Math.max(k2,kmatch))+'".  However, no matter what value this red cell eventually is, one of the yellow cells '+dcell(i,j1)+' and '+dcell(newi2,newj2)+' must be "'+ddig(k1)+'".  Therefore, "'+ddig(k1)+'" cannot be a candidate for those cells that share the same block with one of the yellow cells and simultaneously share the same row with the other yellow cell.');
	           addmsgr('- XY-Wing');
	           next2update();
			  } 
             }			
            }
		    if (change || curstep<step) break;
	       }
		  } 
		  if (change || curstep<step) break;
	     }
	    } 
       }	
	   if (change || curstep<step) break;
      }
	 } 
     if (change || curstep<step) break; 
    }	
    if (change || curstep<step) break;
   }
  }

  if (!change && (curstep==step || (curstep<step && method=="xywc")))
  {
   for(j=0;j<=8;j++)
   {
    if (curstep<step) j=cf1;
    for(i1=0;i1<=7;i1++)
    { 
     if (curstep<step) i1=cf2;
     if (poscell[i1][j]==2)
	 {
      isqr1=rc2sqr(i1,j);
      for(i2=i1+1;i2<=8;i2++)
      {	
       if (curstep<step) i2=cf3;
       isqr2=rc2sqr(i2,j);
	   if (isqr1!=isqr2 && poscell[i2][j]==2)
       {
	    match=0;
	    for(k=0;k<=8;k++)
	    {
	     if (a[i1][j][k]==1 && a[i2][j][k]==1) 
	     {
	      match++;
	      kmatch=k;
	     }
	     else if (a[i1][j][k]==1 && a[i2][j][k]==0)
	     {
	      k1=k;
	     }
	     else if (a[i1][j][k]==0 && a[i2][j][k]==1)
	     {
	      k2=k;
	     }
	    } 
	    if (match==1 & isqr1!=isqr2)
	    {
	     for(jj=0;jj<=2;jj++)
	     {
		  newj1=sqrc2c(isqr1,jj);
          if (curstep<step && rc2sqr(cf5,cf4)==isqr1) newj1=cf4;
		  if (newj1!=j || curstep<step)
		  {
	       for(ii=0;ii<=2;ii++)
	       {
	        newi1=sqrc2r(isqr1,ii);
            if (curstep<step && rc2sqr(cf5,cf4)==isqr1) newi1=cf5;
	        if (poscell[newi1][newj1]==2 && a[newi1][newj1][k1]==1 && a[newi1][newj1][k2]==1)
	        {
             for(riindex=0;riindex<=2;riindex++)
             {
              iindex1=sqrc2r(isqr1,riindex);
		      iindex2=sqrc2r(isqr2,riindex);
              if ((j!=newj1 || iindex1!=newi1) && a[iindex1][j][k2]!=0)
              { 		  
		       rmapos(a,iindex1,j,k2,poscell,krowcell,kcolcell,ksqrcell);
			   if (curstep==dispstep) rmval(iindex1*9+j,""+(k2+1),1);
               change=true;  
		      }
              if ((j!=newj1 || iindex2!=i2) && a[iindex2][newj1][k2]!=0)
              {
		       rmapos(a,iindex2,newj1,k2,poscell,krowcell,kcolcell,ksqrcell);
			   if (curstep==dispstep) rmval(iindex2*9+newj1,""+(k2+1),1);
               change=true;  
		      }
		     }		  
            }
		    if (change) 
		    {
		     if (curstep==dispstep)
			 {
		      hlcell(i1*9+j,red);
		      hlcell(i2*9+j,yellow);
		      hlcell(newi1*9+newj1,yellow);
			  hlnumber(i2*9+j,""+(k2+1));
			  hlnumber(newi1*9+newj1,""+(k2+1));
			 }
             if (curstep==step)
             {			
	          addstep(false,"xywc",""+j+","+i1+","+i2+","+newj1+","+newi1+","+k2);
	          addmsg('The red cell '+dcell(i1,j)+' has 2 candidates "'+ddig(Math.min(k1,kmatch))+'" and "'+ddig(Math.max(k1,kmatch))+'".  However, no matter what value this red cell eventually is, one of the yellow cells '+dcell(i2,j)+' and '+dcell(newi1,newj1)+' must be "'+ddig(k2)+'".  Therefore, "'+ddig(k2)+'" cannot be a candidate for those cells that share the same block with one of the yellow cells and simultaneously share the same column with the other yellow cell.');
	          addmsgr('- XY-Wing');
	          next2update();
			 } 
		    }
		    else
		    {
             if (curstep<step && rc2sqr(cf5,cf4)==isqr2)
             {
	          newi2=cf5;
		      newj2=cf4;			 
			 }			
		     else
			 {
	          newi2=sqrc2r(isqr2,ii);
		      newj2=sqrc2c(isqr2,jj);
			 }
	         if (poscell[newi2][newj2]==2 && a[newi2][newj2][k1]==1 && a[newi2][newj2][k2]==1)
	         {
              for(riindex=0;riindex<=2;riindex++)
              {
               iindex1=sqrc2r(isqr1,riindex);
		       iindex2=sqrc2r(isqr2,riindex);
               if ((j!=newj2 || iindex2!=newi2) && a[iindex2][j][k1]!=0)
               { 		  
		        rmapos(a,iindex2,j,k1,poscell,krowcell,kcolcell,ksqrcell);
			    if (curstep==dispstep) rmval(iindex2*9+j,""+(k1+1),1);
                change=true;  
		       }
               if ((j!=newj2 || iindex1!=i1) && a[iindex1][newj2][k1]!=0)
               {
		        rmapos(a,iindex1,newj2,k1,poscell,krowcell,kcolcell,ksqrcell);
			    if (curstep==dispstep) rmval(iindex1*9+newj2,""+(k1+1),1);
                change=true;  
		       } 
		      }		  
             }
		     if (change) 
		  	 {
			  if (curstep==dispstep) 
			  {
		       hlcell(i1*9+j,yellow);
		       hlcell(i2*9+j,red);
			   hlcell(newi2*9+newj2,yellow);
			   hlnumber(i1*9+j,""+(k1+1));
			   hlnumber(newi2*9+newj2,""+(k1+1));
			  }
              if (curstep==step)
              { 			 
	           addstep(false,"xywc",""+j+","+i1+","+i2+","+newj2+","+newi2+","+k1);
	           addmsg('The red cell '+dcell(i2,j)+' has 2 candidates "'+ddig(Math.min(k2,kmatch))+'" and "'+ddig(Math.max(k2,kmatch))+'".  However, no matter what value this red cell eventually is, one of the yellow cells '+dcell(i1,j)+' and '+dcell(newi2,newj2)+' must be "'+ddig(k1)+'".  Therefore, "'+ddig(k1)+'" cannot be a candidate for those cells that share the same block with one of the yellow cells and simultaneously share the same column with the other yellow cell.');
	           addmsgr('- XY-Wing');
	           next2update();
			  } 
			 } 
		    }
		    if (change || curstep<step) break;
	       }
		  } 
		  if (change || curstep<step) break;
	     }
	    } 
       }	
	   if (change || curstep<step) break;
      }
	 }  
     if (change || curstep<step) break; 
    }	
    if (change || curstep<step) break;
   }
  } 
  if (change) needconfirm=1;
 }
 return change;
} 

function xyzwing(a,poscell,krowcell,kcolcell,ksqrcell)
{
 var i,j,i1,i2,j1,j2,k,k1,isqr1,isqr2,ii,jj,newi,newj,riindex,iindex,rjindex,jindex;
 var kmatch=new Array(2),match,change=false,method="";
 if (curstep<step)
 {
  method=solvedsqn[curstep].substr(0,solvedsqn[curstep].indexOf(":"));
  var cellinfo=solvedsqn[curstep].substr(solvedsqn[curstep].indexOf(":")+1);	
  var cf1=cellinfo.substr(0,1)*1, cf2=cellinfo.substr(2,1)*1, cf3=cellinfo.substr(4,1)*1;
  var cf4=cellinfo.substr(6,1)*1, cf5=cellinfo.substr(8,1)*1, cf6=cellinfo.substr(10,1)*1;
 }
 if (curstep<dispstep)
 {
  switch (method)
  {
   case "xyzwr":
     for (jj=0;jj<3;jj++)
	 {
	  j1=Math.floor(cf2/3)*3+jj;
	  if (j1!=cf2 && a[cf1][j1][cf6]==1) rmapos(a,cf1,j1,cf6,poscell,krowcell,kcolcell,ksqrcell);
     }
	 break;
   case "xyzwc":
     for (ii=0;ii<3;ii++)
	 {
	  i1=Math.floor(cf2/3)*3+ii;
	  if (i1!=cf2 && a[i1][cf1][cf6]==1) rmapos(a,i1,cf1,cf6,poscell,krowcell,kcolcell,ksqrcell);
     }
	 break;
  }
  needconfirm=1;
  change=true;
 }
 else
 { 
  if (curstep==step || (curstep<step && method=="xyzwr"))
  {
   for(i=0;i<=8;i++)
   {
    if (curstep<step) i=cf1;
    if (rowfill[i]<=6)
    {
     for(j1=0;j1<=8;j1++)
     {
	  if (curstep<step) j1=cf2;
      isqr1=rc2sqr(i,j1);   
      if (poscell[i][j1]==3)
      {
       for(j2=0;j2<=8;j2++)
	   {
	    if (curstep<step) j2=cf3;
	    isqr2=rc2sqr(i,j2);
        if (isqr1!=isqr2 && poscell[i][j2]==2)
        {
	     match=0;
	     for(k=0;k<=8;k++)
	     {
	      if (a[i][j1][k]==1 && a[i][j2][k]==1) 
	      {
	       kmatch[match]=k;
	       match++;
	      }
	      else if (a[i][j1][k]==1 && a[i][j2][k]==0)
	      {
	       k1=k;
	      }
	     } 
	     if (match==2)
	     { 
	      for(ii=0;ii<=2;ii++)
	      {
	       if (curstep<step) ii=cf4;
		   newi=sqrc2r(isqr1,ii);
		   if (newi!=i)
		   {
	        for(jj=0;jj<=2;jj++)
		    {
	         if (curstep<step) jj=cf5;
		     newj=sqrc2c(isqr1,jj);
	         if (poscell[newi][newj]==2 && a[newi][newj][k1]==1 && a[newi][newj][kmatch[0]]==1)
	         {
		      for(rjindex=0;rjindex<=2;rjindex++)
		      {
		       jindex=sqrc2c(isqr1,rjindex);
		       if (jindex!=j1 && a[i][jindex][kmatch[0]]!=0)
		       {
		        rmapos(a,i,jindex,kmatch[0],poscell,krowcell,kcolcell,ksqrcell);
			    if (curstep==dispstep) rmval(i*9+jindex,""+(kmatch[0]+1),1);
                change=true;  
               }
              }
			  if (change)
			  {
			   if (curstep==dispstep)
			   {
			    hlcell(i*9+j1,red);
			    hlcell(i*9+j2,yellow);
			    hlcell(newi*9+newj,yellow);
			    hlnumber(i*9+j1,""+(kmatch[0]+1));
			    hlnumber(i*9+j2,""+(kmatch[0]+1));
			    hlnumber(newi*9+newj,""+(kmatch[0]+1));
			   }
               if (curstep==step)
               {			  
	            addstep(false,"xyzwr",""+i+","+j1+","+j2+","+ii+","+jj+","+kmatch[0]);
	            addmsg('The red cell '+dcell(i,j1)+' has 3 candidates "'+ddig(Math.min(k1,kmatch[0]))+'", "'+ddig(Math.min(Math.max(k1,kmatch[0]),kmatch[1]))+'" and "'+ddig(Math.max(k1,kmatch[1]))+'".  No matter what value this red cell eventually is, it will be either the red cell itself is "'+ddig(kmatch[0])+'" or one of the yellow cells '+dcell(i,j2)+' and '+dcell(newi,newj)+' is "'+ddig(kmatch[0])+'".  Therefore, "'+ddig(kmatch[0])+'" cannot be a candidate for those cells that share the same row with the red cell '+dcell(i,j1)+' and one yellow cell '+dcell(i,j2)+', and simultaneously share the same square with the other yellow cell '+dcell(newi,newj)+'.');
	            addmsgr('- XYZ-Wing');
	            next2update();
			   } 
			  }
             } 		  
	         else if (newi!=i && poscell[newi][newj]==2 && a[newi][newj][k1]==1 && a[newi][newj][kmatch[1]]==1)
	         {
		      for(rjindex=0;rjindex<=2;rjindex++)
		      {
		       jindex=sqrc2c(isqr1,rjindex);
		       if (jindex!=j1 && a[i][jindex][kmatch[1]]!=0)
		       {
		        rmapos(a,i,jindex,kmatch[1],poscell,krowcell,kcolcell,ksqrcell);
			    if (curstep==dispstep) rmval(i*9+jindex,""+(kmatch[1]+1),1);
                change=true;  
               }
              }
			  if (change)
			  {
			   if (curstep==dispstep)
			   {
			    hlcell(i*9+j1,red);
			    hlcell(i*9+j2,yellow);
			    hlcell(newi*9+newj,yellow);
			    hlnumber(i*9+j1,""+(kmatch[1]+1));
			    hlnumber(i*9+j2,""+(kmatch[1]+1));
			    hlnumber(newi*9+newj,""+(kmatch[1]+1));
			   }
               if (curstep==step)
               {			  
	            addstep(false,"xyzwr",""+i+","+j1+","+j2+","+ii+","+jj+","+kmatch[1]);
	            addmsg('The red cell '+dcell(i,j1)+' has 3 candidates "'+ddig(Math.min(k1,kmatch[0]))+'", "'+ddig(Math.min(Math.max(k1,kmatch[0]),kmatch[1]))+'" and "'+ddig(Math.max(k1,kmatch[1]))+'".  No matter what value this red cell eventually is, it will be either the red cell itself is "'+ddig(kmatch[1])+'" or one of the yellow cells '+dcell(i,j2)+' and '+dcell(newi,newj)+' is "'+ddig(kmatch[1])+'".  Therefore, "'+ddig(kmatch[1])+'" cannot be a candidate for those cells that share the same row with the red cell '+dcell(i,j1)+' and one yellow cell '+dcell(i,j2)+', and simultaneously share the same square with the other yellow cell '+dcell(newi,newj)+'.');
	            addmsgr('- XYZ-Wing');
	            next2update();
			   } 
			  }
             }
			 if (change || curstep<step) break;
		    } 
           }
           if (change || curstep<step) break;
          }		
	     }
	    }	
	    if (change || curstep<step) break;
	   }
      }
      if (change || curstep<step) break;   
     }
    }
    if (change || curstep<step) break;
   }
  }
  
  if (!change && (curstep==step || (curstep<step && method=="xyzwc")))
  {
   for(j=0;j<=8;j++)
   {
    if (curstep<step) j=cf1;
    if (colfill[j]<=6)
    {
     for(i1=0;i1<=8;i1++)
     {
      if (curstep<step) i1=cf2;
      isqr1=rc2sqr(i1,j);   
      if (poscell[i1][j]==3)
      {
       for(i2=0;i2<=8;i2++)
	   {
        if (curstep<step) i2=cf3;
	    isqr2=rc2sqr(i2,j);
        if (isqr1!=isqr2 && poscell[i2][j]==2)
        {
	     match=0;
	     for(k=0;k<=8;k++)
	     {
	      if (a[i1][j][k]==1 && a[i2][j][k]==1) 
	      {
	       kmatch[match]=k;
	       match++;
	      }
	      else if (a[i1][j][k]==1 && a[i2][j][k]==0)
	      {
	       k1=k;
	      }
	     } 
	     if (match==2)
	     { 
	      for(jj=0;jj<=2;jj++)
	      {
		   if (curstep<step) jj=cf4;
		   newj=sqrc2c(isqr1,jj);
		   if (newj!=j)
		   {
	        for(ii=0;ii<=2;ii++)
		    { 
		     if (curstep<step) ii=cf5;
		     newi=sqrc2r(isqr1,ii);
	         if (poscell[newi][newj]==2 && a[newi][newj][k1]==1 && a[newi][newj][kmatch[0]]==1)
	         {
		      for(riindex=0;riindex<=2;riindex++)
		      {
		       iindex=sqrc2r(isqr1,riindex);
		       if (iindex!=i1 && a[iindex][j][kmatch[0]]!=0)
		       {
		        rmapos(a,iindex,j,kmatch[0],poscell,krowcell,kcolcell,ksqrcell);
			    if (curstep==dispstep) rmval(iindex*9+j,""+(kmatch[0]+1),1);
                change=true;  
               }
              }
			  if (change)
			  {
			   if (curstep==dispstep)
			   {
			    hlcell(i1*9+j,red);
			    hlcell(i2*9+j,yellow);
			    hlcell(newi*9+newj,yellow);
			    hlnumber(i1*9+j,""+(kmatch[0]+1));
			    hlnumber(i2*9+j,""+(kmatch[0]+1));
			    hlnumber(newi*9+newj,""+(kmatch[0]+1));
			   }
               if (curstep==step)
               {			  
	            addstep(false,"xyzwc",""+j+","+i1+","+i2+","+jj+","+ii+","+kmatch[0]);
	            addmsg('The red cell '+dcell(i1,j)+' has 3 candidates "'+ddig(Math.min(k1,kmatch[0]))+'", "'+ddig(Math.min(Math.max(k1,kmatch[0]),kmatch[1]))+'" and "'+ddig(Math.max(k1,kmatch[1]))+'".  No matter what value this red cell eventually is, it will be either the red cell itself is "'+ddig(kmatch[0])+'" or one of the yellow cells '+dcell(i2,j)+' and '+dcell(newi,newj)+' is "'+ddig(kmatch[0])+'".  Therefore, "'+ddig(kmatch[0])+'" cannot be a candidate for those cells that share the same column with the red cell '+dcell(i1,j)+' and one yellow cell '+dcell(i2,j)+', and simultaneously share the same square with the other yellow cell '+dcell(newi,newj)+'.');
	            addmsgr('- XYZ-Wing');
	            next2update();
			   } 
			  }
             }  		  
	         else if (poscell[newi][newj]==2 && a[newi][newj][k1]==1 && a[newi][newj][kmatch[1]]==1)
	         {
		      for(riindex=0;riindex<=2;riindex++)
		      {
		       iindex=sqrc2r(isqr1,riindex);
		       if (iindex!=i1 && a[iindex][j][kmatch[1]]!=0)
		       {
		        rmapos(a,iindex,j,kmatch[1],poscell,krowcell,kcolcell,ksqrcell);
			    if (curstep==dispstep) rmval(iindex*9+j,""+(kmatch[1]+1),1);
                change=true;  
               }
              }
			  if (change)
			  {
			   if (curstep==dispstep)
			   {
			    hlcell(i1*9+j,red);
			    hlcell(i2*9+j,yellow);
			    hlcell(newi*9+newj,yellow);
			    hlnumber(i1*9+j,""+(kmatch[1]+1));
			    hlnumber(i2*9+j,""+(kmatch[1]+1));
			    hlnumber(newi*9+newj,""+(kmatch[1]+1));
			   }
               if (curstep==step)
               {			  
	            addstep(false,"xyzwc",""+j+","+i1+","+i2+","+jj+","+ii+","+kmatch[1]);
	            addmsg('The red cell '+dcell(i1,j)+' has 3 candidates "'+ddig(Math.min(k1,kmatch[0]))+'", "'+ddig(Math.min(Math.max(k1,kmatch[0]),kmatch[1]))+'" and "'+ddig(Math.max(k1,kmatch[1]))+'".  No matter what value this red cell eventually is, it will be either the red cell itself is "'+ddig(kmatch[1])+'" or one of the yellow cells '+dcell(i2,j)+' and '+dcell(newi,newj)+' is "'+ddig(kmatch[1])+'".  Therefore, "'+ddig(kmatch[1])+'" cannot be a candidate for those cells that share the same column with the red cell '+dcell(i1,j)+' and one yellow cell '+dcell(i2,j)+', and simultaneously share the same square with the other yellow cell '+dcell(newi,newj)+'.');
	            addmsgr('- XYZ-Wing');
	            next2update();
			   } 
			  }
             }
	         if (change || curstep<step) break;
            }
		   }
	       if (change || curstep<step) break;
          }		
	     }
	    }	
	    if (change || curstep<step) break;
	   }
      }
      if (change || curstep<step) break;
     }	 
    }
    if (change || curstep<step) break;
   }  
  }
  if (change) needconfirm=1;
 }
 return change;
} 

function colorforce(a,poscell,krowcell,kcolcell,ksqrcell)
{
 var change=false,i,j,k,isqr,ii,jj,icount,nchange=0,chainlimit;
 var ipick=new Array(2),jpick=new Array(2),kpick=new Array(2);
 
 for (chainlimit=2;chainlimit<5;chainlimit++)
 { 
  for(i=0;i<=8;i++)
  {
   for(j=0;j<=8;j++)
   {
    if (poscell[i][j]==2)
    {
     icount=0;
	 for(k=0;k<=8;k++)
     {
	  if (a[i][j][k]==1)
	  {
	   ipick[icount]=i;
	   jpick[icount]=j;
	   kpick[icount]=k;
	   icount++;	  
	  }
	 }
	 change=forcematch(a,ipick,jpick,kpick,poscell,krowcell,kcolcell,ksqrcell,chainlimit,0);
	 if (change) break
    }
   }
   if (change) break;
  }
  if (change) break;

  for(k=0;k<=8;k++)
  {
   for(i=0;i<=8;i++)
   {
    if (krowcell[i][k]==2)
    {
     icount=0;
	 for(j=0;j<=8;j++)
     {
	  if (a[i][j][k]==1)
	  {
	   ipick[icount]=i;
	   jpick[icount]=j;
	   kpick[icount]=k;
	   icount++;	  
	  }
	 }
	 change=forcematch(a,ipick,jpick,kpick,poscell,krowcell,kcolcell,ksqrcell,chainlimit,1);
     if (change) break;
    }
   }
   if (change) break;
  }
  if (change) break;
  
  for(k=0;k<=8;k++)
  {
   for(j=0;j<=8;j++)
   {
    if (kcolcell[j][k]==2)
    {
     icount=0;
	 for(i=0;i<=8;i++)
     {
	  if (a[i][j][k]==1)
	  {
	   ipick[icount]=i;
	   jpick[icount]=j;
	   kpick[icount]=k;
	   icount++;  
	  }
	 }
	 change=forcematch(a,ipick,jpick,kpick,poscell,krowcell,kcolcell,ksqrcell,chainlimit,2);
     if (change) break;
    }
   }
   if (change) break;
  }
  if (change) break;

  for(k=0;k<=8;k++)
  {
   for(isqr=0;isqr<=8;isqr++)
   {
    if (ksqrcell[isqr][k]==2)
    {
     icount=0;
     for(ii=0;ii<=2;ii++)
     {
      for(jj=0;jj<=2;jj++)
      {
       i=sqrc2r(isqr,ii);
       j=sqrc2c(isqr,jj);
	   if (a[i][j][k]==1)
	   {
	    ipick[icount]=i;
	    jpick[icount]=j;
	    kpick[icount]=k;
	    icount++;	  
	   }
	  }
	 } 
	 change=forcematch(a,ipick,jpick,kpick,poscell,krowcell,kcolcell,ksqrcell,chainlimit,3);
     if (change) break;
    }
   }
   if (change) break;
  }
  if (change) break;
 }
 if (change) needconfirm=1;
 return change;
}

function forcematch(a,ipick,jpick,kpick,poscell,krowcell,kcolcell,ksqrcell,chainlimit,ftype)
{
 var atemp1=new Array(9),atemp2=new Array(9);
 var postemp1=new Array(9),krowtemp1=new Array(9),kcoltemp1=new Array(9),ksqrtemp1=new Array(9);
 var postemp2=new Array(9),krowtemp2=new Array(9),kcoltemp2=new Array(9),ksqrtemp2=new Array(9);
 var change=0,i,j,k,dumchange=new Array(1,1),iwinlose=new Array(2),celldtm=new Array("",""),iref,jref,kref,kidx,method,foundmatch="",maxstep,chainfinal=new Array(2),foundcell;
 chainstep=new Array(1,1);
 chainval=new Array("","");
 chainfinal=new Array("","");
 for(i=0;i<=8;i++) 
 {
  atemp1[i]=new Array(9);
  atemp2[i]=new Array(9);
  postemp1[i]=new Array(9);
  krowtemp1[i]=new Array(9);
  kcoltemp1[i]=new Array(9);
  ksqrtemp1[i]=new Array(9);
  postemp2[i]=new Array(9);
  krowtemp2[i]=new Array(9);
  kcoltemp2[i]=new Array(9);
  ksqrtemp2[i]=new Array(9);
 }
 for(i=0;i<=8;i++)
 {
  for(j=0;j<=8;j++)
  {
   atemp1[i][j]=new Array(9);
   atemp2[i][j]=new Array(9);
  }
 }
 for (i=0;i<=8;i++)
 {
  for (j=0;j<=8;j++) 
  {
   postemp1[i][j]=poscell[i][j];
   krowtemp1[i][j]=krowcell[i][j];
   kcoltemp1[i][j]=kcolcell[i][j];
   ksqrtemp1[i][j]=ksqrcell[i][j];
   postemp2[i][j]=poscell[i][j];
   krowtemp2[i][j]=krowcell[i][j];
   kcoltemp2[i][j]=kcolcell[i][j];
   ksqrtemp2[i][j]=ksqrcell[i][j];   
   for (k=0;k<=8;k++) 
   {
    atemp1[i][j][k]=a[i][j][k];
    atemp2[i][j][k]=a[i][j][k];
   }
  }
 }
 var icount=0;
 chaingotacell(0,0,atemp1,ipick[0],jpick[0],kpick[0],postemp1,krowtemp1,kcoltemp1,ksqrtemp1); 
 chainstep[0]=chainval[0].substring(chainval[0].lastIndexOf("/")+1,chainval[0].lastIndexOf(":"))*1;
 chaingotacell(1,0,atemp2,ipick[1],jpick[1],kpick[1],postemp2,krowtemp2,kcoltemp2,ksqrtemp2);
 chainstep[1]=chainval[1].substring(chainval[1].lastIndexOf("/")+1,chainval[1].lastIndexOf(":"))*1;
 do
 {
  icount++;
  if (dumchange[0]!=0)
  {
   dumchange[0]=0;
   iwinlose[0]="0";
   celldtm[0]=chainfindcells(atemp1,postemp1,krowtemp1,kcoltemp1,ksqrtemp1);
   maxstep=chainstep[0];
   if (celldtm[0]!="") chainstep[0]++;
   while (celldtm[0]!="" && foundmatch=="" && iwinlose[0]=="0") 
   {
    dumchange[0]=1;
	method=celldtm[0].substr(1,1);
	iref=celldtm[0].substr(3,1);
	jref=celldtm[0].substr(4,1);
	kref=celldtm[0].substr(5,1);
    celldtm[0]=celldtm[0].substr(6);
    foundmatch=chaingotacell(0,method,atemp1,iref,jref,kref,postemp1,krowtemp1,kcoltemp1,ksqrtemp1);
    if (chainval[0].substring(chainval[0].lastIndexOf("/")+1,chainval[0].lastIndexOf(":"))*1>maxstep) maxstep=chainval[0].substring(chainval[0].lastIndexOf("/")+1,chainval[0].lastIndexOf(":"))*1;
    if (foundmatch=="" && curstep==step) iwinlose[0]=nsolvedorerr(atemp1,postemp1,krowtemp1,kcoltemp1,ksqrtemp1);
   }
   chainstep[0]=maxstep;   
  }
  if (foundmatch=="" && iwinlose[0]=="0" && dumchange[1]!=0)
  {
   dumchange[1]=0;
   iwinlose[1]="0";
   celldtm[1]=chainfindcells(atemp2,postemp2,krowtemp2,kcoltemp2,ksqrtemp2);
   maxstep=chainstep[1];
   if (celldtm[1]!="") chainstep[1]++;
   while (celldtm[1]!="" && foundmatch=="" && iwinlose[1]=="0") 
   {
    dumchange[1]=1;
	method=celldtm[1].substr(1,1);
	iref=celldtm[1].substr(3,1);
	jref=celldtm[1].substr(4,1);
	kref=celldtm[1].substr(5,1);
    celldtm[1]=celldtm[1].substr(6);
    foundmatch=chaingotacell(1,method,atemp2,iref,jref,kref,postemp2,krowtemp2,kcoltemp2,ksqrtemp2);
    if (chainval[1].substring(chainval[1].lastIndexOf("/")+1,chainval[1].lastIndexOf(":"))*1>maxstep) maxstep=chainval[1].substring(chainval[1].lastIndexOf("/")+1,chainval[1].lastIndexOf(":"))*1;
    if (foundmatch=="" && curstep==step) iwinlose[1]=nsolvedorerr(atemp2,postemp2,krowtemp2,kcoltemp2,ksqrtemp2);
   }	
   chainstep[1]=maxstep;   
  }
 } while (foundmatch=="" && (dumchange[0]!=0 || dumchange[1]!=0) && (iwinlose[0]=="0" && iwinlose[1]=="0") && icount<chainlimit);

 if (foundmatch!="")
 {
  chainfinal[0]=buildpath(chainval[0],foundmatch);
  chainfinal[1]=buildpath(chainval[1],foundmatch);
  var matchcell=foundmatch.split(";");
  if (curstep==step)
  {
   var dummsg,dummethod="";
   switch (ftype)
   {
    case 0:
     dummsg='Cell '+dcell(ipick[0],jpick[0])+' has 2 possibilities "'+ddig(kpick[0])+'" and "'+ddig(kpick[1])+'". ';
	 dummethod="clr";
	 break;
    case 1:
     dummsg='In row '+drow(ipick[0])+', digit "'+ddig(kpick[0])+'" may reside in 2 cells '+dcell(ipick[0],jpick[0])+' and '+dcell(ipick[1],jpick[1])+'. ';
	 dummethod="frc";
	 break;
    case 2:
     dummsg='In column '+dcol(jpick[0])+', digit "'+ddig(kpick[0])+'" may reside in 2 cells '+dcell(ipick[0],jpick[0])+' and '+dcell(ipick[1],jpick[1])+'. ';
	 dummethod="frc";
	 break;
    case 3:
     var dumsqr=rc2sqr(ipick[0],jpick[0]);
     dummsg='In square '+dsqr(dumsqr)+', digit "'+ddig(kpick[0])+'" may reside in 2 cells '+dcell(ipick[0],jpick[0])+' and '+dcell(ipick[1],jpick[1])+'. ';
     if (document.getElementById("sgrid"+dumsqr).className!="subgrido") document.getElementById("sgrid"+dumsqr).className="subgrido";
	 dummethod="frc";
	 break;
   }
   addstep(false,dummethod,""+ipick[0]+","+jpick[0]+","+kpick[0]+","+ipick[1]+","+jpick[1]+","+kpick[1]+">"+foundmatch);
   if (matchcell.length==1) dummsg+='In either case, ';
   else 
   {
    dummsg+='The following results agree in both cases and therefore can be confirmed:';
    addmsg(dummsg);
   }
  } 
  for (i=0;i<matchcell.length;i++)
  {
   iref=matchcell[i].substr(0,1)*1;
   jref=matchcell[i].substr(2,1)*1;
   kref=matchcell[i].substr(5,1)*1;
   if (matchcell[i].indexOf("-")>=0) 
   {
    rmapos(a,iref,jref,kref,poscell,krowcell,kcolcell,ksqrcell);
	if (curstep==step)
	{
	 if (matchcell.length==1)
	 {
	  dummsg+='digit "'+ddig(kref)+'" cannot be a candidate for cell '+dcell(iref,jref)+'.';
      addmsg(dummsg);	 
	 }
	 else addmsg('('+(i+1)+') '+dcell(iref,jref)+' cannot be '+ddig(kref));
	} 
   }	
   else if (matchcell[i].indexOf("+")>=0)
   {
    if (curstep==step)
	{
	 if (matchcell.length==1)
	 {
	  dummsg+='cell '+dcell(iref,jref)+' is "'+ddig(kref)+'" and therefore it must be "'+ddig(kref)+'".';
      addmsg(dummsg);	 
	 }
	 else addmsg('('+(i+1)+') '+dcell(iref,jref)+' must be "'+ddig(kref)+'"');
	} 
    for (j=0;j<t_itemp[iref][jref].length;j++)
	{
	 kidx=t_itemp[iref][jref].substr(j,1)*1-1;
	 if (kidx!=kref) rmapos(a,iref,jref,kidx,poscell,krowcell,kcolcell,ksqrcell);
	}
   }
  }
  if (curstep==step)
  {
   switch (ftype)
   {
    case 0:
     addmsgr('- Coloring');
	 next2update();
	 break;
    case 1:
    case 2:
    case 3:
     addmsgr('- Forcing Chains');
	 next2update();
	 break;
   }	 
  }  
  if (curstep==dispstep) drawpath(chainfinal[0],chainfinal[1]);
  return true;
 }
 else if (iwinlose[0].length>1)
 {
  nischainval=chainval[0];
  nishiopath(iwinlose[0],ipick[0],jpick[0],kpick[0]);
  rmapos(a,ipick[0],jpick[0],kpick[0],poscell,krowcell,kcolcell,ksqrcell);
  return true;
 }
 else if (iwinlose[1].length>1)
 {
  nischainval=chainval[1];
  nishiopath(iwinlose[1],ipick[1],jpick[1],kpick[1]);
  rmapos(a,ipick[1],jpick[1],kpick[1],poscell,krowcell,kcolcell,ksqrcell);
  return true;
 }
 else return false;
}

function chaingotacell(chainno,method,a,iref,jref,kref,poscell,krowcell,kcolcell,ksqrcell)
{
  var n,ii,jj,nrow,ncol,nsquare,dumchange="",matchcell="";
  a[iref][jref][kref]=2;
  dumchange=""+iref+","+jref+",+"+kref;
  chainval[chainno]+="/"+chainstep[chainno]+":"+dumchange+">"+method; //method: 0=guess 1=ns  2=hs-row 3=hs-col  4=hs-sqr
  if (chainval[(chainno+1)%2].indexOf(dumchange)>=0) matchcell=dumchange;
  if (matchcell=="")
  {
   nsquare=rc2sqr(iref,jref); 
   for(n=0;n<=8;n++)
   {
    if (n!=kref && a[iref][jref][n]==1) 
    {
     rmapos(a,iref,jref,n,poscell,krowcell,kcolcell,ksqrcell);
	 dumchange=""+iref+","+jref+",-"+n;
	 chainval[chainno]+="/"+(chainstep[chainno]+1)+":"+dumchange;
     if (chainval[(chainno+1)%2].indexOf(dumchange)>=0) 
	 {
	  if (matchcell.length>0) matchcell+=";"+dumchange;
	  else matchcell+=dumchange;
	 } 
    }
    if (n!=iref && a[n][jref][kref]==1) 
    {
     rmapos(a,n,jref,kref,poscell,krowcell,kcolcell,ksqrcell);
	 dumchange=""+n+","+jref+",-"+kref;
     chainval[chainno]+="/"+(chainstep[chainno]+1)+":"+dumchange;
     if (chainval[(chainno+1)%2].indexOf(dumchange)>=0) 
	 {
	  if (matchcell.length>0) matchcell+=";"+dumchange;
	  else matchcell+=dumchange;
	 } 
    }
    if (n!=jref && a[iref][n][kref]==1)
    {
     rmapos(a,iref,n,kref,poscell,krowcell,kcolcell,ksqrcell);
	 dumchange=""+iref+","+n+",-"+kref;
     chainval[chainno]+="/"+(chainstep[chainno]+1)+":"+dumchange;
     if (chainval[(chainno+1)%2].indexOf(dumchange)>=0) 
	 {
	  if (matchcell.length>0) matchcell+=";"+dumchange;
	  else matchcell+=dumchange;
	 } 
    }	
    nrow=Math.floor(nsquare/3)*3+Math.floor(n/3);
    ncol=(nsquare%3)*3+(n%3);
    if ((nrow!=iref || ncol!=jref) && a[nrow][ncol][kref]==1)
    {
	 rmapos(a,nrow,ncol,kref,poscell,krowcell,kcolcell,ksqrcell);
	 dumchange=""+nrow+","+ncol+",-"+kref;
     chainval[chainno]+="/"+(chainstep[chainno]+1)+":"+dumchange;
     if (chainval[(chainno+1)%2].indexOf(dumchange)>=0) 
	 {
	  if (matchcell.length>0) matchcell+=";"+dumchange;
	  else matchcell+=dumchange;
	 } 
    }
   }	
  }
  return matchcell;
}

function chainfindcells(a,poscell,krowcell,kcolcell,ksqrcell)
{
 var index1,index2,i,j,k,ii,jj,cellfound="";
 
  for(index1=0;index1<=8;index1++)
  {
   for(index2=0;index2<=8;index2++)
   {
    if (poscell[index1][index2]==1)
	{
     for(k=0;k<=8;k++)
     {
      if(a[index1][index2][k]==1) 
	  {
	   if (cellfound=="" || (cellfound.length>0 && cellfound.indexOf(""+index1+index2+k)<0)) cellfound+="/1,"+index1+index2+k;
      } 
     }	 
	}
	if(krowcell[index1][index2]==1)
	{
     for(j=0;j<=8;j++)
     {
      if(a[index1][j][index2]==1) 
	  {
	   if (cellfound=="" || (cellfound.length>0 && cellfound.indexOf(""+index1+j+index2)<0)) cellfound+="/2,"+index1+j+index2;
      } 
     }	 	
	}
	if(kcolcell[index1][index2]==1)
	{
     for(i=0;i<=8;i++)
     {
      if(a[i][index1][index2]==1) 
	  {
	   if (cellfound=="" || (cellfound.length>0 && cellfound.indexOf(""+i+index1+index2)<0)) cellfound+="/3,"+i+index1+index2;
      } 
     }	 	
	}
	if(ksqrcell[index1][index2]==1)
	{
	 for(ii=0;ii<=2;ii++)
	 {
      for(jj=0;jj<=2;jj++)
      {
	   i=sqrc2r(index1,ii);
	   j=sqrc2c(index1,jj);
       if(a[i][j][index2]==1)
	   {
	    if (cellfound=="" || (cellfound.length>0 && cellfound.indexOf(""+i+j+index2)<0)) cellfound+="/4,"+i+j+index2;;
	   }
      }      
	 }
	}
   }	
  }
  return cellfound;
}

function buildpath(chain,foundmatch)
{
 var curcell;
 var matchcell=foundmatch.split(";");
 var chainarray=chain.split("/");
 var staystep=new Array(chainarray.length);
 var gotit=false,finalpath="",i,j,k,iref,jref,kref,isqr,newi,newj,method;
 for (i=0;i<chainarray.length;i++)
 {
  staystep[i]=0;
 }
 for (i=0;i<matchcell.length;i++)
 {
  curcell=matchcell[i];
  keepstep(curcell,chainarray,staystep);
 }
 while (!gotit)
 {
  gotit=true;
  for (i=0;i<staystep.length;i++)
  {
   if (staystep[i]==2)
   {
    gotit=false;
    method=chainarray[i].substr(chainarray[i].length-1)*1;
	switch (method)
	{
	 case 0:
	   break;
	 case 1:
       iref=chainarray[i].substr(chainarray[i].indexOf(":")+1,1)*1;
	   jref=chainarray[i].substr(chainarray[i].indexOf(":")+3,1)*1;
	   kref=chainarray[i].substr(chainarray[i].indexOf("+")+1,1)*1;
	   for (k=0;k<9;k++)
	   {
	    if (t_a[iref][jref][k]==1 && k!=kref) keepstep(""+iref+","+jref+",-"+k,chainarray,staystep);
	   }
	   break;
	 case 2:
       iref=chainarray[i].substr(chainarray[i].indexOf(":")+1,1)*1;
	   jref=chainarray[i].substr(chainarray[i].indexOf(":")+3,1)*1;
	   kref=chainarray[i].substr(chainarray[i].indexOf("+")+1,1)*1;
	   for (k=0;k<9;k++)
	   {
	    if (t_a[iref][k][kref]==1 && k!=jref) keepstep(""+iref+","+k+",-"+kref,chainarray,staystep);
	   }
	   break;
	 case 3:
       iref=chainarray[i].substr(chainarray[i].indexOf(":")+1,1)*1;
	   jref=chainarray[i].substr(chainarray[i].indexOf(":")+3,1)*1;
	   kref=chainarray[i].substr(chainarray[i].indexOf("+")+1,1)*1;
	   for (k=0;k<9;k++)
	   {
	    if (t_a[k][jref][kref]==1 && k!=iref) keepstep(""+k+","+jref+",-"+kref,chainarray,staystep);
	   }
	   break;
	 case 4:
       iref=chainarray[i].substr(chainarray[i].indexOf(":")+1,1)*1;
	   jref=chainarray[i].substr(chainarray[i].indexOf(":")+3,1)*1;
	   isqr=rc2sqr(iref,jref);
	   kref=chainarray[i].substr(chainarray[i].indexOf("+")+1,1)*1;
	   for (k=0;k<9;k++)
	   {
	    newi=Math.floor(isqr/3)*3+Math.floor(k/3);
		newj=(isqr%3)*3+(k%3);
	    if (t_a[newi][newj][kref]==1 && (newi!=iref || newj!=jref)) keepstep(""+newi+","+newj+",-"+kref,chainarray,staystep);
	   }
	   break;
	}
	staystep[i]=1;
   }
  }
 }
 for (i=0;i<staystep.length;i++)
 {
  if (staystep[i]==1)
  {
   if (finalpath.length!=0) finalpath+="/";
   finalpath+=chainarray[i];
  }
 }
 return finalpath;
}

function keepstep(curcell,chainarray,staystep)
{
 var rmpos=(curcell.indexOf("-")>0), chasemode=false;
 for (var i=chainarray.length-1;i>=0;i--)
 {
  if (!chasemode)
  {
   if (chainarray[i].indexOf(curcell)>0)
   {
    if (rmpos) 
	{
     staystep[i]=1;
	 chasemode=true;
	} 
	else 
	{
	 if (staystep[i]==0) staystep[i]=2;
	 break;
	} 
   }
  }
  else if (chainarray[i].indexOf("+")>0)
  {
   if (staystep[i]==0) staystep[i]=2;
   break;
  }  
 }
}

function drawpath(chain1,chain2)
{
 var i,j,k,ii,iref,jref,kref,index,dummsg,dumstep,dumpath,exist,noaction;
 var chainlbl=new Array(2);
 chainlbl[0]=new Array("A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z");
 chainlbl[1]=new Array("a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z");
 var path=new Array(2),chainstep=new Array(2),cval=new Array(2),ocval=new Array(2),hl=new Array(2),steplbl=new Array(2);
 path[0]=chain1.split("/");
 path[1]=chain2.split("/");
 for (i=0;i<2;i++)
 {
  chainstep[i]=new Array(path[i].length);
  cval[i]=new Array(path[i].length);
  ocval[i]=new Array(path[i].length);
  hl[i]=new Array(path[i].length);
  steplbl[i]=new Array(path[i].length);
  for (j=0;j<path[i].length;j++)
  {
   cval[i][j]="";
   ocval[i][j]="";
   hl[i][j]="";
   steplbl[i][j]="";
   chainstep[i][j]=path[i][j].substr(0,path[i][j].indexOf(":"))*1;
   path[i][j]=path[i][j].substr(path[i][j].indexOf(":")+1);
   for (k=0;k<j;k++)
   {
    if (chainstep[i][j]<chainstep[i][k])
	{
	 dumstep=chainstep[i][j];
	 dumpath=path[i][j];
	 for (index=j;index>k;index--)
	 {
	  chainstep[i][index]=chainstep[i][index-1];
	  path[i][index]=path[i][index-1];
	 }
	 chainstep[i][k]=dumstep;
	 path[i][k]=dumpath;
	}
   }
  }
  index=1;
  dumstep=index;
  for (j=1;j<path[i].length;j++)
  {
   if (chainstep[i][j]>dumstep)
   {
    dumstep=chainstep[i][j];
	index++;
	chainstep[i][j]=index;
   }
   else chainstep[i][j]=chainstep[i][j-1];
  }
 }
 for (j=0;j<path[0].length;j++)
 {
  exist=false;
  noaction=false;
  kref=path[0][j].substr(5,1)*1;
  dummsg="";
  if (curstep==step)
  {
   if (j==0 || (j>0 && chainstep[0][j]!=chainstep[0][j-1]))
   {
    if (j==0) c1step('Case 1');
    c1step('Step '+chainlbl[0][chainstep[0][j]-1]+':');
   }
   if (j==0) dummsg+='Suppose '+dcell(path[0][j].substr(0,1)*1,path[0][j].substr(2,1)*1)+' is '+ddig(kref);
   else if (path[0][j].indexOf("-")>=0) dummsg+=dcell(path[0][j].substr(0,1)*1,path[0][j].substr(2,1)*1)+' cannot be '+ddig(kref);
   else if (path[0][j].indexOf("+")>=0) dummsg+=dcell(path[0][j].substr(0,1)*1,path[0][j].substr(2,1)*1)+' must be '+ddig(kref); 
   if (chain2.indexOf(path[0][j].substr(0,6))>=0 || j==0) dummsg='<span class="boldfont">'+dummsg+'</span>';
   c1stepr(dummsg);
  } 
  for (k=j-1;k>=0;k--)
  {
   if (path[0][j].substr(0,4)==path[0][k].substr(0,4))
   {
    exist=true;
	cval[0][j]=cval[0][k];
	ocval[0][j]=ocval[0][k];
	hl[0][j]=hl[0][k];
	if (chainstep[0][j]!=chainstep[0][k]) steplbl[0][j]=steplbl[0][k]+chainlbl[0][chainstep[0][j]-1];
	else steplbl[0][j]=steplbl[0][k];
	break;
   }
  }
  if (!exist)
  {
   for (k=0;k<t_itemp[path[0][j].substr(0,1)*1][path[0][j].substr(2,1)*1].length;k++)
   {
    cval[0][j]+=t_itemp[path[0][j].substr(0,1)*1][path[0][j].substr(2,1)*1].substr(k,1)*1-1;
    ocval[0][j]+="-";
	hl[0][j]+="-";
	steplbl[0][j]=chainlbl[0][chainstep[0][j]-1];
   }
  }
  if (path[0][j].indexOf("-")>0)
  {
   if (!noaction) ocval[0][j]=ocval[0][j].substr(0,cval[0][j].indexOf(""+kref))+"r"+ocval[0][j].substr(cval[0][j].indexOf(""+kref)+1);
  }
  if (!noaction)
  {
   hl[0][j]=hl[0][j].substr(0,cval[0][j].indexOf(""+kref))+(steplbl[0][j].length-1)+hl[0][j].substr(cval[0][j].indexOf(""+kref)+1);
  }
 }
 for (j=0;j<path[1].length;j++)
 {
  exist=false;
  noaction=false;
  kref=path[1][j].substr(5,1)*1;
  dummsg="";
  if (curstep==step)
  {
   if (j==0 || (j>0 && chainstep[1][j]!=chainstep[1][j-1]))
   {
    if (j==0) c2step('Case 2');
    c2step('Step '+chainlbl[1][chainstep[1][j]-1]+':');
   }
   if (j==0) dummsg+='Suppose '+dcell(path[1][j].substr(0,1)*1,path[1][j].substr(2,1)*1)+' is '+ddig(kref);
   else if (path[1][j].indexOf("-")>=0) dummsg+=dcell(path[1][j].substr(0,1)*1,path[1][j].substr(2,1)*1)+' cannot be '+ddig(kref);
   else if (path[1][j].indexOf("+")>=0) dummsg+=dcell(path[1][j].substr(0,1)*1,path[1][j].substr(2,1)*1)+' must be '+ddig(kref); 
   if (chain1.indexOf(path[1][j].substr(0,6))>=0 || j==0) dummsg='<span class="boldfont">'+dummsg+'</span>';
   c2stepr(dummsg);
  } 
  for (k=j-1;k>=0;k--)
  {
   if (path[1][j].substr(0,4)==path[1][k].substr(0,4))
   {
    exist=true;
	cval[1][j]=cval[1][k];
	ocval[1][j]=ocval[1][k];
	hl[1][j]=hl[1][k];
	if (chainstep[1][j]!=chainstep[1][k]) steplbl[1][j]=steplbl[1][k]+chainlbl[1][chainstep[1][j]-1];
	else steplbl[1][j]=steplbl[1][k];
	break;
   }
  }
  if (!exist)
  {
   steplbl[1][j]=chainlbl[1][chainstep[1][j]-1];
   for (k=path[0].length-1;k>=0;k--)
   {
    if (path[1][j].substr(0,4)==path[0][k].substr(0,4))
    {
     exist=true;
	 cval[1][j]=cval[0][k];
	 ocval[1][j]=ocval[0][k];
	 hl[1][j]=hl[0][k];
	 break;
    }   
   } 
  }
  if (!exist)
  {
   for (k=0;k<t_itemp[path[1][j].substr(0,1)*1][path[1][j].substr(2,1)*1].length;k++)
   {
    cval[1][j]+=t_itemp[path[1][j].substr(0,1)*1][path[1][j].substr(2,1)*1].substr(k,1)*1-1;
    ocval[1][j]+="-";
	hl[1][j]+="-";
   }
  }
  if (!noaction)
  {
   if (chain1.indexOf(path[1][j].substr(0,6))>=0) hl[1][j]=hl[1][j].substr(0,cval[1][j].indexOf(""+kref))+"m"+hl[1][j].substr(cval[1][j].indexOf(""+kref)+1);
   else
   {
    if (hl[1][j].substr(cval[1][j].indexOf(""+kref),1)!="-")
	{
     cval[1][j]=cval[1][j].substr(0,cval[1][j].indexOf(""+kref)+1)+kref+cval[1][j].substr(cval[1][j].indexOf(""+kref)+1);
	 if (path[1][j].indexOf("-")>0) ocval[1][j]=ocval[1][j].substr(0,cval[1][j].indexOf(""+kref)+1)+"r"+ocval[1][j].substr(cval[1][j].indexOf(""+kref)+1);
	 else ocval[1][j]=ocval[1][j].substr(0,cval[1][j].indexOf(""+kref)+1)+"-"+ocval[1][j].substr(cval[1][j].indexOf(""+kref)+1);
	 hl[1][j]=hl[1][j].substr(0,cval[1][j].indexOf(""+kref)+1)+(steplbl[1][j].length+4)+hl[1][j].substr(cval[1][j].indexOf(""+kref)+1);
	}
    else
    {
	 if (path[1][j].indexOf("-")>0) ocval[1][j]=ocval[1][j].substr(0,cval[1][j].indexOf(""+kref))+"r"+ocval[1][j].substr(cval[1][j].indexOf(""+kref)+1);
	 hl[1][j]=hl[1][j].substr(0,cval[1][j].indexOf(""+kref))+(steplbl[1][j].length+4)+hl[1][j].substr(cval[1][j].indexOf(""+kref)+1);
	}
   }	
  }
 }
 for (i=1;i>=0;i--)
 {
  for (j=path[i].length-1;j>=0;j--)
  {
   iref=path[i][j].substr(0,1)*1;
   jref=path[i][j].substr(2,1)*1;
   index=iref*9+jref;
   if (document.getElementById('oc'+index).innerHTML=="")
   {
    dumpath="";
	dumstep="";
	for (k=0;k<cval[i][j].length;k++)
	{
	 if (k==4) 
	 {
	  dumpath+=" ";
	  dumstep+=" ";
	 } 
	 if (hl[i][j].substr(k,1)!="-") dumpath+="<span class='chainbg"+hl[i][j].substr(k,1)+"'>";
	 dumpath+=(cval[i][j].substr(k,1)*1+1);
	 if (hl[i][j].substr(k,1)!="-") dumpath+="</span>";
	 if (ocval[i][j].substr(k,1)=="r") dumstep+="\\";
	 else dumstep+="&nbsp;";
	}
	dumstep+="<br>";
	if (i==1)
	{
	 for (k=path[0].length-1;k>=0;k--)
	 {
	  if (path[i][j].substr(0,4)==path[0][k].substr(0,4))
	  {
	   for (ii=0;ii<steplbl[0][k].length;ii++)
	   {
	    dumstep+="<span class='chaintxt"+ii+"'>"+steplbl[0][k].substr(ii,1)+"</span>";
	   }
	   dumstep+=" ";
	   break;
	  }
	 }
	}
	for (ii=0;ii<steplbl[i][j].length;ii++)
	{
	 dumstep+="<span class='chaintxt"+(5*i+ii)+"'>"+steplbl[i][j].substr(ii,1)+"</span>";
	}
	document.getElementById('c'+index).innerHTML=dumpath;
	document.getElementById('oc'+index).innerHTML=dumstep;
	if (dumstep.indexOf(">A<")>=0 && dumstep.indexOf(">a<")>=0) document.getElementById('cell'+index).style.backgroundColor=yellow;
	else if (dumstep.indexOf(">A<")>=0) document.getElementById('cell'+index).style.backgroundColor="#87ccff";
	else if (dumstep.indexOf(">a<")>=0) document.getElementById('cell'+index).style.backgroundColor="#ffcc87";
	if (hl[i][j].indexOf("m")>=0) document.getElementById('oc'+index).style.borderColor=sbuttoncolor;
   }
  }
 }
}

function nishio(a,poscell,krowcell,kcolcell,ksqrcell)
{
 var change=false,i,j,k,isqr,ii,jj,icount,nchange=0,chainlimit,possstart,posslimit;
 var ipick,jpick,kpick;
 
 for (chainlimit=2;chainlimit<12;chainlimit++)
 {
  if (chainlimit>4) possstart=2;
  else possstart=3;
  for (posslimit=possstart;posslimit<8;posslimit++)
  {
   for(i=0;i<=8;i++)
   {
    for(j=0;j<=8;j++)
    {
     if (poscell[i][j]==posslimit)
     {
      icount=0;
	  for(k=0;k<=8;k++)
      {
	   if (a[i][j][k]==1)
	   {
	    ipick=i;
	    jpick=j;
	    kpick=k;
	    change=chknishio(a,ipick,jpick,kpick,poscell,krowcell,kcolcell,ksqrcell,chainlimit);
	    if (change) break
	    icount++;	  
	   }
	  }
	  if (change) break
     }
    }
	if (change) break;
   }	
   if (change) break;

   for(k=0;k<=8;k++)
   {
    for(i=0;i<=8;i++)
    {
     if (krowcell[i][k]==posslimit)
     {
      icount=0;
	  for(j=0;j<=8;j++)
      {
	   if (a[i][j][k]==1)
	   {
	    ipick=i;
	    jpick=j;
	    kpick=k;
	    change=chknishio(a,ipick,jpick,kpick,poscell,krowcell,kcolcell,ksqrcell,chainlimit);
        if (change) break;
	    icount++;	  
	   }
	  }
      if (change) break;
     }
    }
    if (change) break;
   }
   if (change) break;
  
   for(k=0;k<=8;k++)
   {
    for(j=0;j<=8;j++)
    {
     if (kcolcell[j][k]==posslimit)
     {
      icount=0;
	  for(i=0;i<=8;i++)
      {
	   if (a[i][j][k]==1)
	   {
	    ipick=i;
	    jpick=j;
	    kpick=k;
	    icount++;  
	    change=chknishio(a,ipick,jpick,kpick,poscell,krowcell,kcolcell,ksqrcell,chainlimit);
        if (change) break;
	   }
	  }
      if (change) break;
     }
    }
    if (change) break;
   }
   if (change) break;

   for(k=0;k<=8;k++)
   {
    for(isqr=0;isqr<=8;isqr++)
    {
     if (ksqrcell[isqr][k]==posslimit)
     {
      icount=0;
      for(ii=0;ii<=2;ii++)
      {
       for(jj=0;jj<=2;jj++)
       {
        i=sqrc2r(isqr,ii);
        j=sqrc2c(isqr,jj);
	    if (a[i][j][k]==1)
	    {
	     ipick=i;
	     jpick=j;
	     kpick=k;
	     change=chknishio(a,ipick,jpick,kpick,poscell,krowcell,kcolcell,ksqrcell,chainlimit);
         if (change) break;
	     icount++;	  
	    }
	   }
       if (change) break;
	  } 
      if (change) break;
     }
    }
   if (change) break;
   }
   if (change) break;
  }
  if (change) break;  
 }
 if (change) needconfirm=1;
 return change;
}

function chknishio(a,ipick,jpick,kpick,poscell,krowcell,kcolcell,ksqrcell,chainlimit)
{
 var atemp1=new Array(9);
 var postemp1=new Array(9),krowtemp1=new Array(9),kcoltemp1=new Array(9),ksqrtemp1=new Array(9);
 var i,j,k,dumchange=1,iwinlose,celldtm="",iref,jref,kref,kidx,method,maxstep,chainfinal;
 nischainstep=1;
 nischainval="";
 chainfinal="";
 for(i=0;i<=8;i++) 
 {
  atemp1[i]=new Array(9);
  postemp1[i]=new Array(9);
  krowtemp1[i]=new Array(9);
  kcoltemp1[i]=new Array(9);
  ksqrtemp1[i]=new Array(9);
 }
 for(i=0;i<=8;i++)
 {
  for(j=0;j<=8;j++)
  {
   atemp1[i][j]=new Array(9);
  }
 }
 for (i=0;i<=8;i++)
 {
  for (j=0;j<=8;j++) 
  {
   postemp1[i][j]=poscell[i][j];
   krowtemp1[i][j]=krowcell[i][j];
   kcoltemp1[i][j]=kcolcell[i][j];
   ksqrtemp1[i][j]=ksqrcell[i][j];
   for (k=0;k<=8;k++) 
   {
    atemp1[i][j][k]=a[i][j][k];
   }
  }
 }
 var icount=0;
 nisgotacell(0,atemp1,ipick,jpick,kpick,postemp1,krowtemp1,kcoltemp1,ksqrtemp1); 
 nischainstep=nischainval.substring(nischainval.lastIndexOf("/")+1,nischainval.lastIndexOf(":"))*1;
 do
 {
  icount++;
  if (dumchange!=0)
  {
   dumchange=0;
   iwinlose="0";
   celldtm=chainfindcells(atemp1,postemp1,krowtemp1,kcoltemp1,ksqrtemp1);
   maxstep=nischainstep;
   if (celldtm!="") nischainstep++;
   while (celldtm!="" && iwinlose=="0") 
   {
    dumchange=1;
	method=celldtm.substr(1,1);
	iref=celldtm.substr(3,1);
	jref=celldtm.substr(4,1);
	kref=celldtm.substr(5,1);
    celldtm=celldtm.substr(6);
    nisgotacell(method,atemp1,iref,jref,kref,postemp1,krowtemp1,kcoltemp1,ksqrtemp1);
    if (nischainval.substring(nischainval.lastIndexOf("/")+1,nischainval.lastIndexOf(":"))*1>maxstep) maxstep=nischainval.substring(nischainval.lastIndexOf("/")+1,nischainval.lastIndexOf(":"))*1;
    iwinlose=nsolvedorerr(atemp1,postemp1,krowtemp1,kcoltemp1,ksqrtemp1);
   }
   nischainstep=maxstep;   
  }
 } while (dumchange!=0 && iwinlose=="0" && icount<chainlimit);

 if (iwinlose.length>1)
 {
  if (curstep==dispstep) nishiopath(iwinlose,ipick,jpick,kpick);
  rmapos(a,ipick,jpick,kpick,poscell,krowcell,kcolcell,ksqrcell);
  return true;
 }
 else return false;
}

function nisgotacell(method,a,iref,jref,kref,poscell,krowcell,kcolcell,ksqrcell)
{
  var n,ii,jj,nrow,ncol,nsquare,dumchange="",matchcell="";
  a[iref][jref][kref]=2;
  dumchange=""+iref+","+jref+",+"+kref;
  nischainval+="/"+nischainstep+":"+dumchange+">"+method; //method: 0=guess 1=ns  2=hs-row 3=hs-col  4=hs-sqr
   nsquare=rc2sqr(iref,jref); 
   for(n=0;n<=8;n++)
   {
    if (n!=kref && a[iref][jref][n]==1) 
    {
     rmapos(a,iref,jref,n,poscell,krowcell,kcolcell,ksqrcell);
	 dumchange=""+iref+","+jref+",-"+n;
	 nischainval+="/"+(nischainstep+1)+":"+dumchange;
    }
    if (n!=iref && a[n][jref][kref]==1) 
    {
     rmapos(a,n,jref,kref,poscell,krowcell,kcolcell,ksqrcell);
	 dumchange=""+n+","+jref+",-"+kref;
     nischainval+="/"+(nischainstep+1)+":"+dumchange;
    }
    if (n!=jref && a[iref][n][kref]==1)
    {
     rmapos(a,iref,n,kref,poscell,krowcell,kcolcell,ksqrcell);
	 dumchange=""+iref+","+n+",-"+kref;
     nischainval+="/"+(nischainstep+1)+":"+dumchange;
    }	
    nrow=Math.floor(nsquare/3)*3+Math.floor(n/3);
    ncol=(nsquare%3)*3+(n%3);
    if ((nrow!=iref || ncol!=jref) && a[nrow][ncol][kref]==1)
    {
	 rmapos(a,nrow,ncol,kref,poscell,krowcell,kcolcell,ksqrcell);
	 dumchange=""+nrow+","+ncol+",-"+kref;
     nischainval+="/"+(nischainstep+1)+":"+dumchange;
    }	
  }
}

function nishiopath(ncode,iidx,jidx,kidx)
{
 var viocode=ncode.substr(0,1)*1,index1=ncode.substr(2,1)*1,index2=ncode.substr(4,1)*1,foundcell="",i,newi,newj;
 if (curstep==step) addstep(false,"nishio",""+iidx+","+jidx+","+kidx);
 switch (viocode)
 {
  case 2:
   for (i=0;i<9;i++)
   {
    if (t_a[index1][index2][i]==1) 
	{
	 if (foundcell.length>0) foundcell+=";";
	 foundcell+=index1+","+index2+",-"+i;
	} 
   }
   if (curstep==step) addmsg('If cell '+dcell(iidx,jidx)+' is "'+ddig(kidx)+'", cell '+dcell(index1,index2)+' will have no digits as candidates.  Therefore, cell '+dcell(iidx,jidx)+' cannot be "'+ddig(kidx)+'".');
   break;
  case 3:
   for (i=0;i<9;i++)
   {
    if (t_a[index1][i][index2]==1) 
	{
	 if (foundcell.length>0) foundcell+=";";
	 foundcell+=index1+","+i+",-"+index2;
	} 
   }
   if (curstep==step) addmsg('If cell '+dcell(iidx,jidx)+' is "'+ddig(kidx)+'", digit "'+ddig(index2)+'" will not be in any cells of row '+drow(index1)+'.  Therefore, cell '+dcell(iidx,jidx)+' cannot be "'+ddig(kidx)+'".');
   break;
  case 4:
   for (i=0;i<9;i++)
   {
    if (t_a[i][index1][index2]==1) 
	{
	 if (foundcell.length>0) foundcell+=";";
	 foundcell+=i+","+index1+",-"+index2;
	} 
   }
   if (curstep==step) addmsg('If cell '+dcell(iidx,jidx)+' is "'+ddig(kidx)+'", digit "'+ddig(index2)+'" will not be in any cells of column '+dcol(index1)+'.  Therefore, cell '+dcell(iidx,jidx)+' cannot be "'+ddig(kidx)+'".');
   break;
  case 5:
   for (i=0;i<9;i++)
   {
    newi=Math.floor(index1/3)*3+Math.floor(i/3);
	newj=(index1%3)*3+i%3;
    if (t_a[newi][newj][index2]==1) 
	{
	 if (foundcell.length>0) foundcell+=";";
	 foundcell+=newi+","+newj+",-"+index2;
	} 
   }
   if (curstep==step) addmsg('If cell '+dcell(iidx,jidx)+' is "'+ddig(kidx)+'", digit "'+ddig(index2)+'" will not be in any cells of square '+dsqr(index1)+'.  Therefore, cell '+dcell(iidx,jidx)+' cannot be "'+ddig(kidx)+'".');
   break;
  case 6:
   for (i=0;i<9;i++)
   {
    if (t_a[index1][i][index2]==2) 
	{
	 if (foundcell.length>0) foundcell+=";";
	 foundcell+=index1+","+i+",+"+index2;
	} 
   }
   if (curstep==step) addmsg('If cell '+dcell(iidx,jidx)+' is "'+ddig(kidx)+'", digit "'+ddig(index2)+'" will be confirmed in more than one cell of row '+drow(index1)+'.  Therefore, cell '+dcell(iidx,jidx)+' cannot be "'+ddig(kidx)+'".');
   break;
  case 7:
   for (i=0;i<9;i++)
   {
    if (t_a[i][index1][index2]==2) 
	{
	 if (foundcell.length>0) foundcell+=";";
	 foundcell+=i+","+index1+",+"+index2;
	} 
   }
   if (curstep==step) addmsg('If cell '+dcell(iidx,jidx)+' is "'+ddig(kidx)+'", digit "'+ddig(index2)+'" will be confirmed in more than one cell of column '+dcol(index1)+'.  Therefore, cell '+dcell(iidx,jidx)+' cannot be "'+ddig(kidx)+'".');
   break;
  case 8:
   for (i=0;i<9;i++)
   {
    newi=Math.floor(index1/3)*3+Math.floor(i/3);
	newj=(index1%3)*3+i%3;
    if (t_a[newi][newj][index2]==2) 
	{
	 if (foundcell.length>0) foundcell+=";";
	 foundcell+=newi+","+newj+",+"+index2;
	} 
   }
   if (curstep==step) addmsg('If cell '+dcell(iidx,jidx)+' is "'+ddig(kidx)+'", digit "'+ddig(index2)+'" will be confirmed in more than one cell of square '+dsqr(index1)+'.  Therefore, cell '+dcell(iidx,jidx)+' cannot be "'+ddig(kidx)+'".');
   break;
 }
 if (curstep==step)
 {
  addmsgr('- Nishio');
  next2update();
 } 
 if (foundcell.length>0 && curstep==dispstep)
 {
  finalchain=buildpath(nischainval,foundcell);
  drawnispath(finalchain,foundcell,viocode,index1,index2);
 }
}

function drawnispath(chain,foundcell,viocode,pindex1,pindex2)
{
 var i,j,k,ii,iref,jref,kref,index,dumstep,dumpath,dummsg,exist,noaction;
 var nchainlbl=new Array("A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z");
 var npath=chain.split("/");
 var nchainstep=new Array(npath.length);
 var ncval=new Array(npath.length);
 var nocval=new Array(npath.length);
 var nhl=new Array(npath.length);
 var nsteplbl=new Array(npath.length);
 for (j=0;j<npath.length;j++)
 {
  ncval[j]="";
  nocval[j]="";
  nhl[j]="";
  nsteplbl[j]="";
  nchainstep[j]=npath[j].substr(0,npath[j].indexOf(":"))*1;
  npath[j]=npath[j].substr(npath[j].indexOf(":")+1);
  for (k=0;k<j;k++)
  {
   if (nchainstep[j]<nchainstep[k])
   {
	dumstep=nchainstep[j];
	dumpath=npath[j];
	for (index=j;index>k;index--)
	{
	 nchainstep[index]=nchainstep[index-1];
	 npath[index]=npath[index-1];
	}
	nchainstep[k]=dumstep;
	npath[k]=dumpath;
   }
  }
 }
 index=1;
 dumstep=index;
 for (j=1;j<npath.length;j++)
 {
  if (nchainstep[j]>dumstep)
  {
   dumstep=nchainstep[j];
   index++;
   nchainstep[j]=index;
  }
  else nchainstep[j]=nchainstep[j-1];
 }
  switch (viocode)
  {
   case 2:
    setclr_t(pindex1*9+pindex2);
	break;
   case 3:
   case 6:
    showrc_t(pindex1*9,1);
	break;
   case 4:
   case 7:
    showrc_t(pindex1,2);
	break;
   case 5:
   case 8:
    showrc_t(Math.floor(pindex1/3)*27+(pindex1%3)*3,3);
	break;  
  }

 var is2nd=false;
 for (j=0;j<npath.length;j++)
 {
  exist=false;
  noaction=false;
  kref=npath[j].substr(5,1)*1;
  dummsg="";
  if (curstep==step)
  {
   if (j==0 || (j>0 && nchainstep[j]!=nchainstep[j-1]))
   {
    if (j<(npath.length/2)) c1step('Step '+nchainlbl[nchainstep[j]-1]+':');
    else 
    {
     c2step('Step '+nchainlbl[nchainstep[j]-1]+':');
	 is2nd=true;
    }
   }
   if (j==0) c1stepr('<span class="boldfont">Suppose '+dcell(npath[j].substr(0,1)*1,npath[j].substr(2,1)*1)+' is '+ddig(kref)+'</span>');
   else 
   {
    if (npath[j].indexOf("-")>=0) dummsg+=dcell(npath[j].substr(0,1)*1,npath[j].substr(2,1)*1)+' cannot be '+ddig(kref);
    else if (npath[j].indexOf("+")>=0) dummsg+=dcell(npath[j].substr(0,1)*1,npath[j].substr(2,1)*1)+' must be '+ddig(kref);
	if (foundcell.indexOf(npath[j])>=0) dummsg='<span class="boldfont">'+dummsg+'</span>';
    if (!is2nd) c1stepr(dummsg);
    else c2stepr(dummsg);
   }	
  }   
  for (k=j-1;k>=0;k--)
  {
   if (npath[j].substr(0,4)==npath[k].substr(0,4))
   {
    exist=true;
	ncval[j]=ncval[k];
	nocval[j]=nocval[k];
	nhl[j]=nhl[k];
	if (nchainstep[j]!=nchainstep[k]) nsteplbl[j]=nsteplbl[k]+nchainlbl[nchainstep[j]-1];
	else nsteplbl[j]=nsteplbl[k];
	break;
   }
  }
  if (!exist)
  {
   for (k=0;k<t_itemp[npath[j].substr(0,1)*1][npath[j].substr(2,1)*1].length;k++)
   {
    ncval[j]+=t_itemp[npath[j].substr(0,1)*1][npath[j].substr(2,1)*1].substr(k,1)*1-1;
    nocval[j]+="-";
	nhl[j]+="-";
	nsteplbl[j]=nchainlbl[nchainstep[j]-1];
   }
  }
  if (npath[j].indexOf("-")>0) nocval[j]=nocval[j].substr(0,ncval[j].indexOf(""+kref))+"r"+nocval[j].substr(ncval[j].indexOf(""+kref)+1);
  nhl[j]=nhl[j].substr(0,ncval[j].indexOf(""+kref))+(nsteplbl[j].length-1)+nhl[j].substr(ncval[j].indexOf(""+kref)+1);
 }
 for (j=npath.length-1;j>=0;j--)
 {
  iref=npath[j].substr(0,1)*1;
  jref=npath[j].substr(2,1)*1;
  index=iref*9+jref;
  if (document.getElementById('oc'+index).innerHTML=="")
  {
   dumpath="";
   dumstep="";
   for (k=0;k<ncval[j].length;k++)
   {
	if (k==4) 
	{
	 dumpath+=" ";
	 dumstep+=" ";
	} 
	if (nhl[j].substr(k,1)!="-") dumpath+="<span class='chainbg"+nhl[j].substr(k,1)+"'>";
	dumpath+=(ncval[j].substr(k,1)*1+1);
	if (nhl[j].substr(k,1)!="-") dumpath+="</span>";
	if (nocval[j].substr(k,1)=="r") dumstep+="\\";
	else dumstep+="&nbsp;";
   }
   dumstep+="<br>";
   ii=0;
   for (ii=0;ii<nsteplbl[j].length;ii++)
   {
	dumstep+="<span class='chaintxt"+ii+"'>"+nsteplbl[j].substr(ii,1)+"</span>";
   }
   document.getElementById('c'+index).innerHTML=dumpath;
   document.getElementById('oc'+index).innerHTML=dumstep;
   if (dumstep.indexOf(">A<")>=0) document.getElementById('cell'+index).style.backgroundColor=red;
   }
  }
}

function guess(a,poscell,krowcell,kcolcell,ksqrcell)
{
 var i,j,k,isqr,idx,nidx,ii,jj,mini,minj,minpos=9,change=false;
 if (curstep<step)
 {
  var cellinfo=solvedsqn[curstep].substr(solvedsqn[curstep].indexOf(":")+1);	
  var cf1=cellinfo.substr(0,1)*1, cf2=cellinfo.substr(2,1)*1, cf3=cellinfo.substr(4,1)*1;
 }
 if (curstep<dispstep)
 {
  if (curguess!="") curguess+=";"+(cf1*9+cf2)+",";
  else curguess+=(cf1*9+cf2)+",";
  for (k=0;k<9;k++)
  {
   if (a[cf1][cf2][k]==1) curguess+=(k+1);
  }
  npgot1cell(cf1,cf2,cf3);
  if (possmode) needconfirm=1;
 }
 else
 {
  if (curstep<step)
  {
   mini=cf1;
   minj=cf2;
  }
  else
  {  
   for (i=0;i<9;i++)
   {
    for (j=0;j<9;j++)
    {
     if (poscell[i][j]>1 && poscell[i][j]<minpos)
     {
      mini=i;
	  minj=j;
	  minpos=poscell[i][j];
     }
	} 
   }
  }
  if (curstep<step || minpos<9)
  {
   isqr=rc2sqr(mini,minj);
   idx=mini*9+minj;
   for (k=0;k<9;k++)
   {
    if (curstep<step) k=cf3;
    if (a[mini][minj][k]==1)
    {
     change=true;
     if (curstep==dispstep)
     {
	  hlnumber(mini*9+minj,""+(k+1));
      for (i=0;i<9;i++)
	  {
       nidx=mini*9+i;
       if (nidx!=idx && a[mini][i][k]==1) rmval(nidx,""+(k+1),1);
       nidx=i*9+minj;
       if (i!=mini && a[i][minj][k]==1) rmval(nidx,""+(k+1),1);
	   ii=Math.floor(isqr/3)*3+Math.floor(i/3);
       jj=(isqr%3)*3+i%3;
	   nidx=ii*9+jj;
	   if (ii!=mini && jj!=minj && a[ii][jj][k]==1) rmval(nidx,""+(k+1),1);
      }
	  hlcell(mini*9+minj,hyellow);
     }	
     needconfirm=1;
     if (curstep==step)
     {
      guessinfo[guessmode]=""+step+":"+mini+","+minj+","+k;
      guessmode++;
      addstep(false,"guess",""+mini+","+minj+","+k);
	  addmsg('This puzzle is too difficult for all techniques and a guess is necessary.');
	  addmsg('Cell '+dcell(mini,minj)+' has '+poscell[mini][minj]+' possibilities.  Our guess is '+(k+1)+'.');
	  addmsgr('- Guess');
      addmsg('All other '+ddig(k)+'(s) as possibilities in the same row ('+drow(mini)+'), in the same column ('+ dcol(minj)+') or in the same square ('+dsqr(isqr)+') will be removed.');
	  next2update();
	  if (document.getElementById('sgrid'+isqr).className!="subgrido") document.getElementById('sgrid'+isqr).className="subgrido";
     }
     if (curguess!="") curguess+=";"+(mini*9+minj)+",";
     else curguess+=(mini*9+minj)+",";
     for (i=0;i<9;i++)
     {
      if (a[mini][minj][i]==1) curguess+=(i+1);
     }
     tgotacell(a,mini,minj,k,poscell,krowcell,kcolcell,ksqrcell);
     t_itemp[mini][minj]=k+1;
     rowfill[mini]++;
     colfill[minj]++;
     sqrfill[isqr]++;
     kfill[k]++;
     break;
    }
	if (curstep<step) break;
   }	
  }
 } 
 return change;
}

function ghl()
{
 var gcell=curguess.split(";");
 for (var i=0;i<gcell.length;i++)
 {
  var idx=gcell[i].substr(0,gcell[i].indexOf(","));
  if ((i+1)!=gcell.length) document.getElementById('cell'+idx).style.backgroundColor=pgsclr;
  else document.getElementById('cell'+idx).style.backgroundColor=cgsclr;
  document.getElementById('oc'+idx).className=osmcls;
  var dumval=gcell[i].substr(gcell[i].indexOf(",")+1);
  document.getElementById('oc'+idx).innerHTML=dumval;
 }
}

function chkerr(a,poscell,krowcell,kcolcell,ksqrcell)
{
 if (curstep<step)
 {
  var cellinfo=solvedsqn[curstep].substr(solvedsqn[curstep].indexOf(":")+1);	
  var cf1=cellinfo.substr(0,1)*1, cf2=cellinfo.substr(2,1)*1, cf3=cellinfo.substr(4,1)*1, cf4=cellinfo.substr(6)*1;
 }
 if (curstep<dispstep)
 {
  if (cellinfo.indexOf("*")<0)
  {
   clrgrid();
   basic();
   var dumstep=curstep;
   var strtpt=fstrtpt(0,cf4);
   for (i=0;i<cf4;i++)
   {
    if (solvedsqn[i].substr(0,solvedsqn[i].indexOf(":"))=="guess")
    {
     var gcnt=1;
     for (var j=i+1;j<cf4;j++)
     {
      if (solvedsqn[j].substr(0,solvedsqn[j].indexOf(":"))=="guess") gcnt++;
	  else if (solvedsqn[j].substr(0,solvedsqn[j].indexOf(":"))=="gfail")
	  {
	   gcnt--;
	   if (gcnt==0)
	   {
	    i=j;
	    solvedsqn[j]+="*";
	    break;
	   }
	  } 
     }
    }
    replay(i);
   }
   curstep=dumstep;
  }
  else solvedsqn[curstep]=solvedsqn[curstep].replace("*","");
  rmapos(a,cf1,cf2,cf3,poscell,krowcell,kcolcell,ksqrcell);
  needconfirm=1;
 }
 else
 {
  var i,j,ncode=nsolvedorerr(a,poscell,krowcell,kcolcell,ksqrcell);
  var change=false;
  if (ncode.length>1)
  {
   var viocode=ncode.substr(0,1)*1,index1=ncode.substr(2,1)*1,index2=ncode.substr(4,1)*1;
   if (curstep==dispstep)
   {
    switch (viocode)
    {
     case 2:
      setclr_t(index1*9+index2);
	  break;
     case 3:
     case 6:
      showrc_t(index1*9,1);
	  break;
     case 4:
     case 7:
      showrc_t(index1,2);
	  break;
     case 5:
     case 8:
      showrc_t(Math.floor(index1/3)*27+(index1%3)*3,3);
	  break;  
    }   
   }
   if (curstep==step)
   {
    var gstep=guessinfo[guessmode-1].substr(0,guessinfo[guessmode-1].indexOf(":"))*1;
    var gi=new Array(guessmode), gj=new Array(guessmode), gk=new Array(guessmode);
    var prevass="";
    for (i=0;i<guessmode;i++)
    {
     gi[i]=guessinfo[i].substr(guessinfo[i].indexOf(":")+1,1)*1;
     gj[i]=guessinfo[i].substr(guessinfo[i].indexOf(":")+3,1)*1;
     gk[i]=guessinfo[i].substr(guessinfo[i].indexOf(":")+5,1)*1;
     if (i<(guessmode-1))
     {
      prevass+="("+(i+1)+") Cell "+dcell(gi[i],gj[i])+" is "+ddig(gk[i])+',';
     }
    } 
    var curass='"Cell '+dcell(gi[guessmode-1],gj[guessmode-1])+' is '+ddig(gk[guessmode-1])+'"';
    var gmsg1="",gmsg2="";
    if (guessmode>2) 
    {
     gmsg1='Under previous guesses '+prevass+' and the current guess '+curass+', ';
     gmsg2='if the previous guesses are correct, ';
    } 
    else if (guessmode>1) 
    {
     gmsg1='Under the previous guess '+prevass+' and the current guess '+curass+', ';
     gmsg2='if the previous guess is correct, ';
    } 
    else if (guessmode==1) gmsg1='Under the current guess '+curass+', ';
    gmsg2+='the current guess must be incorrect.  Go back to step '+(gstep+1)+' and remove '+ddig(gk[guessmode-1])+' from cell '+dcell(gi[guessmode-1],gj[guessmode-1])+'.';
  
    addstep(false,"gfail",""+gi[guessmode-1]+","+gj[guessmode-1]+","+gk[guessmode-1]+","+gstep);
    switch (viocode)
    {
     case 2:
	  addmsg(gmsg1+'cell '+dcell(index1,index2)+' does not have any candidates.  Therefore, '+gmsg2);
	  break;
     case 3:
 	  addmsg(gmsg1+'row '+drow(index1)+' does not have digit "'+ddig(index2)+'" in any cells as a candidate.  Therefore, '+gmsg2);
	  break;
     case 4:
 	  addmsg(gmsg1+'column '+dcol(index1)+' does not have digit "'+ddig(index2)+'" in any cells as a candidate.  Therefore, '+gmsg2);
	  break;
     case 5:
 	  addmsg(gmsg1+'square '+dsqr(index1)+' does not have digit "'+ddig(index2)+'" in any cells as a candidate.  Therefore, '+gmsg2);
	  break;  
     case 6:
  	  addmsg(gmsg1+'digit "'+ddig(index2)+'" was confirmed in more than 1 cell in row '+drow(index1)+'.  Therefore, '+gmsg2);
	  break;
     case 7:
  	  addmsg(gmsg1+'digit "'+ddig(index2)+'" was confirmed in more than 1 cell in column '+dcol(index1)+'.  Therefore, '+gmsg2);
	  break;
     case 8:
  	  addmsg(gmsg1+'digit "'+ddig(index2)+'" was confirmed in more than 1 cell in square '+dsqr(index1)+'.  Therefore, '+gmsg2);
	  break;  
    }
    addmsgr('- Guess Failed');
	next2update();
    guessmode--;
   }
   needconfirm=2;
   change=true;
  } 
  return change;
 } 
}

function gconf(a,poscell,krowcell,kcolcell,ksqrcell)
{
 var change=false;
 if (curstep<step) change=true;
 else change=qsolved();
 if (change)
 {
  if (curstep==dispstep)
  { 
   var gcell=curguess.split(";");
   for (var i=0;i<gcell.length;i++)
   {
    document.getElementById('cell'+gcell[i].substr(0,gcell[i].indexOf(","))).style.backgroundColor=green;
   }
   needconfirm=1;
  }
  if (curstep==step)
  {  
    var i,dums="",dumt="the guess above";
    addstep(false,"gconf","");
    if (guessmode>1) 
    {
     dums="es";
	 dumt="all these guesses above";
    }	
    addmsg("Under the following guess"+dums+":");
    var dummsg="",gi,gj,gk;
    for (i=0;i<guessmode;i++)
    {
     gi=guessinfo[i].substr(guessinfo[i].indexOf(":")+1,1)*1;
	 gj=guessinfo[i].substr(guessinfo[i].indexOf(":")+3,1)*1;
	 gk=guessinfo[i].substr(guessinfo[i].indexOf(":")+5,1)*1;
     dummsg="("+(i+1)+") Cell "+dcell(gi,gj)+" is "+ddig(gk)+',';
	 addmsg(dummsg);
    }
    addmsg("the 9x9 grid was completely filled without any contradictions.  Since this puzzle has only one solution, "+dumt+" must be correct.");
    addmsgr("- Guess Confirmed");  
    next2update();	
    guessmode=0;
  } 	
  curguess="";
 }
 return change;
}
 
function fstrtpt(istrt,iend)
{
 var i,gcnt=0,fstrt=istrt,lgcnt=0;
 for (i=istrt;i<iend;i++)
 {
  if (solvedsqn[i].substr(0,solvedsqn[i].indexOf(":"))=="guess") gcnt++;
  else if (solvedsqn[i].substr(0,solvedsqn[i].indexOf(":"))=="gfail") 
  {
   gcnt--;
   if (gcnt<lgcnt)
   {
    lgcnt=gcnt;
	fstrt=i;
   }
  } 
 }
 return fstrt;
}

function nextstep()
{
 if (nextready)
 {
  nextready=false;
  document.getElementById('nextstep').innerHTML="Wait...";
  resetbtn('nextstep');
  setTimeout("nxtstp()",50);
 }
}
function nxtstp()
{
 if (!pzsolved || dispstep!=step)
 {
  var change=false;
  if (!pzsolved && dispstep==step)
  {
   combine2();
   if (needconfirm) 
   {
    if (needconfirm==2)
	{
     clrgrid();
     basic();
	 var gstep=guessinfo[guessmode].substr(0,guessinfo[guessmode].indexOf(":"))*1;
	 var gi=guessinfo[guessmode].substr(guessinfo[guessmode].indexOf(":")+1,1)*1;
	 var gj=guessinfo[guessmode].substr(guessinfo[guessmode].indexOf(":")+3,1)*1;
	 var gk=guessinfo[guessmode].substr(guessinfo[guessmode].indexOf(":")+5,1)*1;
	 var strtpt=fstrtpt(0,gstep);
     for (i=strtpt;i<gstep;i++)
     {
      if (solvedsqn[i].substr(0,solvedsqn[i].indexOf(":"))=="guess")
      {
       var gcnt=1;
       for (var j=i+1;j<cf4;j++)
       {
        if (solvedsqn[j].substr(0,solvedsqn[j].indexOf(":"))=="guess") gcnt++;
	    else if (solvedsqn[j].substr(0,solvedsqn[j].indexOf(":"))=="gfail")
	    {
	     gcnt--;
	     if (gcnt==0)
	     {
	      i=j;
	      solvedsqn[j]+="*";
	      break;
	     }
	    } 
       }
      }
      replay(i);
     }
     rmapos(t_a,gi,gj,gk,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
     curstep=dispstep;
	} 
    confirm();
	addmsg(upmsg);
    next2cont();
    change=true;
   }
   else
   {
    if (possmode || xtrastep)
    {
     if (xtrastep)
	 {
	  needfill(3);
	  change=true;
	 }
	 if (guessmode && !change) change=chkerr(t_a,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
     if (!change) change=ochkns();
     if (!change) change=ochkhs();
	 if (!change) change=ndbl(t_a,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
     if (!change) change=ntpl(t_a,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
     if (!change) change=odumlockcd(t_a,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
    }
    else
    {  
     change=ochkhs();
     if (!change) change=ochkns();
     if (!change) change=odumlockcd(t_a,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
     if (!change){needfill(1);change=true;}
     if (!change) change=ndbl(t_a,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
     if (!change) change=ntpl(t_a,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
    } 
    if (!change) change=hdbl(t_a,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
    if (!change) change=nquad(t_a,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
    if (!change) change=htpl(t_a,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
    if (!change) change=hquad(t_a,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
    if (!change) change=xwing(t_a,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
    if (!change) change=swfish(t_a,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
    if (!change) change=xywing(t_a,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
    if (!change) change=xyzwing(t_a,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
    if (!change) change=colorforce(t_a,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
    if (!change) change=nishio(t_a,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
	if (!change) change=guess(t_a,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
	if (!change) change=gconf(t_a,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
   }
   if (!change && possmode) 
   {
    pzvalid=false;
	pzsolved=true;
    combine2();
    addstep(true,"Invalid Puzzle","");
    document.getElementById('tmpmsg').innerHTML="";
   }	
   else if (!needconfirm && !guessmode)
   {
    if (qsolved()) 
    {
	 if (possmode)
	 {
	  pzsolved=true;
      combine2();
      addstep(true,"finish","");
      document.getElementById('tmpmsg').innerHTML="";
	 }
     else 
     {
      needconfirm=1;
      possmode=true;
     }	  
    }
   }	
  } 
  else if (dispstep<step)
  {
   if (pzsolved && possmode && (dispstep+1)==step) 
   {
    needconfirm=0;
   } 
   if (needconfirm /*&& (dispstep+1)!=step*/) 
   {
    if (needconfirm==2)
	{
     clrgrid();
     basic();
     var cellinfo=solvedsqn[curstep-1].substr(solvedsqn[curstep-1].indexOf(":")+1);	
     var cf1=cellinfo.substr(0,1)*1, cf2=cellinfo.substr(2,1)*1, cf3=cellinfo.substr(4,1)*1, cf4=cellinfo.substr(6)*1;
	 var dumstep=curstep;
     var strtpt=fstrtpt(0,cf4)
     for (i=strtpt;i<cf4;i++)
     {
      if (solvedsqn[i].substr(0,solvedsqn[i].indexOf(":"))=="guess")
      {
       var gcnt=1;
       for (var j=i+1;j<cf4;j++)
       {
        if (solvedsqn[j].substr(0,solvedsqn[j].indexOf(":"))=="guess") gcnt++;
	    else if (solvedsqn[j].substr(0,solvedsqn[j].indexOf(":"))=="gfail")
	    {
	     gcnt--;
	     if (gcnt==0)
	     {
	      i=j;
	      solvedsqn[j]+="*";
	      break;
	     }
	    } 
       }
      }
      replay(i);
     }
     rmapos(t_a,cf1,cf2,cf3,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
     curstep=dumstep;
	} 
    confirm();
    var msg1=document.getElementById('msgbrd1').innerHTML;
    if (msg1.indexOf("Step "+(dispstep+1)+":")>=0)
    {
     var i=msg1.indexOf("<h5>Step "+(dispstep+1)+":");
	 var dum1=msg1.substr(0,i);
	 var dum2=dum1.substr(0,dum1.lastIndexOf("</div>"))+upmsg+dum1.substr(dum1.lastIndexOf("</div>"));
     document.getElementById('msgbrd1').innerHTML=dum2+msg1.substr(i);
    }
    else if (msg1.indexOf("Step "+dispstep+":")>=0)
    {
	 var dum1=msg1.substr(0,msg1.lastIndexOf("</div>"))+upmsg+msg1.substr(msg1.lastIndexOf("</div>"));
     document.getElementById('msgbrd1').innerHTML+=dum1;
    }
   } 
   else 
   { 
    go2this(dispstep);
   } 
   change=true; 
  }
  scrolldw(dispstep);
  if (possmode && !xtrastep && !needconfirm && solvedsqn[dispstep-1].substr(0,7)!="possall" && !(pzsolved && dispstep==step))
  {
   bstepno=dispstep-1;
   if (document.getElementById('back1step').innerHTML!="Undo last update") document.getElementById('back1step').innerHTML="Undo last update";
  }
  else 
  {
   bstepno=dispstep-2;
   if (document.getElementById('back1step').innerHTML!="Back one step") document.getElementById('back1step').innerHTML="Back one step";
  }
  if (dispstep==1)
  {
   document.getElementById("restart").style.color="";
   document.getElementById("back1step").style.color="";
  }
  resetnext();
  return change;
 }
 else resetnext();
}

function resetnext()
{
 document.getElementById('nextstep').innerHTML="Next";
 document.getElementById('nextstep').style.color="";
 nextready=true;
}

function replay(thisstep)
{
 if (thisstep<=step && thisstep>=0)
 {
  curstep=thisstep;
  var method=solvedsqn[thisstep].substr(0,solvedsqn[thisstep].indexOf(":"));
  switch (method)
  {
   case "hss":
     clrcount=0;
     hssqr(0,t_a,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell,false);
	 break;
   case "hsr":
     clrcount=0;
     hsrow(0,t_a,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell,false);
	 break;
   case "hsc":
     clrcount=0;
     hscol(0,t_a,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell,false);
	 break;
   case "ns":
     chkns(t_a,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell,false);
	 break;
   case "poss":
     fillpos(1);
	 break;
   case "possall":
     fillpos(80);
	 break;
   case "lcsr":
   case "lcsc":
   case "lcrs":
   case "lccs":
     odumlockcd(t_a,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
	 break;
   case "ndblr":
   case "ndblc":
   case "ndbls":
     ndbl(t_a,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
	 break;
   case "ntplr":
   case "ntplc":
   case "ntpls":
     ntpl(t_a,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
     break;
   case "nquadr":
   case "nquadc":
   case "nquads":
     nquad(t_a,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
     break;
   case "hdblr":
   case "hdblc":
   case "hdbls":
     hdbl(t_a,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
	 break;
   case "htplr":
   case "htplc":
   case "htpls":
     htpl(t_a,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
	 break;
   case "hquadr":
   case "hquadc":
   case "hquads":
     hquad(t_a,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
	 break;
   case "xwr":
   case "xwc":
     xwing(t_a,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
	 break;
   case "sfr":
   case "sfc":
     swfish(t_a,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
	 break;
   case "xywt":
   case "xywr":
   case "xywc":
     xywing(t_a,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
	 break;
   case "xyzwr":
   case "xyzwc":
     xyzwing(t_a,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
	 break;
   case "clr":
   case "frc":
     if (curstep<step)
     {
      var cellinfo=solvedsqn[curstep].substr(solvedsqn[curstep].indexOf(":")+1);
	  if (curstep==dispstep)
	  {
       var dumipick=new Array(cellinfo.substr(0,1)*1,cellinfo.substr(6,1)*1);
       var dumjpick=new Array(cellinfo.substr(2,1)*1,cellinfo.substr(8,1)*1);
       var dumkpick=new Array(cellinfo.substr(4,1)*1,cellinfo.substr(10,1)*1);
	   forcematch(t_a,dumipick,dumjpick,dumkpick,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell,20,0);
	  } 
	  else
	  {
	   var matchcell=cellinfo.substr(cellinfo.indexOf(">")+1).split(";"), iref, jref, kref;
       for (var i=0;i<matchcell.length;i++)
       {
        iref=matchcell[i].substr(0,1)*1;
        jref=matchcell[i].substr(2,1)*1;
        kref=matchcell[i].substr(5,1)*1;
        if (matchcell[i].indexOf("-")>=0) rmapos(t_a,iref,jref,kref,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
		else if (matchcell[i].indexOf("+")>=0)
        {
         for (var k=0;k<9;k++)
	     {
	      if (t_a[iref][jref][k]==1 && k!=kref) rmapos(t_a,iref,jref,k,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
	     }
        }
       }
	  }
	  needconfirm=1;
	 } 
	 break;
   case "nishio":
     if (curstep<step)
     {
      var cellinfo=solvedsqn[curstep].substr(solvedsqn[curstep].indexOf(":")+1);
      var cf1=cellinfo.substr(0,1)*1, cf2=cellinfo.substr(2,1)*1, cf3=cellinfo.substr(4,1)*1;
      if (curstep==dispstep) chknishio(t_a,cf1,cf2,cf3,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell,20);
	  else rmapos(t_a,cf1,cf2,cf3,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
	  needconfirm=1;
	 } 
	 break;
   case "guess":
     guess(t_a,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
	 break;   
   case "gfail":
     chkerr(t_a,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
	 break;   
   case "gconf":
     gconf(t_a,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell);
	 break;   
   case "finish":
     confirm();
     break;	 
  }
 }
}

function back2this(stepno)
{
 if (stepno>=curstep && needconfirm==2) nextstep();
 go2this(stepno);
 scrollup(dispstep);
}

function go2this(stepno)
{
 if (dispstep==step) combine2();
 if (document.getElementById('back1step').innerHTML!="Back one step") document.getElementById('back1step').innerHTML="Back one step";
 var startpt;
 var omsgbrd1=document.getElementById('msgbrd1');
 var dummsg=omsgbrd1.innerHTML;
 var pos=dummsg.indexOf(fhstr)
 if (pzsolved && possmode && pos>=0 && dummsg.substr(dummsg.indexOf("Finish")).indexOf("</a>")<0) 
 {
  dummsg=dummsg.substr(0,pos+fhstr.length)+'<a class="gostep" href="javascript:back2this('+(step-1)+')">(back to this step)</a>'+dummsg.substr(pos+fhstr.length);
 } 
 dummsg=dummsg.replace(upmsg,"");
 omsgbrd1.innerHTML=dummsg;
 if (dispstep<=stepno) startpt=dispstep;
 else
 {
  startpt=0;
  clrgrid();
  basic();
 } 
 resetrcclr_t();
 dispstep=stepno;
 if (guessinfo.length>0) startpt=fstrtpt(startpt,dispstep);
 for (var i=startpt;i<=dispstep;i++)
 {
  if (guessinfo.length>0 && solvedsqn[i].substr(0,solvedsqn[i].indexOf(":"))=="guess")
  {
   var gcnt=1;
   for (var j=i+1;j<dispstep;j++)
   {
    if (solvedsqn[j].substr(0,solvedsqn[j].indexOf(":"))=="guess") gcnt++;
	else if (solvedsqn[j].substr(0,solvedsqn[j].indexOf(":"))=="gfail")
	{
	 gcnt--;
	 if (gcnt==0)
	 {
	  i=j;
	  solvedsqn[j]+="*";
	  break;
	 }
	} 
   }
  }
  if (i==dispstep && needconfirm) confirm();
  replay(i);
 }
 dispstep++;
 curstep=dispstep;
 currentdp(dispstep);
 if (dispstep==step && !pzsolved)
 {
  if (needconfirm) next2update();
  else if (xtrastep)
  {
   addtmpmsg('Press "Next" button to fill in all empty cells, or press the button below to fill one empty cell at a time.');
   addtmpmsg('<div id="a1cell" class="igen5" onclick="needfill(2);">Fill next empty cell</div>');
  }
  else next2cont();
 }
 bstepno=Math.max(dispstep-2,-1);
 if (dispstep<=0)
 {
  document.getElementById("restart").style.color="#969696";
  document.getElementById("back1step").style.color="#969696";
 }
 else
 {
  document.getElementById("restart").style.color="";
  document.getElementById("back1step").style.color="";
 }
}

function currentdp(stepno)
{
 var msg1=document.getElementById('msgbrd1').innerHTML;
 var msg2=document.getElementById('msgbrd2').innerHTML;
 if (msg1.indexOf("currently demonstrated")>=0) msg1=msg1.replace("currently demonstrated","back to this step");
 else if (msg2.indexOf("currently demonstrated")>=0) msg2=msg2.replace("currently demonstrated","back to this step");
 if  (msg1.indexOf("Step "+stepno+":")>=0)
 {
  var i=msg1.indexOf("Step "+stepno+":");
  var leftmsg=msg1.substr(0,i), midmsg=msg1.substr(i,100), rightmsg=msg1.substr(i+100);
  midmsg=midmsg.replace("back to this step","currently demonstrated");
  msg1=leftmsg+midmsg+rightmsg;
 }
 else if (msg2.indexOf("Step "+stepno+":")>=0)
 {
  var i=msg2.indexOf("Step "+stepno+":");
  var leftmsg=msg2.substr(0,i), midmsg=msg2.substr(i,100), rightmsg=msg2.substr(i+100);
  midmsg=midmsg.replace("back to this step","currently demonstrated");
  msg2=leftmsg+midmsg+rightmsg;
 }
 else if (pzsolved && stepno==step) 
 {
  if (msg1.indexOf("Finished")>=0)
  {
   var i=msg1.indexOf("Finished");
   var leftmsg=msg1.substr(0,i), midmsg=msg1.substr(i,100), rightmsg=msg1.substr(i+100);
   midmsg=midmsg.replace("back to this step","currently demonstrated");
   msg1=leftmsg+midmsg+rightmsg;
  }
  else if (msg2.indexOf("Finished")>=0)
  {
   var i=msg2.indexOf("Finished");
   var leftmsg=msg2.substr(0,i), midmsg=msg2.substr(i,100), rightmsg=msg2.substr(i+100);
   midmsg=midmsg.replace("back to this step","currently demonstrated");
   msg2=leftmsg+midmsg+rightmsg;
  }
 } 
 document.getElementById('msgbrd1').innerHTML=msg1;
 document.getElementById('msgbrd2').innerHTML=msg2;
}

function finalstep()
{
 var change;
 var i=0;
 do {change=nextstep();i++;} while (change && i<100);
}

function solveall()
{
 for (var i=1;i<=1000;i++)
 {
  for (var j=0;j<81;j++)
  {
   if (origval[i][j]!="0") document.getElementById('c'+j).innerHTML=origval[i][j];
   else document.getElementById('c'+j).innerHTML="";
  }
  basic();
  finalstep();
  if (nsolvedorerr(t_a,t_poscell,t_krowcell,t_kcolcell,t_ksqrcell)!="1") document.getElementById('wmsg').innerHTML+="pno="+i+" failed";
 } 
}
h = ' -->';